This file is a merged representation of a subset of the codebase, containing files not matching ignore patterns, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of a subset of the repository's contents that is considered the most important context.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching these patterns are excluded: public/**, pnpm-lock.yaml, package-lock.json, yarn.lock, **/*.svg, **/*.png, **/*.jpg, **/*.jpeg, **/*.gif, **/*.ico, **/*.webp, **/*.avif, **/*.mp4, **/*.mov, **/*.pdf, dist/**, .next/**, node_modules/**, **/*.xml, **/*.backup.*, **/*backup*, _backup_files/**, components/ui/**, supabase/**, pnpm-workspace.yaml, tsconfig.tsbuildinfo
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
app/
  (site)/
    blog/
      [slug]/
        page.tsx
      client-page.tsx
      page.tsx
    homepage/
      page.tsx
    layout.tsx
  actions/
    ai-models.ts
    assets.ts
    email-actions.ts
    knowledgebase.ts
    posts.ts
    settings.ts
    themes.ts
    versions.ts
  admin/
    assets/
      page.tsx
    knowledgebase/
      page.tsx
    posts/
      page.tsx
    settings/
      page.tsx
    theme-analyzer/
      page.tsx
    layout.tsx
    page.tsx
  api/
    analyze-theme/
      route.ts
    copilot/
      route.ts
    copilot-dnd/
      route.ts
    extract-pdf/
      route.ts
    upload/
      route.ts
  editor/
    layout.tsx
    page.tsx
  globals.css
  layout.tsx
  page.tsx
components/
  admin/
    download-html-button.tsx
    posts-table.tsx
    settings-form.tsx
  blog/
    blog-card.tsx
    blog-content-frame.tsx
    blog-header.tsx
    category-filter.tsx
    featured-post.tsx
    newsletter-form.tsx
  dnd-editor/
    block-palette.tsx
    block-renderers.tsx
    block-settings.tsx
    dnd-canvas.tsx
    dnd-copilot-pane.tsx
    dnd-editor.tsx
  editor/
    asset-loader.tsx
    asset-picker-modal.tsx
    block-manager.tsx
    blog-post-editor.tsx
    code-pane.tsx
    copilot-pane.tsx
    history-sheet.tsx
    image-cropper.tsx
    preview-pane.tsx
  app-sidebar.tsx
  dashboard-header.tsx
  lock-screen.tsx
hooks/
  use-mobile.ts
  use-toast.ts
lib/
  dnd-blocks/
    compiler.ts
    defaults.ts
    types.ts
  supabase/
    client.ts
    middleware.ts
    server.ts
  blog-data.tsx
  render-template.ts
  types.ts
  utils.ts
.gitignore
eslint.config.mjs
middleware.ts
next.config.ts
package.json
postcss.config.mjs
README.md
repomix.config.json
tsconfig.json
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="app/(site)/layout.tsx">
import type { Metadata } from 'next'

export const metadata: Metadata = {
    title: 'DreamPlay Pianos | Blog',
    description: 'Discover the world of luxury pianos through tutorials, artist stories, and product news from DreamPlay Pianos.',
}

export default function SiteLayout({
    children,
}: {
    children: React.ReactNode
}) {
    return <>{children}</>
}
</file>

<file path="app/actions/ai-models.ts">
"use server"

import Anthropic from "@anthropic-ai/sdk";

export async function getAnthropicModels() {
    if (!process.env.ANTHROPIC_API_KEY) return []

    try {
        const anthropic = new Anthropic({ apiKey: process.env.ANTHROPIC_API_KEY });
        const list = await anthropic.models.list();

        return list.data
            .map(m => m.id)
            .filter(id => id.includes("claude"))
            .sort((a, b) => b.localeCompare(a));
    } catch (e) {
        console.error("Failed to fetch Anthropic models:", e);
        return [];
    }
}
</file>

<file path="app/actions/email-actions.ts">
'use server';

interface SubscribePayload {
    email: string;
    tags?: string[];
    temp_session_id?: string;
}

interface SubscribeResponse {
    success: boolean;
    error?: string;
    id?: string;
}

export async function subscribeToNewsletter(payload: SubscribePayload): Promise<SubscribeResponse> {
    try {
        const response = await fetch("https://email.dreamplaypianos.com/api/webhooks/subscribe", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                ...payload,
                first_name: "",
            })
        });

        if (!response.ok) {
            // If the error is "email already exists", treat as success
            if (response.status === 400 || response.status === 422) {
                console.log("Subscriber likely already exists, proceeding anyway.");
                return { success: true };
            }

            let errorMessage = "Failed to subscribe";
            try {
                const errorData = await response.json();
                if (errorData.error) errorMessage = errorData.error;
            } catch (e) {
                // failed to parse json
            }
            console.error('Subscription API error:', response.status, errorMessage);
            return { success: false, error: errorMessage };
        }

        const data = await response.json();
        return { success: true, id: data.id };

    } catch (error: any) {
        console.error('Server Action subscription error:', error);
        return { success: false, error: error.message || "Internal server error" };
    }
}
</file>

<file path="app/actions/settings.ts">
"use server"

import { createClient } from "@/lib/supabase/server"
import { revalidatePath } from "next/cache"

// ─── Types ──────────────────────────────────────────────

export type AudienceContext = "dreamplay" | "musicalbasics" | "crossover"
export type Brand = "dreamplay" | "musicalbasics"

export interface DefaultLinks {
    unsubscribe_url: string
    privacy_url: string
    contact_url: string
    about_url: string
    shipping_url: string
    main_cta_url: string
    main_activate_url: string
    crowdfunding_cta_url: string
    homepage_url: string
}

const DEFAULT_LINKS_EMPTY: DefaultLinks = {
    unsubscribe_url: "",
    privacy_url: "",
    contact_url: "",
    about_url: "",
    shipping_url: "",
    main_cta_url: "",
    main_activate_url: "",
    crowdfunding_cta_url: "",
    homepage_url: "",
}

// ─── Context (per audience) ─────────────────────────────

function contextKey(audience: AudienceContext): string {
    return `context_${audience}`
}

export async function getCompanyContext(audience: AudienceContext = "dreamplay"): Promise<string> {
    const supabase = await createClient()

    const { data } = await supabase
        .from("app_settings")
        .select("value")
        .eq("key", contextKey(audience))
        .single()

    if (data?.value) return data.value

    if (audience !== "crossover") {
        const { data: legacy } = await supabase
            .from("app_settings")
            .select("value")
            .eq("key", "company_context")
            .single()
        return legacy?.value || ""
    }

    return ""
}

export async function saveCompanyContext(audience: AudienceContext, newContext: string) {
    const supabase = await createClient()

    const { error } = await supabase
        .from("app_settings")
        .upsert({
            key: contextKey(audience),
            value: newContext,
            updated_at: new Date().toISOString()
        })

    if (error) throw new Error(error.message)

    revalidatePath("/settings")
    return { success: true }
}

// ─── Links (per brand) ──────────────────────────────────

function linksKey(brand: Brand): string {
    return `links_${brand}`
}

export async function getDefaultLinks(brand: Brand = "dreamplay"): Promise<DefaultLinks> {
    const supabase = await createClient()

    const { data } = await supabase
        .from("app_settings")
        .select("value")
        .eq("key", linksKey(brand))
        .single()

    if (data?.value) {
        try { return JSON.parse(data.value) } catch { }
    }

    const { data: legacy } = await supabase
        .from("app_settings")
        .select("value")
        .eq("key", "default_links")
        .single()

    if (legacy?.value) {
        try { return JSON.parse(legacy.value) } catch { }
    }

    return DEFAULT_LINKS_EMPTY
}

export async function saveDefaultLinks(brand: Brand, links: DefaultLinks) {
    const supabase = await createClient()

    const { error } = await supabase
        .from("app_settings")
        .upsert({
            key: linksKey(brand),
            value: JSON.stringify(links),
            updated_at: new Date().toISOString()
        })

    if (error) throw new Error(error.message)

    revalidatePath("/settings")
    return { success: true }
}

// ─── Custom Links ───────────────────────────────────────

export interface CustomLink {
    label: string
    url: string
}

function customLinksKey(brand: Brand): string {
    return `custom_links_${brand}`
}

export async function getCustomLinks(brand: Brand = "dreamplay"): Promise<CustomLink[]> {
    const supabase = await createClient()

    const { data } = await supabase
        .from("app_settings")
        .select("value")
        .eq("key", customLinksKey(brand))
        .single()

    if (data?.value) {
        try { return JSON.parse(data.value) } catch { }
    }

    return []
}

export async function saveCustomLinks(brand: Brand, links: CustomLink[]) {
    const supabase = await createClient()

    const { error } = await supabase
        .from("app_settings")
        .upsert({
            key: customLinksKey(brand),
            value: JSON.stringify(links),
            updated_at: new Date().toISOString()
        })

    if (error) throw new Error(error.message)

    revalidatePath("/settings")
    return { success: true }
}

// ─── Composite helper for Copilot routes ────────────────

export interface AudiencePayload {
    contexts: { audience: AudienceContext; text: string }[]
    links: { brand: Brand; links: DefaultLinks }[]
}

export async function getAllContextForAudience(
    audience: "dreamplay" | "musicalbasics" | "both"
): Promise<AudiencePayload> {
    if (audience === "both") {
        const [ctxMB, ctxDP, ctxCross, linksMB, linksDP] = await Promise.all([
            getCompanyContext("musicalbasics"),
            getCompanyContext("dreamplay"),
            getCompanyContext("crossover"),
            getDefaultLinks("musicalbasics"),
            getDefaultLinks("dreamplay"),
        ])
        return {
            contexts: [
                { audience: "crossover", text: ctxCross },
                { audience: "musicalbasics", text: ctxMB },
                { audience: "dreamplay", text: ctxDP },
            ],
            links: [
                { brand: "musicalbasics", links: linksMB },
                { brand: "dreamplay", links: linksDP },
            ],
        }
    }

    const [ctx, links] = await Promise.all([
        getCompanyContext(audience),
        getDefaultLinks(audience),
    ])

    return {
        contexts: [{ audience, text: ctx }],
        links: [{ brand: audience, links }],
    }
}

export async function formatContextForPrompt(
    payload: AudiencePayload,
    audience: "dreamplay" | "musicalbasics" | "both"
): Promise<{ contextBlock: string; linksBlock: string }> {
    if (audience === "both") {
        const crossover = payload.contexts.find(c => c.audience === "crossover")
        const mb = payload.contexts.find(c => c.audience === "musicalbasics")
        const dp = payload.contexts.find(c => c.audience === "dreamplay")
        const linksMB = payload.links.find(l => l.brand === "musicalbasics")
        const linksDP = payload.links.find(l => l.brand === "dreamplay")

        const formatLinks = (links?: DefaultLinks) => {
            if (!links) return ""
            const entries = Object.entries(links).filter(([_, v]) => v)
            return entries.length > 0 ? entries.map(([k, v]) => `- ${k}: ${v}`).join("\n") : "No links configured."
        }

        const contextBlock = `
### AUDIENCE RELATIONSHIP & HIERARCHY:
${crossover?.text || "This audience bridges both brands."}

### BRAND 1: MUSICALBASICS
${mb?.text || "No context configured."}

### BRAND 2: DREAMPLAY
${dp?.text || "No context configured."}`

        const linksBlock = `
### DEFAULT LINKS — MUSICALBASICS:
${formatLinks(linksMB?.links)}

### DEFAULT LINKS — DREAMPLAY:
${formatLinks(linksDP?.links)}`

        return { contextBlock, linksBlock }
    }

    const ctx = payload.contexts[0]
    const lnk = payload.links[0]

    const entries = Object.entries(lnk?.links || {}).filter(([_, v]) => v)
    const linksBlock = entries.length > 0
        ? `\n### DEFAULT LINKS:\nWhen creating NEW blog posts, use these URLs as defaults for CTAs and links. Use {{mustache}} variables for CTA links.\n${entries.map(([k, v]) => `- ${k}: ${v}`).join("\n")}\n`
        : ""

    return {
        contextBlock: ctx?.text || "",
        linksBlock,
    }
}
</file>

<file path="app/actions/themes.ts">
"use server"

import { createClient } from "@supabase/supabase-js"

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!
const supabaseServiceKey = process.env.SUPABASE_SERVICE_KEY!

function getSupabase() {
    return createClient(supabaseUrl, supabaseServiceKey)
}

export async function getThemes() {
    const supabase = getSupabase()
    const { data } = await supabase.from("blog_themes").select("*").order("created_at", { ascending: false })
    return data || []
}

export async function saveTheme(name: string, html_template: string) {
    const supabase = getSupabase()
    const { error } = await supabase.from("blog_themes").insert([{ name, html_template }])
    if (error) throw new Error(error.message)
    return { success: true }
}

export async function deleteTheme(id: string) {
    const supabase = getSupabase()
    await supabase.from("blog_themes").delete().eq("id", id)
}
</file>

<file path="app/actions/versions.ts">
"use server"

import { createClient } from "@/lib/supabase/server"

export async function saveVersion(postId: string, html: string, prompt: string) {
    const supabase = await createClient()
    await supabase.from('post_versions').insert({
        post_id: postId,
        html_content: html,
        prompt: prompt
    })
}

export async function getVersions(postId: string) {
    const supabase = await createClient()
    const { data } = await supabase
        .from('post_versions')
        .select('*')
        .eq('post_id', postId)
        .order('created_at', { ascending: false })
    return data
}
</file>

<file path="app/admin/posts/page.tsx">
import { getPosts } from '@/app/actions/posts'
import { PostsTable } from '@/components/admin/posts-table'

export default async function PostsPage() {
    const posts = await getPosts()

    return (
        <div className="space-y-6 p-6">
            {/* Header */}
            <div>
                <h1 className="text-3xl font-bold tracking-tight text-foreground">Posts</h1>
                <p className="text-muted-foreground">Manage all your blog posts in one place.</p>
            </div>

            {/* Posts Table */}
            <PostsTable initialPosts={posts} />
        </div>
    )
}
</file>

<file path="app/admin/settings/page.tsx">
import { SettingsForm } from '@/components/admin/settings-form'

export default function SettingsPage() {
    return (
        <div className="space-y-6 p-6">
            {/* Header */}
            <div>
                <h1 className="text-3xl font-bold tracking-tight text-foreground">Settings</h1>
                <p className="text-muted-foreground">Configure your blog settings, AI copilot context, and default links.</p>
            </div>

            {/* Settings Form */}
            <SettingsForm />
        </div>
    )
}
</file>

<file path="app/admin/theme-analyzer/page.tsx">
"use client"

import { useState, useEffect } from "react"
import { Code, Image as ImageIcon, FileText, Loader2, Save, Trash2, LayoutTemplate } from "lucide-react"
import { Button } from "@/components/ui/button"
import { Textarea } from "@/components/ui/textarea"
import { Input } from "@/components/ui/input"
import { getThemes, saveTheme, deleteTheme } from "@/app/actions/themes"
import { PreviewPane } from "@/components/editor/preview-pane"
import { CodePane } from "@/components/editor/code-pane"
import { cn } from "@/lib/utils"

export default function ThemeAnalyzerPage() {
    const [mode, setMode] = useState<"code" | "image" | "pdf">("code")
    const [code, setCode] = useState("")
    const [file, setFile] = useState<File | null>(null)
    const [loading, setLoading] = useState(false)
    const [generatedHtml, setGeneratedHtml] = useState("")
    const [themeName, setThemeName] = useState("")
    const [themes, setThemes] = useState<any[]>([])
    const [viewTab, setViewTab] = useState<"preview" | "code">("preview")

    useEffect(() => {
        getThemes().then(setThemes)
    }, [])

    const handleAnalyze = async () => {
        setLoading(true)
        try {
            const fd = new FormData()
            fd.append("mode", mode)
            if (mode === "code") fd.append("code", code)
            if (file) fd.append("file", file)

            const res = await fetch("/api/analyze-theme", { method: "POST", body: fd })
            const data = await res.json()
            if (data.html) setGeneratedHtml(data.html)
            else if (data.error) console.error("Theme analysis failed:", data.error)
        } catch (e) {
            console.error(e)
        }
        setLoading(false)
    }

    const handleSave = async () => {
        if (!themeName || !generatedHtml) return
        await saveTheme(themeName, generatedHtml)
        setThemeName("")
        getThemes().then(setThemes)
    }

    return (
        <div className="flex h-[calc(100vh-4rem)]">
            {/* LEFT: Input & Controls */}
            <div className="w-[360px] flex flex-col gap-5 p-6 border-r border-border overflow-y-auto shrink-0">
                <div>
                    <h1 className="text-2xl font-bold flex items-center gap-2">
                        <LayoutTemplate className="w-6 h-6 text-primary" />
                        Theme Analyzer
                    </h1>
                    <p className="text-sm text-muted-foreground mt-1">Extract aesthetics from inspiration to create reusable CSS skeletons.</p>
                </div>

                {/* Mode tabs */}
                <div className="flex bg-muted p-1 rounded-lg">
                    {([
                        { key: "code", label: "Code", icon: Code },
                        { key: "image", label: "Image", icon: ImageIcon },
                        { key: "pdf", label: "PDF", icon: FileText },
                    ] as const).map(({ key, label, icon: Icon }) => (
                        <button
                            key={key}
                            onClick={() => { setMode(key); setFile(null); }}
                            className={cn(
                                "flex-1 flex items-center justify-center gap-2 py-2 text-sm rounded-md transition-all",
                                mode === key ? "bg-background shadow-sm text-foreground" : "text-muted-foreground"
                            )}
                        >
                            <Icon className="w-4 h-4" /> {label}
                        </button>
                    ))}
                </div>

                {mode === "code" ? (
                    <Textarea
                        value={code}
                        onChange={e => setCode(e.target.value)}
                        placeholder="Paste reference HTML/CSS here..."
                        className="h-64 font-mono text-xs border-border"
                    />
                ) : (
                    <div className="border-2 border-dashed border-border rounded-lg p-10 text-center flex flex-col items-center justify-center bg-muted/20 gap-3">
                        <div className="text-muted-foreground text-sm">
                            {mode === "image" ? "Drop an image or click to browse" : "Drop a PDF or click to browse"}
                        </div>
                        <input
                            type="file"
                            accept={mode === "image" ? "image/*" : ".pdf,application/pdf"}
                            onChange={e => setFile(e.target.files?.[0] || null)}
                            className="text-sm"
                        />
                        {file && <p className="text-xs text-primary mt-2">{file.name}</p>}
                    </div>
                )}

                <Button
                    onClick={handleAnalyze}
                    disabled={loading || (mode === "code" && !code) || (mode !== "code" && !file)}
                    className="w-full"
                >
                    {loading ? <Loader2 className="w-4 h-4 mr-2 animate-spin" /> : <Code className="w-4 h-4 mr-2" />}
                    {loading ? "Analyzing Design..." : "Extract Theme"}
                </Button>

                {/* Saved Themes List */}
                <div className="pt-5 border-t border-border">
                    <h3 className="font-semibold text-sm mb-3">Saved Themes</h3>
                    <div className="space-y-2">
                        {themes.length === 0 && (
                            <p className="text-xs text-muted-foreground">No themes saved yet.</p>
                        )}
                        {themes.map(t => (
                            <div key={t.id} className="flex items-center justify-between p-3 rounded-lg border border-border bg-card text-sm">
                                <span className="font-medium truncate mr-2">{t.name}</span>
                                <div className="flex gap-3 items-center shrink-0">
                                    <button
                                        onClick={() => setGeneratedHtml(t.html_template)}
                                        className="text-primary hover:underline text-xs"
                                    >
                                        Load
                                    </button>
                                    <button
                                        onClick={async () => {
                                            if (confirm("Delete this theme?")) {
                                                await deleteTheme(t.id)
                                                getThemes().then(setThemes)
                                            }
                                        }}
                                        className="text-red-500 hover:text-red-600"
                                    >
                                        <Trash2 className="w-3.5 h-3.5" />
                                    </button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            </div>

            {/* RIGHT: Output & Preview */}
            <div className="flex-1 flex flex-col bg-card overflow-hidden">
                <div className="p-3 border-b border-border bg-muted/20 flex items-center justify-between shrink-0">
                    <div className="flex bg-muted p-1 rounded-lg">
                        <button
                            onClick={() => setViewTab("preview")}
                            className={cn(
                                "px-3 py-1 text-xs font-medium rounded-md transition-all",
                                viewTab === "preview" ? "bg-background shadow-sm text-foreground" : "text-muted-foreground"
                            )}
                        >
                            Preview
                        </button>
                        <button
                            onClick={() => setViewTab("code")}
                            className={cn(
                                "px-3 py-1 text-xs font-medium rounded-md transition-all",
                                viewTab === "code" ? "bg-background shadow-sm text-foreground" : "text-muted-foreground"
                            )}
                        >
                            HTML/CSS
                        </button>
                    </div>
                    <div className="flex gap-2">
                        <Input
                            value={themeName}
                            onChange={e => setThemeName(e.target.value)}
                            placeholder="Theme Name (e.g. Luxury Dark)"
                            className="h-8 w-48 text-xs"
                        />
                        <Button size="sm" onClick={handleSave} disabled={!generatedHtml || !themeName} className="h-8">
                            <Save className="w-3 h-3 mr-2" /> Save Theme
                        </Button>
                    </div>
                </div>

                {generatedHtml ? (
                    <div className="flex-1 bg-[#0a0a0a] overflow-y-auto p-6">
                        {viewTab === "preview" ? (
                            <div className="bg-white mx-auto max-w-[800px] shadow-2xl rounded overflow-hidden">
                                <PreviewPane html={generatedHtml} />
                            </div>
                        ) : (
                            <CodePane code={generatedHtml} onChange={setGeneratedHtml} className="h-full border-none rounded" />
                        )}
                    </div>
                ) : (
                    <div className="flex-1 flex items-center justify-center text-muted-foreground text-sm flex-col gap-3">
                        <LayoutTemplate className="w-10 h-10 opacity-20" />
                        Generate a template to see preview
                    </div>
                )}
            </div>
        </div>
    )
}
</file>

<file path="app/admin/layout.tsx">
import { AppSidebar } from "@/components/app-sidebar"
import { DashboardHeader } from "@/components/dashboard-header"
import { LockScreen } from "@/components/lock-screen"

export default function AdminLayout({
    children,
}: {
    children: React.ReactNode
}) {
    return (
        <LockScreen>
            <div className="min-h-screen bg-background">
                <AppSidebar />
                <main className="pl-64">
                    <DashboardHeader />
                    {children}
                </main>
            </div>
        </LockScreen>
    )
}
</file>

<file path="app/api/analyze-theme/route.ts">
import { NextResponse } from "next/server";
import { GoogleGenAI } from "@google/genai";

export async function POST(req: Request) {
    try {
        const formData = await req.formData();
        const mode = formData.get("mode") as "code" | "image" | "pdf";
        const code = formData.get("code") as string;
        const file = formData.get("file") as File;

        const ai = new GoogleGenAI({ apiKey: process.env.GEMINI_API_KEY! });

        const prompt = `You are an expert Frontend Developer & UI/UX Designer.
Your task is to analyze the provided reference material and extract a highly polished, reusable HTML & CSS Blog Template.

REQUIREMENTS:
1. Output a complete, valid HTML5 document (<!DOCTYPE html>...</html>).
2. Embed all CSS inside a <style> block in the <head>. Import any necessary Google Fonts.
3. Extract the exact color palette, typography, spacing, and component styles (quotes, stats, grids, buttons) from the reference.
4. Use placeholder text (e.g., "Heading Goes Here", "Lorem ipsum...") for the content. Do NOT write a real article.
5. Create placeholders for images using <img src="https://image.pollinations.ai/prompt/Placeholder?width=800&height=400&nologo=true" />.
6. Return ONLY the raw HTML code. Do not wrap it in markdown backticks like \`\`\`html.`;

        const contents: any[] = [{ role: "user", parts: [] }];

        if (mode === "code") {
            contents[0].parts.push({ text: `Here is the reference code:\n\n${code}\n\n${prompt}` });
        } else if (file) {
            const arrayBuffer = await file.arrayBuffer();
            const base64Data = Buffer.from(arrayBuffer).toString("base64");
            contents[0].parts.push({ inlineData: { data: base64Data, mimeType: file.type } });
            contents[0].parts.push({ text: prompt });
        } else {
            return NextResponse.json({ error: "Missing input data" }, { status: 400 });
        }

        const response = await ai.models.generateContent({
            model: "gemini-2.5-pro",
            contents: contents,
            config: { temperature: 0 }
        });

        let html = response.text || "";
        // Clean up markdown block wrapping if Gemini includes it
        if (html.startsWith("```html")) html = html.replace(/^```html\n/, "").replace(/\n```$/, "");
        else if (html.startsWith("```")) html = html.replace(/^```\n/, "").replace(/\n```$/, "");

        return NextResponse.json({ html: html.trim() });

    } catch (error: any) {
        console.error("Theme Analyzer Error:", error);
        return NextResponse.json({ error: error.message }, { status: 500 });
    }
}
</file>

<file path="app/api/extract-pdf/route.ts">
import { NextResponse } from "next/server";
import { GoogleGenAI } from "@google/genai";

export async function POST(req: Request) {
    try {
        const formData = await req.formData();
        const file = formData.get("file") as File;

        if (!file || file.type !== "application/pdf") {
            return NextResponse.json({ error: "Invalid file. Please upload a PDF." }, { status: 400 });
        }

        // Convert the PDF to a base64 string
        const arrayBuffer = await file.arrayBuffer();
        const base64Data = Buffer.from(arrayBuffer).toString("base64");

        const ai = new GoogleGenAI({ apiKey: process.env.GEMINI_API_KEY! });

        const response = await ai.models.generateContent({
            model: "gemini-2.5-pro",
            contents: [
                {
                    role: "user",
                    parts: [
                        {
                            inlineData: {
                                data: base64Data,
                                mimeType: "application/pdf"
                            }
                        },
                        {
                            text: "Extract the complete text of this research paper and convert it into highly readable Markdown. Preserve all statistics, quotes, headings, and data accurately. Remove any page numbers, headers, footers, or irrelevant publishing stamps. Do not include introductory conversational text, just output the raw Markdown."
                        }
                    ]
                }
            ]
        });

        let markdown = response.text || "";

        // Clean up markdown block wrapping if Gemini includes it
        if (markdown.startsWith("```markdown")) {
            markdown = markdown.replace(/^```markdown\n/, "").replace(/\n```$/, "");
        } else if (markdown.startsWith("```")) {
            markdown = markdown.replace(/^```\n/, "").replace(/\n```$/, "");
        }

        return NextResponse.json({ markdown: markdown.trim() });

    } catch (error: unknown) {
        const message = error instanceof Error ? error.message : "Unknown error";
        console.error("PDF Parsing Error:", error);
        return NextResponse.json({ error: message }, { status: 500 });
    }
}
</file>

<file path="app/api/upload/route.ts">
import { createClient } from "@supabase/supabase-js";
import { NextResponse } from "next/server";

// Initialize Supabase with Service Key to bypass RLS
const supabase = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_KEY!
);

export async function POST(request: Request) {
    try {
        const formData = await request.formData();
        const file = formData.get("file") as File;

        if (!file) {
            return NextResponse.json({ error: "No file uploaded" }, { status: 400 });
        }

        // 1. Generate unique path
        // Sanitize filename
        const filename = file.name.replace(/[^a-zA-Z0-9.-]/g, '');
        const path = `chat-uploads/${Date.now()}-${filename}`;

        // 2. Upload to Supabase Storage using Admin Client
        const arrayBuffer = await file.arrayBuffer();
        const buffer = Buffer.from(arrayBuffer);

        const { data, error } = await supabase.storage
            .from('chat-assets')
            .upload(path, buffer, {
                contentType: file.type,
                upsert: false
            });

        if (error) {
            console.error("Supabase Storage Error:", error);
            return NextResponse.json({ error: error.message }, { status: 500 });
        }

        // 3. Get Public URL
        const { data: publicUrlData } = supabase.storage
            .from('chat-assets')
            .getPublicUrl(path);

        return NextResponse.json({
            success: true,
            url: publicUrlData.publicUrl
        });

    } catch (error: any) {
        console.error("Upload Route Error:", error);
        return NextResponse.json({ error: error.message || "Internal Server Error" }, { status: 500 });
    }
}
</file>

<file path="app/editor/layout.tsx">
import type React from "react"

export default function EditorLayout({
    children,
}: {
    children: React.ReactNode
}) {
    // This layout renders only children without the main sidebar
    // to give the editor full screen real estate
    return <>{children}</>
}
</file>

<file path="components/admin/download-html-button.tsx">
'use client'

import { Download } from 'lucide-react'
import { Button } from '@/components/ui/button'

interface DownloadHtmlButtonProps {
    htmlContent: string | null
    filename: string
}

export function DownloadHtmlButton({ htmlContent, filename }: DownloadHtmlButtonProps) {
    if (!htmlContent) return null

    const handleDownload = () => {
        const blob = new Blob([htmlContent], { type: 'text/html' })
        const url = URL.createObjectURL(blob)
        const a = document.createElement('a')
        a.href = url
        a.download = filename
        document.body.appendChild(a)
        a.click()
        document.body.removeChild(a)
        URL.revokeObjectURL(url)
    }

    return (
        <Button
            variant="ghost"
            size="icon"
            className="h-8 w-8"
            onClick={handleDownload}
            title="Download HTML"
        >
            <Download className="h-4 w-4" />
        </Button>
    )
}
</file>

<file path="components/admin/settings-form.tsx">
'use client'

import { useState, useTransition, useEffect } from 'react'
import { Check, Loader2 } from 'lucide-react'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Textarea } from '@/components/ui/textarea'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import {
    getCompanyContext, saveCompanyContext,
    getDefaultLinks, saveDefaultLinks,
    getCustomLinks, saveCustomLinks,
    type AudienceContext, type Brand, type DefaultLinks, type CustomLink
} from '@/app/actions/settings'

export function SettingsForm() {
    // Company context
    const [context, setContext] = useState('')
    const [contextLoading, setContextLoading] = useState(true)

    // Default links
    const [links, setLinks] = useState<DefaultLinks>({
        unsubscribe_url: '',
        privacy_url: '',
        contact_url: '',
        about_url: '',
        shipping_url: '',
        main_cta_url: '',
        main_activate_url: '',
        crowdfunding_cta_url: '',
        homepage_url: '',
    })
    const [linksLoading, setLinksLoading] = useState(true)

    // Custom links
    const [customLinks, setCustomLinks] = useState<CustomLink[]>([])
    const [customLinksLoading, setCustomLinksLoading] = useState(true)

    const [isPending, startTransition] = useTransition()
    const [saved, setSaved] = useState(false)

    // Audience / brand selectors
    const [audience, setAudience] = useState<AudienceContext>('dreamplay')
    const [brand, setBrand] = useState<Brand>('dreamplay')

    // Load data
    useEffect(() => {
        const load = async () => {
            setContextLoading(true)
            setLinksLoading(true)
            setCustomLinksLoading(true)

            const [ctx, lnks, cLinks] = await Promise.all([
                getCompanyContext(audience),
                getDefaultLinks(brand),
                getCustomLinks(brand),
            ])

            setContext(ctx)
            setLinks(lnks)
            setCustomLinks(cLinks)
            setContextLoading(false)
            setLinksLoading(false)
            setCustomLinksLoading(false)
        }
        load()
    }, [audience, brand])

    const handleSave = () => {
        startTransition(async () => {
            await Promise.all([
                saveCompanyContext(audience, context),
                saveDefaultLinks(brand, links),
                saveCustomLinks(brand, customLinks),
            ])
            setSaved(true)
            setTimeout(() => setSaved(false), 2000)
        })
    }

    const updateLink = (key: keyof DefaultLinks, value: string) => {
        setLinks(prev => ({ ...prev, [key]: value }))
    }

    const addCustomLink = () => {
        setCustomLinks(prev => [...prev, { label: '', url: '' }])
    }

    const updateCustomLink = (index: number, field: keyof CustomLink, value: string) => {
        setCustomLinks(prev => {
            const updated = [...prev]
            updated[index] = { ...updated[index], [field]: value }
            return updated
        })
    }

    const removeCustomLink = (index: number) => {
        setCustomLinks(prev => prev.filter((_, i) => i !== index))
    }

    const linkFields: { key: keyof DefaultLinks; label: string; placeholder: string }[] = [
        { key: 'homepage_url', label: 'Homepage URL', placeholder: 'https://dreamplay.example.com' },
        { key: 'main_cta_url', label: 'Main CTA URL', placeholder: 'https://...' },
        { key: 'main_activate_url', label: 'Activate URL', placeholder: 'https://...' },
        { key: 'crowdfunding_cta_url', label: 'Crowdfunding CTA URL', placeholder: 'https://...' },
        { key: 'unsubscribe_url', label: 'Unsubscribe URL', placeholder: 'https://...' },
        { key: 'privacy_url', label: 'Privacy Policy URL', placeholder: 'https://...' },
        { key: 'contact_url', label: 'Contact URL', placeholder: 'https://...' },
        { key: 'about_url', label: 'About URL', placeholder: 'https://...' },
        { key: 'shipping_url', label: 'Shipping URL', placeholder: 'https://...' },
    ]

    return (
        <div className="space-y-6 max-w-2xl">
            {/* Audience/Brand Selectors */}
            <div className="flex gap-4">
                <div className="space-y-2 flex-1">
                    <Label>Audience Context</Label>
                    <div className="flex gap-2">
                        {(['dreamplay', 'musicalbasics', 'crossover'] as AudienceContext[]).map(a => (
                            <button
                                key={a}
                                onClick={() => setAudience(a)}
                                className={`px-3 py-1.5 text-xs font-medium rounded-lg border transition-colors capitalize ${audience === a
                                    ? 'border-primary bg-primary/10 text-foreground'
                                    : 'border-border text-muted-foreground hover:bg-accent hover:text-accent-foreground'
                                    }`}
                            >
                                {a}
                            </button>
                        ))}
                    </div>
                </div>
                <div className="space-y-2 flex-1">
                    <Label>Brand (Links)</Label>
                    <div className="flex gap-2">
                        {(['dreamplay', 'musicalbasics'] as Brand[]).map(b => (
                            <button
                                key={b}
                                onClick={() => setBrand(b)}
                                className={`px-3 py-1.5 text-xs font-medium rounded-lg border transition-colors capitalize ${brand === b
                                    ? 'border-primary bg-primary/10 text-foreground'
                                    : 'border-border text-muted-foreground hover:bg-accent hover:text-accent-foreground'
                                    }`}
                            >
                                {b}
                            </button>
                        ))}
                    </div>
                </div>
            </div>

            {/* Company Context */}
            <Card>
                <CardHeader>
                    <CardTitle>AI Copilot Context</CardTitle>
                    <CardDescription>
                        This context is sent to the AI copilot when generating blog posts.
                        Describe your brand voice, target audience, and key messaging.
                    </CardDescription>
                </CardHeader>
                <CardContent>
                    {contextLoading ? (
                        <div className="h-32 flex items-center justify-center text-muted-foreground">Loading...</div>
                    ) : (
                        <Textarea
                            value={context}
                            onChange={(e) => setContext(e.target.value)}
                            placeholder="Describe your company, brand voice, target audience..."
                            rows={8}
                            className="font-mono text-sm"
                        />
                    )}
                </CardContent>
            </Card>

            {/* Default Links */}
            <Card>
                <CardHeader>
                    <CardTitle>Default Links</CardTitle>
                    <CardDescription>
                        These URLs are used as defaults when the AI copilot generates blog posts with CTAs.
                    </CardDescription>
                </CardHeader>
                <CardContent className="space-y-4">
                    {linksLoading ? (
                        <div className="h-32 flex items-center justify-center text-muted-foreground">Loading...</div>
                    ) : (
                        linkFields.map(({ key, label, placeholder }) => (
                            <div key={key} className="space-y-2">
                                <Label htmlFor={key}>{label}</Label>
                                <Input
                                    id={key}
                                    type="url"
                                    value={links[key]}
                                    onChange={(e) => updateLink(key, e.target.value)}
                                    placeholder={placeholder}
                                    className="font-mono text-sm"
                                />
                            </div>
                        ))
                    )}
                </CardContent>
            </Card>

            {/* Custom Links */}
            <Card>
                <CardHeader>
                    <CardTitle>Custom Links</CardTitle>
                    <CardDescription>
                        Add any additional links that should be available to the AI copilot.
                    </CardDescription>
                </CardHeader>
                <CardContent className="space-y-3">
                    {customLinksLoading ? (
                        <div className="h-16 flex items-center justify-center text-muted-foreground">Loading...</div>
                    ) : (
                        <>
                            {customLinks.map((link, i) => (
                                <div key={i} className="flex items-center gap-2">
                                    <Input
                                        value={link.label}
                                        onChange={(e) => updateCustomLink(i, 'label', e.target.value)}
                                        placeholder="Label"
                                        className="flex-1 text-sm"
                                    />
                                    <Input
                                        value={link.url}
                                        onChange={(e) => updateCustomLink(i, 'url', e.target.value)}
                                        placeholder="https://..."
                                        className="flex-[2] font-mono text-sm"
                                    />
                                    <button
                                        onClick={() => removeCustomLink(i)}
                                        className="text-red-500 hover:text-red-700 text-xs px-2 py-1"
                                    >
                                        ×
                                    </button>
                                </div>
                            ))}
                            <button
                                onClick={addCustomLink}
                                className="text-xs text-primary hover:underline"
                            >
                                + Add custom link
                            </button>
                        </>
                    )}
                </CardContent>
            </Card>

            {/* Save Button */}
            <div className="flex items-center gap-3">
                <Button onClick={handleSave} disabled={isPending}>
                    {isPending ? (
                        <>
                            <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                            Saving...
                        </>
                    ) : saved ? (
                        <>
                            <Check className="mr-2 h-4 w-4" />
                            Saved
                        </>
                    ) : (
                        'Save Settings'
                    )}
                </Button>
                {saved && (
                    <span className="text-sm text-green-400">Settings saved successfully!</span>
                )}
            </div>
        </div>
    )
}
</file>

<file path="components/blog/blog-content-frame.tsx">
"use client"

import { useRef, useEffect, useState } from "react"

interface BlogContentFrameProps {
    html: string
}

export function BlogContentFrame({ html }: BlogContentFrameProps) {
    const iframeRef = useRef<HTMLIFrameElement>(null)
    const [height, setHeight] = useState(800)

    useEffect(() => {
        const iframe = iframeRef.current
        if (!iframe) return

        const handleLoad = () => {
            try {
                const doc = iframe.contentDocument || iframe.contentWindow?.document
                if (doc) {
                    // Observe resize changes in the iframe content
                    const updateHeight = () => {
                        const h = doc.documentElement.scrollHeight
                        if (h > 0) setHeight(h)
                    }

                    updateHeight()

                    // Re-check after images/fonts load
                    const observer = new MutationObserver(updateHeight)
                    observer.observe(doc.body, { childList: true, subtree: true, attributes: true })

                    // Also listen for image loads
                    const images = doc.querySelectorAll("img")
                    images.forEach((img) => {
                        if (!img.complete) {
                            img.addEventListener("load", updateHeight)
                        }
                    })

                    // Periodic check for font loading
                    const timer = setInterval(updateHeight, 500)
                    setTimeout(() => clearInterval(timer), 5000)

                    return () => {
                        observer.disconnect()
                        clearInterval(timer)
                    }
                }
            } catch {
                // Cross-origin restrictions won't apply with srcdoc
            }
        }

        iframe.addEventListener("load", handleLoad)
        return () => iframe.removeEventListener("load", handleLoad)
    }, [html])

    return (
        <iframe
            ref={iframeRef}
            srcDoc={html}
            style={{ width: "100%", height: `${height}px`, border: "none", display: "block" }}
            sandbox="allow-same-origin allow-popups allow-popups-to-escape-sandbox"
            title="Blog post content"
        />
    )
}
</file>

<file path="components/blog/blog-header.tsx">
"use client"

import Link from "next/link"
import { ArrowRight, Menu, X, ChevronDown } from "lucide-react"
import { useState, useEffect } from "react"
import { cn } from "@/lib/utils"

const WEBSITE = "https://www.dreamplaypianos.com"

// --- Desktop Dropdown ---
function NavDropdown({ label, items, useDarkText }: { label: string; items: { label: string; href: string }[]; useDarkText: boolean }) {
    const [open, setOpen] = useState(false)
    return (
        <div
            className="relative h-full flex items-center"
            onMouseEnter={() => setOpen(true)}
            onMouseLeave={() => setOpen(false)}
        >
            <button
                className={`flex items-center gap-1 text-sm transition-colors cursor-pointer ${useDarkText ? "text-neutral-700 hover:text-neutral-900" : "text-white/70 hover:text-white"}`}
            >
                {label}
                <ChevronDown className={`w-3.5 h-3.5 transition-transform duration-200 ${open ? "rotate-180" : ""}`} />
            </button>
            <div
                className={cn(
                    "absolute top-full right-0 mt-1 min-w-[180px] rounded-lg shadow-xl overflow-hidden transition-all duration-200 border",
                    useDarkText
                        ? "bg-white border-black/5 ring-1 ring-black/5"
                        : "bg-[#0a0a0f] border-white/10",
                    open ? "opacity-100 translate-y-0 visible" : "opacity-0 translate-y-2 invisible"
                )}
                style={{ zIndex: 100 }}
            >
                {items.map((item) => (
                    <a
                        key={item.label}
                        href={item.href}
                        className={`block px-4 py-3 text-sm transition-colors ${useDarkText
                            ? "text-gray-600 hover:text-black hover:bg-black/5"
                            : "text-gray-400 hover:text-white hover:bg-white/5"
                            }`}
                    >
                        {item.label}
                    </a>
                ))}
            </div>
        </div>
    )
}

// --- Mobile Dropdown ---
function MobileDropdownSection({ label, items, onClose }: { label: string; items: { label: string; href: string }[]; onClose: () => void }) {
    return (
        <>
            <div className="border-t border-gray-200 my-2" />
            <div className="px-1 py-1 text-xs font-semibold text-gray-400 uppercase tracking-wider">{label}</div>
            {items.map((item) => (
                <a
                    key={item.label}
                    href={item.href}
                    className="py-3 pl-3 text-neutral-600 hover:text-black font-medium border-b border-gray-50"
                    onClick={onClose}
                >
                    {item.label}
                </a>
            ))}
        </>
    )
}

interface BlogHeaderProps {
    forceOpaque?: boolean
    darkMode?: boolean
}

export function BlogHeader({ forceOpaque = false, darkMode = true }: BlogHeaderProps) {
    const [scrolled, setScrolled] = useState(false)
    const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false)

    useEffect(() => {
        const handleScroll = () => setScrolled(window.scrollY > 100)
        window.addEventListener("scroll", handleScroll)
        return () => window.removeEventListener("scroll", handleScroll)
    }, [])

    const isScrolled = forceOpaque || scrolled || isMobileMenuOpen
    const useDarkText = isScrolled && !darkMode

    const linkClass = (dark: boolean) =>
        `text-sm transition-colors ${dark ? "text-neutral-700 hover:text-neutral-900" : "text-white/70 hover:text-white"}`

    return (
        <header
            className="fixed top-0 left-0 right-0 z-[100] transition-all duration-300 flex flex-col"
            style={{ fontFamily: "var(--font-manrope), 'Manrope', sans-serif" }}
        >
            {/* Announcement Bar */}
            <a
                href={`${WEBSITE}/customize`}
                className="bg-[#050505] border-b border-white/10 py-2.5 text-center flex items-center justify-center w-full z-50 text-[10px] sm:text-xs text-white/80 uppercase tracking-[0.2em] font-medium hover:text-white transition-colors"
            >
                Founder&apos;s Batch Closing March 2nd. Retail MSRP ($1,199) Takes Effect After.
            </a>

            <div className={cn(
                "w-full transition-all duration-300",
                darkMode
                    ? "bg-[#050505]/95 backdrop-blur-md"
                    : isScrolled ? "bg-white/95 backdrop-blur-md shadow-sm" : "bg-transparent"
            )}>
                <div className="container mx-auto px-4 h-16 flex items-center justify-between">
                    {/* Logo */}
                    <a href={WEBSITE} className="flex items-center gap-2">
                        <img
                            src={useDarkText ? "/Logo.svg" : "/DreamPlay Logo White.png"}
                            alt="DreamPlay Pianos"
                            className={`h-8 transition-all ${useDarkText ? "brightness-0" : ""}`}
                        />
                    </a>

                    {/* Main navigation */}
                    <nav className="hidden md:flex items-center gap-6 h-full">
                        <a href={`${WEBSITE}/how-it-works`} className={linkClass(useDarkText)}>How It Works</a>
                        <a href={`${WEBSITE}/better-practice`} className={linkClass(useDarkText)}>The Benefits</a>

                        <NavDropdown
                            label="Features"
                            useDarkText={useDarkText}
                            items={[
                                { label: "Product Info", href: `${WEBSITE}/product-information` },
                                { label: "Buyer's Guide", href: `${WEBSITE}/buyers-guide` },
                            ]}
                        />

                        <NavDropdown
                            label="About Us"
                            useDarkText={useDarkText}
                            items={[
                                { label: "Our Story", href: `${WEBSITE}/our-story` },
                                { label: "The DS Standard", href: `${WEBSITE}/about-us/ds-standard` },
                            ]}
                        />

                        <NavDropdown
                            label="Manufacturing & Shipping"
                            useDarkText={useDarkText}
                            items={[
                                { label: "Manufacturing", href: `${WEBSITE}/production-timeline` },
                                { label: "Shipping", href: `${WEBSITE}/information-and-policies/shipping` },
                            ]}
                        />

                        <a href={`${WEBSITE}/information-and-policies/faq`} className={linkClass(useDarkText)}>FAQ</a>
                        <Link href="/blog" className={linkClass(useDarkText)}>Blog</Link>
                    </nav>

                    {/* CTA */}
                    <div className="flex items-center gap-4">
                        <a
                            href={`${WEBSITE}/customize`}
                            className={`hidden md:flex items-center gap-2 rounded-none px-5 py-2.5 text-sm font-medium transition-all duration-300 ${useDarkText
                                ? "bg-black border border-black text-white hover:bg-neutral-800"
                                : "bg-white/5 backdrop-blur-sm border border-white/30 text-white hover:bg-white/15"
                                }`}
                        >
                            Configure Yours
                            <span className="w-6 h-6 rounded-none flex items-center justify-center bg-white">
                                <ArrowRight className="w-3 h-3 text-black" />
                            </span>
                        </a>

                        <button
                            className={`md:hidden cursor-pointer p-2 ${useDarkText ? "text-neutral-900" : "text-white"}`}
                            onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)}
                        >
                            {isMobileMenuOpen ? <X className="w-5 h-5" /> : <Menu className="w-5 h-5" />}
                        </button>
                    </div>
                </div>
            </div>

            {/* Mobile Menu */}
            {isMobileMenuOpen && (
                <div className="md:hidden absolute top-[100px] left-0 right-0 bg-white border-b border-gray-100 shadow-xl animate-in slide-in-from-top-2 duration-200">
                    <nav className="flex flex-col p-4">
                        <a href={`${WEBSITE}/how-it-works`} className="py-3 text-neutral-600 hover:text-black font-medium border-b border-gray-50" onClick={() => setIsMobileMenuOpen(false)}>How It Works</a>
                        <a href={`${WEBSITE}/better-practice`} className="py-3 text-neutral-600 hover:text-black font-medium border-b border-gray-50" onClick={() => setIsMobileMenuOpen(false)}>The Benefits</a>

                        <MobileDropdownSection
                            label="Features"
                            onClose={() => setIsMobileMenuOpen(false)}
                            items={[
                                { label: "Product Info", href: `${WEBSITE}/product-information` },
                                { label: "Buyer's Guide", href: `${WEBSITE}/buyers-guide` },
                            ]}
                        />

                        <MobileDropdownSection
                            label="About Us"
                            onClose={() => setIsMobileMenuOpen(false)}
                            items={[
                                { label: "Our Story", href: `${WEBSITE}/our-story` },
                                { label: "The DS Standard", href: `${WEBSITE}/about-us/ds-standard` },
                            ]}
                        />

                        <MobileDropdownSection
                            label="Manufacturing & Shipping"
                            onClose={() => setIsMobileMenuOpen(false)}
                            items={[
                                { label: "Manufacturing", href: `${WEBSITE}/production-timeline` },
                                { label: "Shipping", href: `${WEBSITE}/information-and-policies/shipping` },
                            ]}
                        />

                        <div className="border-t border-gray-200 my-2" />
                        <a href={`${WEBSITE}/information-and-policies/faq`} className="py-3 text-neutral-600 hover:text-black font-medium border-b border-gray-50" onClick={() => setIsMobileMenuOpen(false)}>FAQ</a>
                        <Link href="/blog" className="py-3 text-neutral-600 hover:text-black font-medium" onClick={() => setIsMobileMenuOpen(false)}>Blog</Link>

                        <a
                            href={`${WEBSITE}/customize`}
                            className="mt-4 flex items-center justify-center gap-2 w-full bg-black text-white rounded-none py-3 font-medium"
                            onClick={() => setIsMobileMenuOpen(false)}
                        >
                            Configure Yours
                            <ArrowRight className="w-4 h-4" />
                        </a>
                    </nav>
                </div>
            )}
        </header>
    )
}
</file>

<file path="components/dnd-editor/block-palette.tsx">
"use client"

import { Type, Image, MousePointerClick, Minus, ArrowUpDown, Share2, Heading } from "lucide-react"
import { cn } from "@/lib/utils"
import type { BlockType } from "@/lib/dnd-blocks/types"
import { BLOCK_LABELS, BLOCK_DESCRIPTIONS } from "@/lib/dnd-blocks/defaults"

const BLOCK_ICONS: Record<BlockType, React.ElementType> = {
    heading: Heading,
    text: Type,
    image: Image,
    button: MousePointerClick,
    divider: Minus,
    spacer: ArrowUpDown,
    social: Share2,
}

const PALETTE_ORDER: BlockType[] = ['heading', 'text', 'image', 'button', 'divider', 'spacer', 'social']

interface BlockPaletteProps {
    onAddBlock: (type: BlockType) => void
}

export function BlockPalette({ onAddBlock }: BlockPaletteProps) {
    return (
        <div className="p-3 space-y-1.5">
            <p className="text-[10px] uppercase font-semibold text-muted-foreground px-1 mb-2">Content Blocks</p>
            <div className="grid grid-cols-2 gap-2">
                {PALETTE_ORDER.map((type) => {
                    const Icon = BLOCK_ICONS[type]
                    return (
                        <button
                            key={type}
                            onClick={() => onAddBlock(type)}
                            draggable
                            onDragStart={(e) => {
                                e.dataTransfer.setData('block-type', type)
                                e.dataTransfer.effectAllowed = 'copy'
                            }}
                            className={cn(
                                "flex flex-col items-center gap-1.5 p-3 rounded-lg border border-border",
                                "bg-background hover:bg-muted hover:border-primary/30 transition-all",
                                "cursor-grab active:cursor-grabbing text-muted-foreground hover:text-foreground",
                                "group"
                            )}
                        >
                            <Icon className="w-5 h-5 group-hover:text-primary transition-colors" />
                            <span className="text-[11px] font-medium leading-tight">{BLOCK_LABELS[type]}</span>
                        </button>
                    )
                })}
            </div>
        </div>
    )
}
</file>

<file path="components/dnd-editor/dnd-canvas.tsx">
"use client"

import { useState } from "react"
import { GripVertical, Trash2, Copy, ChevronUp, ChevronDown } from "lucide-react"
import { cn } from "@/lib/utils"
import { BlockRenderer } from "./block-renderers"
import type { EmailBlock, BlockType } from "@/lib/dnd-blocks/types"
import { BLOCK_DEFAULTS } from "@/lib/dnd-blocks/defaults"

interface DndCanvasProps {
    blocks: EmailBlock[]
    selectedBlockId: string | null
    onSelectBlock: (id: string | null) => void
    onUpdateBlocks: (blocks: EmailBlock[]) => void
}

export function DndCanvas({ blocks, selectedBlockId, onSelectBlock, onUpdateBlocks }: DndCanvasProps) {
    const [draggedIndex, setDraggedIndex] = useState<number | null>(null)
    const [dropTargetIndex, setDropTargetIndex] = useState<number | null>(null)

    const moveBlock = (index: number, direction: -1 | 1) => {
        const target = index + direction
        if (target < 0 || target >= blocks.length) return
        const newBlocks = [...blocks]
            ;[newBlocks[index], newBlocks[target]] = [newBlocks[target], newBlocks[index]]
        onUpdateBlocks(newBlocks)
    }

    const duplicateBlock = (index: number) => {
        const block = blocks[index]
        const newBlock: EmailBlock = {
            ...block,
            id: `block-${Date.now()}-${Math.random().toString(36).slice(2, 7)}`,
            props: { ...block.props },
        }
        const newBlocks = [...blocks]
        newBlocks.splice(index + 1, 0, newBlock)
        onUpdateBlocks(newBlocks)
        onSelectBlock(newBlock.id)
    }

    const deleteBlock = (id: string) => {
        const newBlocks = blocks.filter(b => b.id !== id)
        onUpdateBlocks(newBlocks)
        if (selectedBlockId === id) {
            onSelectBlock(newBlocks.length > 0 ? newBlocks[0].id : null)
        }
    }

    // --- DnD Handlers ---
    const handleDragStart = (e: React.DragEvent, index: number) => {
        setDraggedIndex(index)
        e.dataTransfer.effectAllowed = 'move'
    }

    const handleDragOver = (e: React.DragEvent, index: number) => {
        e.preventDefault()
        const isPaletteDrag = e.dataTransfer.types.includes('block-type')
        e.dataTransfer.dropEffect = isPaletteDrag ? 'copy' : 'move'
        setDropTargetIndex(index)
    }

    const handleDrop = (e: React.DragEvent, dropIndex: number) => {
        e.preventDefault()
        setDropTargetIndex(null)

        // Case 1: Drop from palette (new block)
        const paletteType = e.dataTransfer.getData('block-type') as BlockType
        if (paletteType && BLOCK_DEFAULTS[paletteType]) {
            const newBlock: EmailBlock = {
                id: `block-${Date.now()}-${Math.random().toString(36).slice(2, 7)}`,
                type: paletteType,
                props: { ...BLOCK_DEFAULTS[paletteType] } as any,
            }
            const newBlocks = [...blocks]
            newBlocks.splice(dropIndex, 0, newBlock)
            onUpdateBlocks(newBlocks)
            onSelectBlock(newBlock.id)
            setDraggedIndex(null)
            return
        }

        // Case 2: Reorder existing block
        if (draggedIndex === null || draggedIndex === dropIndex) {
            setDraggedIndex(null)
            return
        }
        const newBlocks = [...blocks]
        const [movedItem] = newBlocks.splice(draggedIndex, 1)
        newBlocks.splice(dropIndex, 0, movedItem)
        onUpdateBlocks(newBlocks)
        setDraggedIndex(null)
    }

    // Handle drop on the empty canvas area (for palette drags)
    const handleCanvasDrop = (e: React.DragEvent) => {
        e.preventDefault()
        setDropTargetIndex(null)
        const paletteType = e.dataTransfer.getData('block-type') as BlockType
        if (paletteType && BLOCK_DEFAULTS[paletteType]) {
            const newBlock: EmailBlock = {
                id: `block-${Date.now()}-${Math.random().toString(36).slice(2, 7)}`,
                type: paletteType,
                props: { ...BLOCK_DEFAULTS[paletteType] } as any,
            }
            onUpdateBlocks([...blocks, newBlock])
            onSelectBlock(newBlock.id)
        }
    }

    const handleCanvasDragOver = (e: React.DragEvent) => {
        e.preventDefault()
        e.dataTransfer.dropEffect = 'copy'
    }

    return (
        <div className="h-full overflow-y-auto">
            <div
                className="p-6 pb-32 min-h-full"
                onDrop={handleCanvasDrop}
                onDragOver={handleCanvasDragOver}
            >
                {/* Email container preview */}
                <div className="max-w-[600px] mx-auto bg-white shadow-lg rounded-sm min-h-[400px]">
                    {blocks.length === 0 && (
                        <div className="flex flex-col items-center justify-center h-80 text-muted-foreground">
                            <p className="text-sm">Drag blocks here or click them from the palette</p>
                            <p className="text-xs mt-1">Or use the Copilot to generate blocks with AI</p>
                        </div>
                    )}
                    {blocks.map((block, index) => (
                        <div
                            key={block.id}
                            draggable
                            onDragStart={(e) => handleDragStart(e, index)}
                            onDragOver={(e) => handleDragOver(e, index)}
                            onDrop={(e) => handleDrop(e, index)}
                            onDragEnd={() => { setDraggedIndex(null); setDropTargetIndex(null) }}
                            onClick={(e) => { e.stopPropagation(); onSelectBlock(block.id) }}
                            className={cn(
                                "group relative transition-all cursor-pointer",
                                selectedBlockId === block.id
                                    ? "ring-2 ring-primary ring-inset"
                                    : "hover:ring-1 hover:ring-primary/30 hover:ring-inset",
                                draggedIndex === index && "opacity-40",
                                dropTargetIndex === index && draggedIndex !== index && "border-t-2 border-primary",
                            )}
                        >
                            {/* Block toolbar */}
                            <div className={cn(
                                "absolute -left-10 top-1/2 -translate-y-1/2 flex flex-col gap-0.5 opacity-0 group-hover:opacity-100 transition-opacity z-10",
                                selectedBlockId === block.id && "opacity-100"
                            )}>
                                <button className="p-1 rounded bg-card border border-border hover:bg-muted cursor-grab active:cursor-grabbing" title="Drag to reorder">
                                    <GripVertical className="w-3.5 h-3.5 text-muted-foreground" />
                                </button>
                            </div>

                            {/* Hover toolbar (right side) */}
                            <div className={cn(
                                "absolute -right-10 top-1/2 -translate-y-1/2 flex flex-col gap-0.5 opacity-0 group-hover:opacity-100 transition-opacity z-10",
                                selectedBlockId === block.id && "opacity-100"
                            )}>
                                <button onClick={(e) => { e.stopPropagation(); moveBlock(index, -1) }} className="p-1 rounded bg-card border border-border hover:bg-muted" title="Move up" disabled={index === 0}>
                                    <ChevronUp className="w-3.5 h-3.5 text-muted-foreground" />
                                </button>
                                <button onClick={(e) => { e.stopPropagation(); moveBlock(index, 1) }} className="p-1 rounded bg-card border border-border hover:bg-muted" title="Move down" disabled={index === blocks.length - 1}>
                                    <ChevronDown className="w-3.5 h-3.5 text-muted-foreground" />
                                </button>
                                <button onClick={(e) => { e.stopPropagation(); duplicateBlock(index) }} className="p-1 rounded bg-card border border-border hover:bg-muted" title="Duplicate">
                                    <Copy className="w-3.5 h-3.5 text-muted-foreground" />
                                </button>
                                <button onClick={(e) => { e.stopPropagation(); deleteBlock(block.id) }} className="p-1 rounded bg-card border border-border hover:bg-red-100 hover:border-red-300" title="Delete">
                                    <Trash2 className="w-3.5 h-3.5 text-red-500" />
                                </button>
                            </div>

                            {/* Block type label */}
                            {selectedBlockId === block.id && (
                                <div className="absolute -top-5 left-0 bg-primary text-primary-foreground text-[10px] px-2 py-0.5 rounded-t font-medium uppercase tracking-wider">
                                    {block.type}
                                </div>
                            )}

                            {/* Block content */}
                            <BlockRenderer block={block} />
                        </div>
                    ))}
                </div>
            </div>
        </div>
    )
}
</file>

<file path="components/dnd-editor/dnd-copilot-pane.tsx">
"use client"

import { useState, useRef, useEffect } from "react"
import { Sparkles, Send, X, Bot, Paperclip, Loader2, FileText } from "lucide-react"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select"
import { cn } from "@/lib/utils"
import type { EmailBlock } from "@/lib/dnd-blocks/types"

import { getAnthropicModels } from "@/app/actions/ai-models"

interface Message {
    role: "user" | "details" | "result"
    content: string
    imageUrls?: string[]
}

interface DndCopilotPaneProps {
    blocks: EmailBlock[]
    onBlocksChange: (blocks: EmailBlock[], prompt: string) => void
    audienceContext?: "dreamplay" | "musicalbasics" | "both"
    aiDossier?: string
}

export function DndCopilotPane({ blocks, onBlocksChange, audienceContext = "dreamplay", aiDossier = "" }: DndCopilotPaneProps) {
    const [messages, setMessages] = useState<Message[]>([])
    const [inputValue, setInputValue] = useState("")
    const [isLoading, setIsLoading] = useState(false)
    const [model, setModel] = useState("auto")
    const [models, setModels] = useState<string[]>([])
    const [imageUrls, setImageUrls] = useState<string[]>([])
    const messagesEndRef = useRef<HTMLDivElement>(null)
    const fileInputRef = useRef<HTMLInputElement>(null)

    useEffect(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: "smooth" })
    }, [messages])

    useEffect(() => {
        getAnthropicModels().then(setModels).catch(console.error)
    }, [])

    const uploadFile = async (file: File) => {
        const formData = new FormData()
        formData.append("file", file)
        try {
            const res = await fetch("/api/upload", { method: "POST", body: formData })
            const data = await res.json()
            if (data.url) setImageUrls(prev => [...prev, data.url])
        } catch (e) {
            console.error("Upload failed", e)
        }
    }

    const handlePaste = (e: React.ClipboardEvent) => {
        const items = e.clipboardData.items
        for (const item of Array.from(items)) {
            if (item.type.startsWith("image/") || item.type === "application/pdf") {
                const file = item.getAsFile()
                if (file) uploadFile(file)
            }
        }
    }

    const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {
        if (e.target.files) {
            Array.from(e.target.files).forEach(uploadFile)
        }
    }

    const handleSendMessage = async () => {
        const prompt = inputValue.trim()
        if (!prompt || isLoading) return

        const userMessage: Message = { role: "user", content: prompt, imageUrls: [...imageUrls] }
        const updatedMessages = [...messages, userMessage]
        setMessages(updatedMessages)
        setInputValue("")
        setImageUrls([])
        setIsLoading(true)

        try {
            const res = await fetch("/api/copilot-dnd", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    currentBlocks: blocks,
                    messages: updatedMessages.map(m => ({
                        role: m.role,
                        content: m.content,
                        imageUrls: m.imageUrls,
                    })),
                    model,
                    audienceContext,
                    aiDossier,
                }),
            })

            const data = await res.json()

            if (data.error) {
                setMessages(prev => [...prev, { role: "details", content: `Error: ${data.error}` }])
            } else {
                // Show explanation
                if (data.explanation) {
                    setMessages(prev => [...prev, { role: "details", content: data.explanation }])
                }

                // Apply blocks
                if (data.blocks && Array.isArray(data.blocks)) {
                    onBlocksChange(data.blocks, prompt)
                    setMessages(prev => [...prev, { role: "result", content: `Applied ${data.blocks.length} blocks to the canvas.` }])
                }
            }
        } catch (e: any) {
            setMessages(prev => [...prev, { role: "details", content: `Error: ${e.message}` }])
        } finally {
            setIsLoading(false)
        }
    }

    return (
        <div className="flex flex-col h-full">
            {/* Header */}
            <div className="p-3 border-b border-border flex items-center gap-2 bg-muted/20">
                <Sparkles className="w-4 h-4 text-primary" />
                <span className="text-sm font-semibold">AI Copilot</span>
                <div className="ml-auto">
                    <Select value={model} onValueChange={setModel}>
                        <SelectTrigger className="h-7 text-[11px] w-[140px] border-border">
                            <SelectValue />
                        </SelectTrigger>
                        <SelectContent>
                            <SelectItem value="auto" className="text-xs">✨ Auto (Smart Routing)</SelectItem>
                            {models.map(m => (
                                <SelectItem key={m} value={m} className="text-xs">{m}</SelectItem>
                            ))}
                        </SelectContent>
                    </Select>
                </div>
            </div>

            {/* Messages */}
            <div className="flex-1 overflow-y-auto p-3 space-y-3">
                {messages.length === 0 && (
                    <div className="flex flex-col items-center justify-center h-full text-muted-foreground">
                        <Bot className="w-8 h-8 mb-2 opacity-30" />
                        <p className="text-xs text-center">
                            Ask the AI to create an email.<br />
                            <span className="text-muted-foreground/70">
                                "Create a welcome email with a hero image, heading, description, and CTA button"
                            </span>
                        </p>
                    </div>
                )}
                {messages.map((msg, i) => (
                    <div key={i} className={cn(
                        "text-xs p-2.5 rounded-lg max-w-[95%]",
                        msg.role === "user" ? "bg-primary/10 text-foreground ml-auto" :
                            msg.role === "result" ? "bg-green-500/10 text-green-700 dark:text-green-400 border border-green-500/20" :
                                "bg-muted text-muted-foreground"
                    )}>
                        {msg.imageUrls && msg.imageUrls.length > 0 && (
                            <div className="flex gap-1 mb-1.5 flex-wrap">
                                {msg.imageUrls.map((url, j) => (
                                    <div key={j} className="flex items-center gap-1 bg-background/50 rounded px-1.5 py-0.5">
                                        <FileText className="w-3 h-3" />
                                        <span className="text-[10px]">Attachment {j + 1}</span>
                                    </div>
                                ))}
                            </div>
                        )}
                        {msg.content}
                    </div>
                ))}
                {isLoading && (
                    <div className="flex items-center gap-2 text-xs text-muted-foreground">
                        <Loader2 className="w-3 h-3 animate-spin" />
                        Generating blocks...
                    </div>
                )}
                <div ref={messagesEndRef} />
            </div>

            {/* Image previews */}
            {imageUrls.length > 0 && (
                <div className="px-3 py-1.5 border-t border-border flex gap-2 flex-wrap">
                    {imageUrls.map((url, i) => (
                        <div key={i} className="relative group">
                            <div className="flex items-center gap-1 bg-muted rounded px-2 py-1">
                                <FileText className="w-3 h-3" />
                                <span className="text-[10px]">File {i + 1}</span>
                            </div>
                            <button
                                onClick={() => setImageUrls(prev => prev.filter((_, j) => j !== i))}
                                className="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-3.5 h-3.5 flex items-center justify-center text-[8px] opacity-0 group-hover:opacity-100"
                            >
                                <X className="w-2 h-2" />
                            </button>
                        </div>
                    ))}
                </div>
            )}

            {/* Input */}
            <div className="p-3 border-t border-border bg-card">
                <div className="flex items-center gap-2">
                    <input type="file" ref={fileInputRef} onChange={handleFileSelect} className="hidden" multiple accept="image/*,.pdf" />
                    <Button variant="ghost" size="sm" className="h-8 w-8 p-0" onClick={() => fileInputRef.current?.click()}>
                        <Paperclip className="w-4 h-4" />
                    </Button>
                    <Input
                        value={inputValue}
                        onChange={(e) => setInputValue(e.target.value)}
                        onKeyDown={(e) => e.key === "Enter" && !e.shiftKey && handleSendMessage()}
                        onPaste={handlePaste}
                        placeholder="Describe your email..."
                        className="h-8 text-xs flex-1"
                    />
                    <Button size="sm" className="h-8 w-8 p-0" onClick={handleSendMessage} disabled={isLoading || !inputValue.trim()}>
                        <Send className="w-4 h-4" />
                    </Button>
                </div>
            </div>
        </div>
    )
}
</file>

<file path="components/editor/asset-picker-modal.tsx">
"use client"

import type React from "react"
import { useState, useCallback, useEffect } from "react"
import { X, Upload, ImageIcon, Loader2, Trash2, FolderPlus, Folder, ChevronRight, LayoutGrid, List, Home, FolderInput, CheckSquare, Square } from "lucide-react"
import { cn } from "@/lib/utils"
import { deleteAsset, deleteAssets, createFolder, deleteFolder, moveAsset, moveAssets, getAssets, getFolders, getSubFolders, uploadHashedAsset } from "@/app/actions/assets"
import { ImageCropper } from "./image-cropper"

interface Asset {
    id: string
    filename: string
    folder_path: string
    storage_hash: string
    public_url: string
    size?: number
    created_at?: string
}

interface FolderItem {
    name: string
}

interface AssetPickerModalProps {
    isOpen: boolean
    onClose: () => void
    onSelect: (url: string) => void
}

type ViewMode = "grid" | "list"

export function AssetPickerModal({ isOpen, onClose, onSelect }: AssetPickerModalProps) {
    const [assets, setAssets] = useState<Asset[]>([])
    const [folders, setFolders] = useState<FolderItem[]>([])
    const [loading, setLoading] = useState(false)
    const [uploading, setUploading] = useState(false)
    const [selectedAsset, setSelectedAsset] = useState<Asset | null>(null)
    const [croppingAsset, setCroppingAsset] = useState<Asset | null>(null)
    const [isDragOver, setIsDragOver] = useState(false)
    const [deleting, setDeleting] = useState<string | null>(null)
    const [currentFolder, setCurrentFolder] = useState("")
    const [viewMode, setViewMode] = useState<ViewMode>("grid")
    const [creatingFolder, setCreatingFolder] = useState(false)
    const [newFolderName, setNewFolderName] = useState("")
    const [creatingFolderLoading, setCreatingFolderLoading] = useState(false)
    const [movingAsset, setMovingAsset] = useState<string | null>(null)
    const [dropTargetFolder, setDropTargetFolder] = useState<string | null>(null)

    // ─── Multi-Select State ───
    const [multiSelectedIds, setMultiSelectedIds] = useState<Set<string>>(new Set())
    const [bulkDeleting, setBulkDeleting] = useState(false)
    const [bulkMoving, setBulkMoving] = useState(false)
    const [showMoveDialog, setShowMoveDialog] = useState(false)
    const [allFolders, setAllFolders] = useState<string[]>([])

    const isMultiSelectMode = multiSelectedIds.size > 0

    // ─── Fetch assets from DB ───
    const fetchAssets = useCallback(async () => {
        setLoading(true)
        setSelectedAsset(null)

        // Fetch assets in the current folder
        const { assets: dbAssets } = await getAssets(currentFolder)
        const fileItems: Asset[] = (dbAssets || []).filter((a: Asset) => a.filename !== ".folder")
        setAssets(fileItems)

        // Fetch subfolders
        let folderItems: FolderItem[] = []
        if (currentFolder) {
            const { folders: subFolders } = await getSubFolders(currentFolder)
            folderItems = subFolders.map((name: string) => ({ name }))
        } else {
            const { folders: rootFolders } = await getFolders()
            folderItems = rootFolders.map((name: string) => ({ name }))
        }
        setFolders(folderItems)

        setLoading(false)
    }, [currentFolder])

    useEffect(() => {
        if (isOpen) {
            fetchAssets()
        }
    }, [isOpen, fetchAssets])

    // Reset state when modal closes
    useEffect(() => {
        if (!isOpen) {
            setCurrentFolder("")
            setSelectedAsset(null)
            setCroppingAsset(null)
            setCreatingFolder(false)
            setMultiSelectedIds(new Set())
            setShowMoveDialog(false)
        }
    }, [isOpen])

    // Clear multi-select when navigating folders
    useEffect(() => {
        setMultiSelectedIds(new Set())
    }, [currentFolder])

    // ─── Fetch all root folders for "Move to" dialog ───
    const fetchAllFolders = useCallback(async () => {
        const { folders: rootFolders } = await getFolders()
        setAllFolders(rootFolders)
    }, [])

    // ─── Multi-Select Handlers ───
    const toggleMultiSelect = (assetId: string, e?: React.MouseEvent) => {
        e?.stopPropagation()
        setMultiSelectedIds(prev => {
            const next = new Set(prev)
            if (next.has(assetId)) {
                next.delete(assetId)
            } else {
                next.add(assetId)
            }
            return next
        })
    }

    const selectAll = () => {
        if (multiSelectedIds.size === assets.length) {
            setMultiSelectedIds(new Set())
        } else {
            setMultiSelectedIds(new Set(assets.map(a => a.id)))
        }
    }

    const getSelectedAssets = () => assets.filter(a => multiSelectedIds.has(a.id))

    const handleBulkDelete = async () => {
        const selected = getSelectedAssets()
        if (selected.length === 0) return
        if (!confirm(`Delete ${selected.length} asset${selected.length > 1 ? "s" : ""}? They will be hidden from the library.`)) return

        setBulkDeleting(true)
        const ids = selected.map(a => a.id)
        const result = await deleteAssets(ids)

        if (!result.success) {
            console.error("Error bulk deleting:", result.error)
        } else {
            setMultiSelectedIds(new Set())
            if (selectedAsset && multiSelectedIds.has(selectedAsset.id)) {
                setSelectedAsset(null)
            }
            await fetchAssets()
        }
        setBulkDeleting(false)
    }

    const handleBulkMoveToFolder = async (targetFolder: string) => {
        const selected = getSelectedAssets()
        if (selected.length === 0) return

        setBulkMoving(true)
        const ids = selected.map(a => a.id)
        const result = await moveAssets(ids, targetFolder)

        if (!result.success) {
            console.error("Error bulk moving:", result.error)
        } else {
            setMultiSelectedIds(new Set())
            setShowMoveDialog(false)
            await fetchAssets()
        }
        setBulkMoving(false)
    }

    const openMoveDialog = async () => {
        await fetchAllFolders()
        setShowMoveDialog(true)
    }

    const compressImage = async (file: File): Promise<File> => {
        return new Promise((resolve, reject) => {
            const img = new Image()
            const reader = new FileReader()

            reader.onload = (e) => {
                img.src = e.target?.result as string
            }
            reader.onerror = reject

            img.onload = () => {
                const canvas = document.createElement("canvas")
                const ctx = canvas.getContext("2d")
                if (!ctx) return reject(new Error("Canvas context failed"))

                const MAX_WIDTH = 1600
                const MAX_HEIGHT = 1600
                let width = img.width
                let height = img.height

                if (width > height) {
                    if (width > MAX_WIDTH) {
                        height *= MAX_WIDTH / width
                        width = MAX_WIDTH
                    }
                } else {
                    if (height > MAX_HEIGHT) {
                        width *= MAX_HEIGHT / height
                        height = MAX_HEIGHT
                    }
                }

                canvas.width = width
                canvas.height = height
                ctx.drawImage(img, 0, 0, width, height)

                canvas.toBlob(
                    (blob) => {
                        if (!blob) return reject(new Error("Compression failed"))
                        const compressedFile = new File([blob], file.name, {
                            type: "image/jpeg",
                            lastModified: Date.now(),
                        })
                        resolve(compressedFile)
                    },
                    "image/jpeg",
                    0.9,
                )
            }

            reader.readAsDataURL(file)
        })
    }

    const handleFileUpload = async (file: File) => {
        setUploading(true)

        try {
            let fileToUpload = file
            if (file.type.startsWith("image/")) {
                fileToUpload = await compressImage(file)
            }

            const formData = new FormData()
            formData.append("file", fileToUpload)

            const result = await uploadHashedAsset(formData, currentFolder)

            if (!result.success) {
                console.error("Error uploading file:", result.error)
            } else {
                await fetchAssets()
            }
        } catch (e) {
            console.error("Upload process failed:", e)
        }
        setUploading(false)
    }

    const handleDragOver = useCallback((e: React.DragEvent) => {
        e.preventDefault()
        setIsDragOver(true)
    }, [])

    const handleDragLeave = useCallback((e: React.DragEvent) => {
        e.preventDefault()
        setIsDragOver(false)
    }, [])

    const handleDrop = useCallback(
        (e: React.DragEvent) => {
            e.preventDefault()
            setIsDragOver(false)
            if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                handleFileUpload(e.dataTransfer.files[0])
            }
        },
        [currentFolder],
    )

    const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {
        if (e.target.files && e.target.files[0]) {
            handleFileUpload(e.target.files[0])
        }
    }

    const handleSelect = () => {
        if (selectedAsset) {
            setCroppingAsset(selectedAsset)
        }
    }

    const handleCropComplete = async (blob: Blob) => {
        if (!croppingAsset) return
        setUploading(true)

        try {
            const fileName = `cropped-${Date.now()}-${croppingAsset.filename}`
            const file = new File([blob], fileName, { type: "image/jpeg" })

            const formData = new FormData()
            formData.append("file", file)

            const result = await uploadHashedAsset(formData, currentFolder)

            if (!result.success) {
                console.error("Error uploading cropped asset:", result.error)
            } else if (result.asset) {
                onSelect(result.asset.public_url)
                onClose()
            }
        } catch (e) {
            console.error("Crop upload failed:", e)
        }
        setUploading(false)
        setCroppingAsset(null)
    }

    const handleSkipCrop = () => {
        if (croppingAsset) {
            onSelect(croppingAsset.public_url)
            onClose()
        }
    }

    const handleDeleteAsset = async (e: React.MouseEvent, asset: Asset) => {
        e.stopPropagation()
        if (!confirm(`Delete "${asset.filename}"? It will be hidden but existing email links stay intact.`)) return

        setDeleting(asset.id)
        const result = await deleteAsset(asset.id)

        if (!result.success) {
            console.error("Error deleting asset:", result.error)
        } else {
            if (selectedAsset?.id === asset.id) {
                setSelectedAsset(null)
            }
            multiSelectedIds.delete(asset.id)
            setMultiSelectedIds(new Set(multiSelectedIds))
            await fetchAssets()
        }
        setDeleting(null)
    }

    const handleDeleteFolder = async (e: React.MouseEvent, folderName: string) => {
        e.stopPropagation()
        if (!confirm(`Delete folder "${folderName}" and hide all its contents?`)) return

        setDeleting(folderName)
        const fullPath = currentFolder ? `${currentFolder}/${folderName}` : folderName
        const result = await deleteFolder(fullPath)

        if (!result.success) {
            console.error("Error deleting folder:", result.error)
        } else {
            await fetchAssets()
        }
        setDeleting(null)
    }

    const handleCreateFolder = async () => {
        const name = newFolderName.trim()
        if (!name) return

        setCreatingFolderLoading(true)
        const fullPath = currentFolder ? `${currentFolder}/${name}` : name
        const result = await createFolder(fullPath)

        if (!result.success) {
            console.error("Error creating folder:", result.error)
        } else {
            setCreatingFolder(false)
            setNewFolderName("")
            await fetchAssets()
        }
        setCreatingFolderLoading(false)
    }

    const navigateToFolder = (folderName: string) => {
        setCurrentFolder((prev) => (prev ? `${prev}/${folderName}` : folderName))
    }

    const navigateToRoot = () => {
        setCurrentFolder("")
    }

    const navigateToBreadcrumb = (index: number) => {
        const parts = currentFolder.split("/")
        setCurrentFolder(parts.slice(0, index + 1).join("/"))
    }

    const formatFileSize = (bytes?: number) => {
        if (!bytes) return "—"
        if (bytes < 1024) return `${bytes} B`
        if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`
        return `${(bytes / (1024 * 1024)).toFixed(1)} MB`
    }

    // ─── Drag & Drop: Move assets into folders ───
    const handleAssetDragStart = (e: React.DragEvent, asset: Asset) => {
        e.dataTransfer.setData("text/plain", asset.id)
        e.dataTransfer.effectAllowed = "move"
        setMovingAsset(asset.id)
    }

    const handleAssetDragEnd = () => {
        setMovingAsset(null)
        setDropTargetFolder(null)
    }

    const handleFolderDragOver = (e: React.DragEvent, folderName: string) => {
        if (!movingAsset) return
        e.preventDefault()
        e.dataTransfer.dropEffect = "move"
        setDropTargetFolder(folderName)
    }

    const handleFolderDragLeave = () => {
        setDropTargetFolder(null)
    }

    const handleFolderDrop = async (e: React.DragEvent, folderName: string) => {
        e.preventDefault()
        setDropTargetFolder(null)
        const assetId = e.dataTransfer.getData("text/plain")
        if (!assetId) return

        setMovingAsset(assetId)
        const targetPath = currentFolder ? `${currentFolder}/${folderName}` : folderName

        const result = await moveAsset(assetId, targetPath)
        if (!result.success) {
            console.error("Error moving asset:", result.error)
        } else {
            await fetchAssets()
        }
        setMovingAsset(null)
    }

    // Handle click on asset — multi-select mode vs single-select mode
    const handleAssetClick = (asset: Asset, e: React.MouseEvent) => {
        if (isMultiSelectMode) {
            toggleMultiSelect(asset.id, e)
        } else {
            setSelectedAsset(asset)
        }
    }

    if (!isOpen) return null

    const breadcrumbParts = currentFolder ? currentFolder.split("/") : []

    // Filter out current folder from move targets
    const moveTargetFolders = allFolders.filter(f => {
        if (currentFolder === "") return true // show all folders when at root
        return f !== currentFolder.split("/")[0] // exclude current root folder
    })

    return (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm">
            <div className="w-full max-w-2xl mx-4 rounded-lg bg-[#111111] border border-neutral-800 shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                {/* Header */}
                <div className="flex items-center justify-between px-6 py-4 border-b border-neutral-800 flex-shrink-0">
                    <h3 className="text-lg font-medium text-neutral-100">
                        {croppingAsset ? "Adjust Image" : "Select Image Asset"}
                    </h3>
                    <div className="flex items-center gap-2">
                        {!croppingAsset && (
                            <>
                                <button
                                    onClick={() => setViewMode("grid")}
                                    className={cn(
                                        "p-1.5 rounded-md transition-colors",
                                        viewMode === "grid"
                                            ? "bg-neutral-700 text-neutral-100"
                                            : "text-neutral-400 hover:text-neutral-100 hover:bg-neutral-800",
                                    )}
                                    title="Grid view"
                                >
                                    <LayoutGrid className="w-4 h-4" />
                                </button>
                                <button
                                    onClick={() => setViewMode("list")}
                                    className={cn(
                                        "p-1.5 rounded-md transition-colors",
                                        viewMode === "list"
                                            ? "bg-neutral-700 text-neutral-100"
                                            : "text-neutral-400 hover:text-neutral-100 hover:bg-neutral-800",
                                    )}
                                    title="List view"
                                >
                                    <List className="w-4 h-4" />
                                </button>
                            </>
                        )}
                        <button
                            onClick={onClose}
                            className="p-1.5 rounded-md text-neutral-400 hover:text-neutral-100 hover:bg-neutral-800 transition-colors"
                        >
                            <X className="w-5 h-5" />
                        </button>
                    </div>
                </div>

                {/* Main Content */}
                <div className="flex-1 overflow-hidden flex flex-col">
                    {croppingAsset ? (
                        <div className="flex-1 p-6 overflow-hidden">
                            <ImageCropper
                                src={croppingAsset.public_url}
                                onCropComplete={handleCropComplete}
                                onCancel={() => setCroppingAsset(null)}
                                onSkip={handleSkipCrop}
                            />
                        </div>
                    ) : (
                        <div className="p-6 space-y-4 overflow-y-auto">
                            {/* Breadcrumb Navigation */}
                            <div className="flex items-center gap-1 text-sm flex-wrap">
                                <button
                                    onClick={navigateToRoot}
                                    className={cn(
                                        "flex items-center gap-1 px-2 py-1 rounded-md transition-colors",
                                        currentFolder
                                            ? "text-neutral-400 hover:text-amber-400 hover:bg-neutral-800"
                                            : "text-amber-400 bg-neutral-800/50",
                                    )}
                                >
                                    <Home className="w-3.5 h-3.5" />
                                    All Assets
                                </button>
                                {breadcrumbParts.map((part, i) => (
                                    <div key={i} className="flex items-center gap-1">
                                        <ChevronRight className="w-3.5 h-3.5 text-neutral-600" />
                                        <button
                                            onClick={() => navigateToBreadcrumb(i)}
                                            className={cn(
                                                "px-2 py-1 rounded-md transition-colors",
                                                i === breadcrumbParts.length - 1
                                                    ? "text-amber-400 bg-neutral-800/50"
                                                    : "text-neutral-400 hover:text-amber-400 hover:bg-neutral-800",
                                            )}
                                        >
                                            {part}
                                        </button>
                                    </div>
                                ))}
                            </div>

                            {/* Upload Zone + New Folder */}
                            <div className="flex gap-3">
                                <div
                                    onDragOver={handleDragOver}
                                    onDragLeave={handleDragLeave}
                                    onDrop={handleDrop}
                                    onClick={() => document.getElementById("file-upload")?.click()}
                                    className={cn(
                                        "flex-1 flex items-center justify-center gap-3 py-6 rounded-lg border-2 border-dashed transition-colors cursor-pointer",
                                        isDragOver
                                            ? "border-amber-500 bg-amber-500/5"
                                            : "border-neutral-700 hover:border-amber-500 hover:bg-amber-500/5",
                                    )}
                                >
                                    <input
                                        id="file-upload"
                                        type="file"
                                        accept="image/*"
                                        className="hidden"
                                        onChange={handleFileSelect}
                                    />
                                    {uploading ? (
                                        <Loader2 className="w-6 h-6 text-amber-500 animate-spin" />
                                    ) : (
                                        <Upload className={cn("w-6 h-6", isDragOver ? "text-amber-500" : "text-neutral-500")} />
                                    )}
                                    <p className="text-sm text-neutral-400">
                                        {uploading ? (
                                            "Uploading..."
                                        ) : (
                                            <>
                                                Drop or <span className="text-amber-500 font-medium">upload</span>
                                            </>
                                        )}
                                    </p>
                                </div>
                                <button
                                    onClick={() => setCreatingFolder(true)}
                                    className="flex flex-col items-center justify-center gap-1.5 px-5 py-6 rounded-lg border-2 border-dashed border-neutral-700 hover:border-amber-500 hover:bg-amber-500/5 transition-colors"
                                    title="New Folder"
                                >
                                    <FolderPlus className="w-6 h-6 text-neutral-500" />
                                    <span className="text-xs text-neutral-400">New Folder</span>
                                </button>
                            </div>

                            {/* Inline New Folder Input */}
                            {creatingFolder && (
                                <div className="flex items-center gap-2 px-3 py-2 rounded-lg bg-neutral-900 border border-neutral-700">
                                    <Folder className="w-4 h-4 text-amber-500 flex-shrink-0" />
                                    <input
                                        autoFocus
                                        value={newFolderName}
                                        onChange={(e) => setNewFolderName(e.target.value)}
                                        onKeyDown={(e) => {
                                            if (e.key === "Enter") handleCreateFolder()
                                            if (e.key === "Escape") {
                                                setCreatingFolder(false)
                                                setNewFolderName("")
                                            }
                                        }}
                                        placeholder="Folder name..."
                                        className="flex-1 bg-transparent text-sm text-neutral-100 outline-none placeholder:text-neutral-500"
                                    />
                                    <button
                                        onClick={handleCreateFolder}
                                        disabled={!newFolderName.trim() || creatingFolderLoading}
                                        className="px-3 py-1 text-xs font-medium rounded bg-amber-500 text-black hover:bg-amber-400 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                                    >
                                        {creatingFolderLoading ? <Loader2 className="w-3 h-3 animate-spin" /> : "Create"}
                                    </button>
                                    <button
                                        onClick={() => {
                                            setCreatingFolder(false)
                                            setNewFolderName("")
                                        }}
                                        className="p-1 text-neutral-400 hover:text-neutral-100 transition-colors"
                                    >
                                        <X className="w-3.5 h-3.5" />
                                    </button>
                                </div>
                            )}

                            {/* Select All Bar (when assets exist) */}
                            {assets.length > 0 && (
                                <div className="flex items-center gap-2">
                                    <button
                                        onClick={selectAll}
                                        className="flex items-center gap-1.5 px-2 py-1 text-xs rounded-md text-neutral-400 hover:text-neutral-100 hover:bg-neutral-800 transition-colors"
                                    >
                                        {multiSelectedIds.size === assets.length ? (
                                            <CheckSquare className="w-3.5 h-3.5 text-amber-500" />
                                        ) : (
                                            <Square className="w-3.5 h-3.5" />
                                        )}
                                        {multiSelectedIds.size === assets.length ? "Deselect All" : "Select All"}
                                    </button>
                                    {isMultiSelectMode && (
                                        <span className="text-xs text-amber-400">
                                            {multiSelectedIds.size} selected
                                        </span>
                                    )}
                                </div>
                            )}

                            {/* Content Area */}
                            <div className="max-h-[400px] overflow-y-auto pr-2 scrollbar-thin scrollbar-thumb-neutral-700 scrollbar-track-transparent">
                                {loading ? (
                                    <div className="flex justify-center py-12">
                                        <Loader2 className="w-8 h-8 text-neutral-500 animate-spin" />
                                    </div>
                                ) : folders.length === 0 && assets.length === 0 ? (
                                    <div className="flex flex-col items-center justify-center py-16 text-center">
                                        <ImageIcon className="w-12 h-12 text-neutral-600 mb-3" />
                                        <p className="text-neutral-500">
                                            {currentFolder ? "This folder is empty." : "No assets found. Upload one to get started."}
                                        </p>
                                    </div>
                                ) : viewMode === "grid" ? (
                                    /* ─── Grid View ─── */
                                    <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
                                        {/* Folders first */}
                                        {folders.map((folder) => (
                                            <button
                                                key={`folder-${folder.name}`}
                                                onClick={() => navigateToFolder(folder.name)}
                                                onDragOver={(e) => handleFolderDragOver(e, folder.name)}
                                                onDragLeave={handleFolderDragLeave}
                                                onDrop={(e) => handleFolderDrop(e, folder.name)}
                                                className={cn(
                                                    "group relative aspect-square rounded-md overflow-hidden bg-neutral-900 border-2 transition-all flex flex-col items-center justify-center gap-2",
                                                    dropTargetFolder === folder.name
                                                        ? "border-amber-500 bg-amber-500/10 scale-105"
                                                        : "border-transparent hover:border-amber-500/50",
                                                )}
                                            >
                                                <Folder className={cn("w-10 h-10", dropTargetFolder === folder.name ? "text-amber-500" : "text-amber-500/70")} />
                                                <p className="text-xs text-neutral-300 truncate px-2 max-w-full">{folder.name}</p>
                                                {/* Delete folder button */}
                                                <button
                                                    onClick={(e) => handleDeleteFolder(e, folder.name)}
                                                    disabled={deleting === folder.name}
                                                    className="absolute top-2 left-2 w-6 h-6 rounded-full bg-red-600 hover:bg-red-500 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity disabled:opacity-50"
                                                    title="Delete folder"
                                                >
                                                    {deleting === folder.name ? (
                                                        <Loader2 className="w-3 h-3 text-white animate-spin" />
                                                    ) : (
                                                        <Trash2 className="w-3 h-3 text-white" />
                                                    )}
                                                </button>
                                            </button>
                                        ))}

                                        {/* Image assets */}
                                        {assets.map((asset) => {
                                            const isMultiSelected = multiSelectedIds.has(asset.id)
                                            return (
                                                <button
                                                    key={asset.id}
                                                    draggable={!isMultiSelectMode}
                                                    onDragStart={(e) => handleAssetDragStart(e, asset)}
                                                    onDragEnd={handleAssetDragEnd}
                                                    onClick={(e) => handleAssetClick(asset, e)}
                                                    className={cn(
                                                        "group relative aspect-square rounded-md overflow-hidden bg-neutral-900 border-2 transition-all",
                                                        isMultiSelectMode ? "cursor-pointer" : "cursor-grab active:cursor-grabbing",
                                                        isMultiSelected
                                                            ? "border-amber-500 ring-2 ring-amber-500/30"
                                                            : selectedAsset?.id === asset.id && !isMultiSelectMode
                                                                ? "border-amber-500 ring-2 ring-amber-500/30"
                                                                : "border-transparent hover:border-neutral-600",
                                                        movingAsset === asset.id && "opacity-40",
                                                    )}
                                                >
                                                    <img
                                                        src={asset.public_url || "/placeholder.svg"}
                                                        alt={asset.filename}
                                                        loading="lazy"
                                                        className="w-full h-full object-cover"
                                                    />
                                                    <div className="absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/80 to-transparent px-2 py-2">
                                                        <p className="text-xs text-neutral-300 truncate">{asset.filename}</p>
                                                    </div>
                                                    {/* Multi-select checkbox */}
                                                    <button
                                                        onClick={(e) => toggleMultiSelect(asset.id, e)}
                                                        className={cn(
                                                            "absolute top-2 right-2 w-5 h-5 rounded flex items-center justify-center transition-all",
                                                            isMultiSelected
                                                                ? "bg-amber-500"
                                                                : "bg-black/50 border border-neutral-500 opacity-0 group-hover:opacity-100",
                                                        )}
                                                    >
                                                        {isMultiSelected && (
                                                            <svg className="w-3 h-3 text-black" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" />
                                                            </svg>
                                                        )}
                                                    </button>
                                                    {/* Single delete */}
                                                    {!isMultiSelectMode && (
                                                        <button
                                                            onClick={(e) => handleDeleteAsset(e, asset)}
                                                            disabled={deleting === asset.id}
                                                            className="absolute top-2 left-2 w-6 h-6 rounded-full bg-red-600 hover:bg-red-500 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity disabled:opacity-50"
                                                            title="Delete asset"
                                                        >
                                                            {deleting === asset.id ? (
                                                                <Loader2 className="w-3 h-3 text-white animate-spin" />
                                                            ) : (
                                                                <Trash2 className="w-3 h-3 text-white" />
                                                            )}
                                                        </button>
                                                    )}
                                                    {/* Single select indicator */}
                                                    {!isMultiSelectMode && selectedAsset?.id === asset.id && (
                                                        <div className="absolute top-2 right-2 w-5 h-5 rounded-full bg-amber-500 flex items-center justify-center">
                                                            <svg
                                                                className="w-3 h-3 text-black"
                                                                fill="none"
                                                                viewBox="0 0 24 24"
                                                                stroke="currentColor"
                                                            >
                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" />
                                                            </svg>
                                                        </div>
                                                    )}
                                                </button>
                                            )
                                        })}
                                    </div>
                                ) : (
                                    /* ─── List View ─── */
                                    <div className="space-y-1">
                                        {/* Folders first */}
                                        {folders.map((folder) => (
                                            <button
                                                key={`folder-${folder.name}`}
                                                onClick={() => navigateToFolder(folder.name)}
                                                onDragOver={(e) => handleFolderDragOver(e, folder.name)}
                                                onDragLeave={handleFolderDragLeave}
                                                onDrop={(e) => handleFolderDrop(e, folder.name)}
                                                className={cn(
                                                    "group w-full flex items-center gap-3 px-3 py-2.5 rounded-md transition-colors text-left",
                                                    dropTargetFolder === folder.name
                                                        ? "bg-amber-500/10 ring-1 ring-amber-500/50"
                                                        : "hover:bg-neutral-800/70",
                                                )}
                                            >
                                                <Folder className={cn("w-5 h-5 flex-shrink-0", dropTargetFolder === folder.name ? "text-amber-500" : "text-amber-500/70")} />
                                                <span className="flex-1 text-sm text-neutral-200 truncate">{folder.name}</span>
                                                <button
                                                    onClick={(e) => handleDeleteFolder(e, folder.name)}
                                                    disabled={deleting === folder.name}
                                                    className="p-1 rounded text-neutral-500 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-all disabled:opacity-50"
                                                    title="Delete folder"
                                                >
                                                    {deleting === folder.name ? (
                                                        <Loader2 className="w-3.5 h-3.5 animate-spin" />
                                                    ) : (
                                                        <Trash2 className="w-3.5 h-3.5" />
                                                    )}
                                                </button>
                                                <ChevronRight className="w-4 h-4 text-neutral-600 flex-shrink-0" />
                                            </button>
                                        ))}

                                        {/* Image assets */}
                                        {assets.map((asset) => {
                                            const isMultiSelected = multiSelectedIds.has(asset.id)
                                            return (
                                                <button
                                                    key={asset.id}
                                                    draggable={!isMultiSelectMode}
                                                    onDragStart={(e) => handleAssetDragStart(e, asset)}
                                                    onDragEnd={handleAssetDragEnd}
                                                    onClick={(e) => handleAssetClick(asset, e)}
                                                    className={cn(
                                                        "group w-full flex items-center gap-3 px-3 py-2 rounded-md transition-colors text-left",
                                                        isMultiSelectMode ? "cursor-pointer" : "cursor-grab active:cursor-grabbing",
                                                        isMultiSelected
                                                            ? "bg-amber-500/10 ring-1 ring-amber-500/30"
                                                            : selectedAsset?.id === asset.id && !isMultiSelectMode
                                                                ? "bg-amber-500/10 ring-1 ring-amber-500/30"
                                                                : "hover:bg-neutral-800/70",
                                                        movingAsset === asset.id && "opacity-40",
                                                    )}
                                                >
                                                    {/* Checkbox */}
                                                    <button
                                                        onClick={(e) => toggleMultiSelect(asset.id, e)}
                                                        className={cn(
                                                            "w-4 h-4 rounded flex items-center justify-center flex-shrink-0 transition-all",
                                                            isMultiSelected
                                                                ? "bg-amber-500"
                                                                : "border border-neutral-600 opacity-0 group-hover:opacity-100",
                                                        )}
                                                    >
                                                        {isMultiSelected && (
                                                            <svg className="w-3 h-3 text-black" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" />
                                                            </svg>
                                                        )}
                                                    </button>
                                                    <div className="w-12 h-12 rounded overflow-hidden bg-neutral-900 flex-shrink-0">
                                                        <img
                                                            src={asset.public_url || "/placeholder.svg"}
                                                            alt={asset.filename}
                                                            loading="lazy"
                                                            className="w-full h-full object-cover"
                                                        />
                                                    </div>
                                                    <div className="flex-1 min-w-0">
                                                        <p className="text-sm text-neutral-200 truncate">{asset.filename}</p>
                                                        <p className="text-xs text-neutral-500">{formatFileSize(asset.size)}</p>
                                                    </div>
                                                    {!isMultiSelectMode && (
                                                        <button
                                                            onClick={(e) => handleDeleteAsset(e, asset)}
                                                            disabled={deleting === asset.id}
                                                            className="p-1 rounded text-neutral-500 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-all disabled:opacity-50"
                                                            title="Delete asset"
                                                        >
                                                            {deleting === asset.id ? (
                                                                <Loader2 className="w-3.5 h-3.5 animate-spin" />
                                                            ) : (
                                                                <Trash2 className="w-3.5 h-3.5" />
                                                            )}
                                                        </button>
                                                    )}
                                                    {!isMultiSelectMode && selectedAsset?.id === asset.id && (
                                                        <div className="w-5 h-5 rounded-full bg-amber-500 flex items-center justify-center flex-shrink-0">
                                                            <svg
                                                                className="w-3 h-3 text-black"
                                                                fill="none"
                                                                viewBox="0 0 24 24"
                                                                stroke="currentColor"
                                                            >
                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" />
                                                            </svg>
                                                        </div>
                                                    )}
                                                </button>
                                            )
                                        })}
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                </div>

                {/* Footer */}
                {!croppingAsset && (
                    <div className="flex items-center justify-between px-6 py-4 border-t border-neutral-800 flex-shrink-0">
                        <p className="text-sm text-neutral-500">
                            {folders.length > 0 && `${folders.length} folder${folders.length !== 1 ? "s" : ""}, `}
                            {assets.length} asset{assets.length !== 1 ? "s" : ""}
                        </p>
                        <div className="flex items-center gap-2">
                            {isMultiSelectMode ? (
                                /* ─── Bulk Actions ─── */
                                <>
                                    <button
                                        onClick={() => setMultiSelectedIds(new Set())}
                                        className="px-3 py-2 text-sm font-medium text-neutral-300 hover:text-neutral-100 hover:bg-neutral-800 rounded-md transition-colors"
                                    >
                                        Cancel ({multiSelectedIds.size})
                                    </button>
                                    <button
                                        onClick={openMoveDialog}
                                        disabled={bulkMoving}
                                        className="flex items-center gap-1.5 px-3 py-2 text-sm font-medium rounded-md bg-neutral-700 text-neutral-100 hover:bg-neutral-600 disabled:opacity-50 transition-colors"
                                    >
                                        <FolderInput className="w-3.5 h-3.5" />
                                        Move to Folder
                                    </button>
                                    <button
                                        onClick={handleBulkDelete}
                                        disabled={bulkDeleting}
                                        className="flex items-center gap-1.5 px-3 py-2 text-sm font-medium rounded-md bg-red-600 text-white hover:bg-red-500 disabled:opacity-50 transition-colors"
                                    >
                                        {bulkDeleting ? (
                                            <Loader2 className="w-3.5 h-3.5 animate-spin" />
                                        ) : (
                                            <Trash2 className="w-3.5 h-3.5" />
                                        )}
                                        Delete ({multiSelectedIds.size})
                                    </button>
                                </>
                            ) : (
                                /* ─── Normal Actions ─── */
                                <>
                                    <button
                                        onClick={onClose}
                                        className="px-4 py-2 text-sm font-medium text-neutral-300 hover:text-neutral-100 hover:bg-neutral-800 rounded-md transition-colors"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onClick={handleSelect}
                                        disabled={!selectedAsset}
                                        className={cn(
                                            "px-4 py-2 text-sm font-medium rounded-md transition-colors",
                                            selectedAsset
                                                ? "bg-amber-500 text-black hover:bg-amber-400"
                                                : "bg-neutral-700 text-neutral-500 cursor-not-allowed",
                                        )}
                                    >
                                        Select & Adjust
                                    </button>
                                </>
                            )}
                        </div>
                    </div>
                )}
            </div>

            {/* ─── Move to Folder Dialog ─── */}
            {showMoveDialog && (
                <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/60">
                    <div className="w-full max-w-sm mx-4 rounded-lg bg-[#1a1a1a] border border-neutral-700 shadow-2xl overflow-hidden">
                        <div className="flex items-center justify-between px-5 py-3 border-b border-neutral-700">
                            <h4 className="text-sm font-medium text-neutral-100">
                                Move {multiSelectedIds.size} asset{multiSelectedIds.size > 1 ? "s" : ""} to…
                            </h4>
                            <button
                                onClick={() => setShowMoveDialog(false)}
                                className="p-1 text-neutral-400 hover:text-neutral-100 transition-colors"
                            >
                                <X className="w-4 h-4" />
                            </button>
                        </div>
                        <div className="p-3 max-h-[300px] overflow-y-auto space-y-1">
                            {currentFolder && (
                                <button
                                    onClick={() => handleBulkMoveToFolder("")}
                                    disabled={bulkMoving}
                                    className="w-full flex items-center gap-3 px-3 py-2.5 rounded-md hover:bg-neutral-800 transition-colors text-left disabled:opacity-50"
                                >
                                    <Home className="w-4 h-4 text-amber-500/70" />
                                    <span className="text-sm text-neutral-200">Root (All Assets)</span>
                                </button>
                            )}
                            {moveTargetFolders.length === 0 && !currentFolder ? (
                                <p className="text-sm text-neutral-500 text-center py-6">No folders available. Create one first.</p>
                            ) : (
                                moveTargetFolders.map((folder) => (
                                    <button
                                        key={folder}
                                        onClick={() => handleBulkMoveToFolder(folder)}
                                        disabled={bulkMoving}
                                        className="w-full flex items-center gap-3 px-3 py-2.5 rounded-md hover:bg-neutral-800 transition-colors text-left disabled:opacity-50"
                                    >
                                        {bulkMoving ? (
                                            <Loader2 className="w-4 h-4 text-amber-500 animate-spin" />
                                        ) : (
                                            <Folder className="w-4 h-4 text-amber-500/70" />
                                        )}
                                        <span className="text-sm text-neutral-200">{folder}</span>
                                    </button>
                                ))
                            )}
                        </div>
                    </div>
                </div>
            )}
        </div>
    )
}
</file>

<file path="components/editor/block-manager.tsx">
"use client"

import { ArrowUp, ArrowDown, Plus, Trash2, Edit2, GripVertical, Layers } from "lucide-react"
import { Button } from "@/components/ui/button"
import { ScrollArea } from "@/components/ui/scroll-area"
import { cn } from "@/lib/utils"
import { useState } from "react"

export interface Block {
    id: string
    name: string
    content: string
}

interface BlockManagerProps {
    blocks: Block[]
    activeBlockId: string | null
    onSelectBlock: (id: string) => void
    onUpdateBlocks: (blocks: Block[]) => void
    onAddBlock: () => void
}

export function BlockManager({ blocks, activeBlockId, onSelectBlock, onUpdateBlocks, onAddBlock }: BlockManagerProps) {
    const [editingId, setEditingId] = useState<string | null>(null)
    const [editName, setEditName] = useState("")
    const [draggedIndex, setDraggedIndex] = useState<number | null>(null)

    const moveBlock = (index: number, direction: -1 | 1, e: React.MouseEvent) => {
        e.stopPropagation()
        const newBlocks = [...blocks]
        if (direction === -1 && index > 0) {
            [newBlocks[index], newBlocks[index - 1]] = [newBlocks[index - 1], newBlocks[index]]
        } else if (direction === 1 && index < newBlocks.length - 1) {
            [newBlocks[index], newBlocks[index + 1]] = [newBlocks[index + 1], newBlocks[index]]
        }
        onUpdateBlocks(newBlocks)
    }

    const deleteBlock = (id: string, e: React.MouseEvent) => {
        e.stopPropagation()
        if (confirm("Delete this block?")) {
            const newBlocks = blocks.filter(b => b.id !== id)
            onUpdateBlocks(newBlocks)
            if (activeBlockId === id && newBlocks.length > 0) onSelectBlock(newBlocks[0].id)
        }
    }

    const startRenaming = (block: Block, e: React.MouseEvent) => {
        e.stopPropagation()
        setEditingId(block.id)
        setEditName(block.name)
    }

    const saveName = () => {
        if (editingId) {
            const newBlocks = blocks.map(b => b.id === editingId ? { ...b, name: editName } : b)
            onUpdateBlocks(newBlocks)
            setEditingId(null)
        }
    }

    // --- DnD HANDLERS ---
    const handleDragStart = (e: React.DragEvent, index: number) => {
        setDraggedIndex(index)
        e.dataTransfer.effectAllowed = "move"
        // Transparent image or simple ref logic could be used here for preview
        // check browser default behavior
    }

    const handleDragOver = (e: React.DragEvent, index: number) => {
        e.preventDefault() // Necessary for onDrop to fire
        e.dataTransfer.dropEffect = "move"
    }

    const handleDrop = (e: React.DragEvent, dropIndex: number) => {
        e.preventDefault()
        if (draggedIndex === null || draggedIndex === dropIndex) return

        const newBlocks = [...blocks]
        const [movedItem] = newBlocks.splice(draggedIndex, 1)
        newBlocks.splice(dropIndex, 0, movedItem)

        onUpdateBlocks(newBlocks)
        setDraggedIndex(null)
    }

    return (
        <div className="flex flex-col h-full bg-card w-full">
            <div className="p-4 border-b border-border flex items-center justify-between">
                <div className="flex items-center gap-2 font-semibold text-sm">
                    <Layers className="w-4 h-4 text-muted-foreground" />
                    <span>Layout Blocks</span>
                </div>
                <Button size="sm" variant="ghost" onClick={onAddBlock} className="h-8 w-8 p-0">
                    <Plus className="w-4 h-4" />
                </Button>
            </div>

            <ScrollArea className="flex-1">
                <div className="p-2 space-y-1">
                    {blocks.map((block, index) => (
                        <div
                            key={block.id}
                            draggable
                            onDragStart={(e) => handleDragStart(e, index)}
                            onDragOver={(e) => handleDragOver(e, index)}
                            onDrop={(e) => handleDrop(e, index)}
                            onClick={() => onSelectBlock(block.id)}
                            className={cn(
                                "group flex items-center gap-2 p-2 rounded-md text-sm cursor-pointer border transition-all",
                                activeBlockId === block.id
                                    ? "bg-primary/10 border-primary/50 text-primary font-medium"
                                    : "bg-transparent border-transparent hover:bg-muted text-muted-foreground",
                                draggedIndex === index && "opacity-50 border-dashed border-primary"
                            )}
                        >
                            <GripVertical className="w-4 h-4 opacity-20 group-hover:opacity-100 transition-opacity cursor-grab active:cursor-grabbing" />

                            {editingId === block.id ? (
                                <input
                                    className="flex-1 bg-background border rounded px-1 min-w-0"
                                    value={editName}
                                    onChange={(e) => setEditName(e.target.value)}
                                    onBlur={saveName}
                                    onKeyDown={(e) => e.key === 'Enter' && saveName()}
                                    autoFocus
                                    onClick={(e) => e.stopPropagation()}
                                />
                            ) : (
                                <span className="flex-1 truncate select-none">{block.name}</span>
                            )}

                            <div className="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button onClick={(e) => startRenaming(block, e)} className="p-1 hover:text-foreground">
                                    <Edit2 className="w-3 h-3" />
                                </button>
                                <button onClick={(e) => moveBlock(index, -1, e)} className="p-1 hover:text-foreground" disabled={index === 0}>
                                    <ArrowUp className="w-3 h-3" />
                                </button>
                                <button onClick={(e) => moveBlock(index, 1, e)} className="p-1 hover:text-foreground" disabled={index === blocks.length - 1}>
                                    <ArrowDown className="w-3 h-3" />
                                </button>
                                <button onClick={(e) => deleteBlock(block.id, e)} className="p-1 hover:text-red-500">
                                    <Trash2 className="w-3 h-3" />
                                </button>
                            </div>
                        </div>
                    ))}
                </div>
            </ScrollArea>
        </div>
    )
}
</file>

<file path="components/editor/code-pane.tsx">
"use client"

import { Code } from "lucide-react"

interface CodePaneProps {
    code: string
    onChange: (code: string) => void
    className?: string
}

export function CodePane({ code, onChange, className }: CodePaneProps) {
    return (
        <div className={`flex flex-col border-r border-border bg-card ${className || "flex-1"}`}>
            <div className="p-4 border-b border-border flex items-center justify-between">
                <h2 className="text-sm font-semibold text-foreground flex items-center gap-2">
                    <Code className="w-4 h-4" />
                    HTML Editor
                </h2>
                <span className="text-xs text-muted-foreground font-mono">index.html</span>
            </div>
            <div className="flex-1 p-0 relative">
                <textarea
                    value={code}
                    onChange={(e) => onChange(e.target.value)}
                    className="absolute inset-0 w-full h-full p-4 bg-[#1e1e1e] text-[#d4d4d4] font-mono text-sm resize-none focus:outline-none leading-relaxed"
                    spellCheck={false}
                    placeholder="Write your HTML here..."
                />
            </div>
        </div>
    )
}
</file>

<file path="components/editor/history-sheet.tsx">
"use client"

import { useEffect, useState } from "react"
import { getVersions } from "@/app/actions/versions"
import { Sheet, SheetContent, SheetHeader, SheetTitle, SheetTrigger, SheetDescription } from "@/components/ui/sheet"
import { Button } from "@/components/ui/button"
import { History, Clock, RotateCcw } from "lucide-react"
import { formatDistanceToNow } from "date-fns"

interface Version {
    id: string
    created_at: string
    prompt: string
    html_content: string
}

interface HistorySheetProps {
    campaignId: string | null
    onRestore: (html: string) => void
}

export function HistorySheet({ campaignId, onRestore }: HistorySheetProps) {
    const [versions, setVersions] = useState<Version[]>([])
    const [open, setOpen] = useState(false)
    const [loading, setLoading] = useState(false)

    const loadVersions = async () => {
        if (!campaignId) return
        setLoading(true)
        try {
            const data = await getVersions(campaignId)
            if (data) setVersions(data)
        } catch (e) {
            console.error(e)
        } finally {
            setLoading(false)
        }
    }

    // Load when sheet opens
    useEffect(() => {
        if (open) loadVersions()
    }, [open, campaignId])

    return (
        <Sheet open={open} onOpenChange={setOpen}>
            <SheetTrigger asChild>
                <Button variant="ghost" size="icon" title="Version History">
                    <History className="w-4 h-4" />
                </Button>
            </SheetTrigger>
            <SheetContent className="w-[400px] gap-4 flex flex-col">
                <SheetHeader>
                    <SheetTitle>Version History</SheetTitle>
                    <SheetDescription>
                        Showing saved points for this campaign.
                    </SheetDescription>
                </SheetHeader>

                <div className="flex-1 overflow-y-auto space-y-4 py-4 pr-2">
                    {loading && <div className="text-center text-sm text-muted-foreground">Loading...</div>}

                    {!loading && versions.length === 0 && (
                        <div className="text-center text-sm text-muted-foreground p-4 border border-dashed rounded-lg">
                            No history found yet.
                        </div>
                    )}

                    {versions.map((v) => (
                        <div key={v.id} className="group flex flex-col gap-2 p-3 border rounded-lg hover:bg-muted/50 transition-colors">
                            <div className="flex items-center justify-between">
                                <span className="text-xs font-medium text-muted-foreground flex items-center gap-1">
                                    <Clock className="w-3 h-3" />
                                    {formatDistanceToNow(new Date(v.created_at), { addSuffix: true })}
                                </span>
                                <Button
                                    size="sm"
                                    variant="secondary"
                                    className="h-6 text-xs opacity-0 group-hover:opacity-100 transition-opacity"
                                    onClick={() => {
                                        onRestore(v.html_content)
                                        setOpen(false)
                                    }}
                                >
                                    <RotateCcw className="w-3 h-3 mr-1" />
                                    Restore
                                </Button>
                            </div>
                            <p className="text-sm line-clamp-2 font-medium">
                                {v.prompt ? `"${v.prompt}"` : "Manual Save"}
                            </p>
                        </div>
                    ))}
                </div>
            </SheetContent>
        </Sheet>
    )
}
</file>

<file path="components/editor/image-cropper.tsx">
"use client"

import React, { useState, useRef, useEffect } from 'react'
import ReactCrop, { type Crop, type PixelCrop, centerCrop, makeAspectCrop } from 'react-image-crop'
import 'react-image-crop/dist/ReactCrop.css'
import { Button } from "@/components/ui/button"
import { Loader2, Check, X, RotateCcw } from "lucide-react"

// --- HELPER: CENTER ASPECT CROP ---
function centerAspectCrop(mediaWidth: number, mediaHeight: number, aspect: number) {
    return centerCrop(
        makeAspectCrop(
            {
                unit: '%',
                width: 90,
            },
            aspect,
            mediaWidth,
            mediaHeight,
        ),
        mediaWidth,
        mediaHeight,
    )
}

interface ImageCropperProps {
    src: string
    onCropComplete: (croppedBlob: Blob) => void
    onCancel: () => void
    onSkip?: () => void
    initialAspect?: number // Optional: lock aspect ratio if needed (e.g., 16/9)
}

export function ImageCropper({ src, onCropComplete, onCancel, onSkip, initialAspect }: ImageCropperProps) {
    const [crop, setCrop] = useState<Crop>()
    const [completedCrop, setCompletedCrop] = useState<PixelCrop>()
    const [aspect, setAspect] = useState<number | undefined>(initialAspect)
    const imgRef = useRef<HTMLImageElement>(null)
    const [isProcessing, setIsProcessing] = useState(false)

    const onImageLoad = (e: React.SyntheticEvent<HTMLImageElement>) => {
        const { width, height } = e.currentTarget

        // Default to whole image if no aspect
        if (aspect) {
            setCrop(centerAspectCrop(width, height, aspect))
        } else {
            setCrop({
                unit: '%',
                width: 100,
                height: 100,
                x: 0,
                y: 0
            })
        }
    }

    const getCroppedImg = async (image: HTMLImageElement, crop: PixelCrop): Promise<Blob> => {
        const canvas = document.createElement('canvas')
        const scaleX = image.naturalWidth / image.width
        const scaleY = image.naturalHeight / image.height

        canvas.width = crop.width * scaleX
        canvas.height = crop.height * scaleY

        const ctx = canvas.getContext('2d')

        if (!ctx) {
            throw new Error('No 2d context')
        }

        // Quality improvement
        ctx.imageSmoothingQuality = 'high'

        ctx.drawImage(
            image,
            crop.x * scaleX,
            crop.y * scaleY,
            crop.width * scaleX,
            crop.height * scaleY,
            0,
            0,
            crop.width * scaleX,
            crop.height * scaleY,
        )

        return new Promise((resolve, reject) => {
            canvas.toBlob(
                (blob) => {
                    if (!blob) {
                        reject(new Error('Canvas is empty'))
                        return
                    }
                    resolve(blob)
                },
                'image/jpeg',
                0.9 // High quality
            )
        })
    }

    const handleSave = async () => {
        if (!completedCrop || !imgRef.current) return

        setIsProcessing(true)
        try {
            // If crop covers the whole image (approx), just use original? 
            // Actually, better to always re-process to ensure consistent behavior, 
            // unless user explicitly hit "Skip". 
            // But here we are in "Crop" mode, so we crop.

            const blob = await getCroppedImg(imgRef.current, completedCrop)
            onCropComplete(blob)
        } catch (e) {
            console.error(e)
            setIsProcessing(false)
        }
    }

    return (
        <div className="flex flex-col h-full bg-black/90 text-white rounded-lg overflow-hidden">
            <div className="flex-1 flex items-center justify-center p-8 overflow-auto min-h-[300px]">
                <ReactCrop
                    crop={crop}
                    onChange={(_, percentCrop) => setCrop(percentCrop)}
                    onComplete={(c) => setCompletedCrop(c)}
                    aspect={aspect}
                    className="max-h-[60vh]"
                >
                    <img
                        ref={imgRef}
                        alt="Crop me"
                        src={src}
                        onLoad={onImageLoad}
                        style={{ maxHeight: '60vh', objectFit: 'contain' }}
                        crossOrigin="anonymous" // Important for CORS if assets are external
                    />
                </ReactCrop>
            </div>

            <div className="p-4 border-t border-white/10 flex items-center justify-between bg-zinc-900">
                <div className="flex gap-2">
                    <Button
                        variant="ghost"
                        size="sm"
                        onClick={() => setAspect(undefined)}
                        className={!aspect ? "bg-white/10" : ""}
                    >
                        Free
                    </Button>
                    <Button
                        variant="ghost"
                        size="sm"
                        onClick={() => setAspect(1)}
                        className={aspect === 1 ? "bg-white/10" : ""}
                    >
                        Square
                    </Button>
                    <Button
                        variant="ghost"
                        size="sm"
                        onClick={() => setAspect(16 / 9)}
                        className={aspect === 16 / 9 ? "bg-white/10" : ""}
                    >
                        16:9
                    </Button>
                </div>

                <div className="flex items-center gap-2">
                    <Button variant="outline" onClick={onCancel} disabled={isProcessing}>
                        <X className="w-4 h-4 mr-2" />
                        Cancel
                    </Button>
                    {onSkip && (
                        <Button variant="secondary" onClick={onSkip} disabled={isProcessing}>
                            Use as is
                        </Button>
                    )}
                    <Button onClick={handleSave} disabled={isProcessing || !completedCrop?.width}>
                        {isProcessing ? <Loader2 className="w-4 h-4 animate-spin mr-2" /> : <Check className="w-4 h-4 mr-2" />}
                        Save Crop
                    </Button>
                </div>
            </div>
        </div>
    )
}
</file>

<file path="components/editor/preview-pane.tsx">
"use client"

import { useEffect, useRef, useState } from "react"

interface PreviewPaneProps {
    html: string
    viewMode?: 'desktop' | 'mobile'
}

export function PreviewPane({ html, viewMode = 'desktop' }: PreviewPaneProps) {
    const iframeRef = useRef<HTMLIFrameElement>(null)
    const [height, setHeight] = useState(800) // Default start height

    // Inject content and resize
    useEffect(() => {
        if (iframeRef.current) {
            const doc = iframeRef.current.contentDocument
            if (doc) {
                doc.open()

                // ⚡️ INJECT FOOTER FOR PREVIEW ACCURACY
                const unsubscribeFooter = `
                    <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #e5e7eb; text-align: center; font-size: 12px; color: #6b7280; font-family: sans-serif;">
                    <p style="margin: 0;">
                        No longer want to receive these emails? 
                        <a href="#" style="color: #6b7280; text-decoration: underline;">Unsubscribe here</a>.
                    </p>
                    </div>
                `
                // Only add if not already present (prevent dups if re-injected by parent)
                const fullHtml = html.includes("Unsubscribe here") ? html : html + unsubscribeFooter

                doc.write(fullHtml)
                doc.close()

                // ⚡️ MAGIC FIX: Calculate the real height of the email content
                // We use a slight timeout to ensure images/fonts have started rendering
                setTimeout(() => {
                    if (doc.body) {
                        const newHeight = doc.body.scrollHeight + 50 // +50px buffer
                        setHeight(newHeight)
                    }
                }, 100)
            }
        }
    }, [html, viewMode])

    return (
        <div className="w-full h-full bg-white relative shadow-sm transition-all duration-300">
            <iframe
                ref={iframeRef}
                className="w-full border-0 transition-all duration-300"
                style={{ height: `${height}px` }} // ⚡️ Apply real pixel height
                title="Email Preview"
                sandbox="allow-same-origin allow-scripts"
            />
        </div>
    )
}
</file>

<file path="components/dashboard-header.tsx">
import { Bell, Search } from "lucide-react"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"

export function DashboardHeader() {
    return (
        <header className="sticky top-0 z-30 flex h-16 items-center justify-between border-b border-border bg-background/95 px-6 backdrop-blur supports-[backdrop-filter]:bg-background/60">
            <div className="flex items-center gap-4">
                <h1 className="text-xl font-semibold text-foreground">Dashboard</h1>
            </div>

            <div className="flex items-center gap-4">
                <div className="relative">
                    <Search className="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground" />
                    <Input placeholder="Search campaigns..." className="w-64 bg-muted pl-9" />
                </div>
                <Button variant="ghost" size="icon" className="relative">
                    <Bell className="h-5 w-5" />
                    <span className="absolute -right-1 -top-1 flex h-4 w-4 items-center justify-center rounded-full bg-primary text-[10px] font-bold text-primary-foreground">
                        3
                    </span>
                </Button>
            </div>
        </header>
    )
}
</file>

<file path="components/lock-screen.tsx">
"use client"

import { useState, useEffect } from "react"
import { Lock, Eye, EyeOff } from "lucide-react"

const STORAGE_KEY = "mb_dashboard_unlocked"
const PASSWORD = "sorenkier"

export function LockScreen({ children }: { children: React.ReactNode }) {
    const [unlocked, setUnlocked] = useState<boolean | null>(null) // null = loading
    const [password, setPassword] = useState("")
    const [showPassword, setShowPassword] = useState(false)
    const [error, setError] = useState(false)
    const [shake, setShake] = useState(false)

    useEffect(() => {
        setUnlocked(localStorage.getItem(STORAGE_KEY) === "true")
    }, [])

    const handleUnlock = (e: React.FormEvent) => {
        e.preventDefault()
        if (password === PASSWORD) {
            localStorage.setItem(STORAGE_KEY, "true")
            setUnlocked(true)
            setError(false)
        } else {
            setError(true)
            setShake(true)
            setTimeout(() => setShake(false), 500)
        }
    }

    // Loading state — prevent flash
    if (unlocked === null) {
        return <div className="min-h-screen bg-background" />
    }

    if (unlocked) {
        return <>{children}</>
    }

    return (
        <div className="min-h-screen bg-background flex items-center justify-center p-4">
            <div
                className={`w-full max-w-sm rounded-2xl border border-border bg-card p-8 shadow-2xl transition-transform ${shake ? "animate-shake" : ""}`}
            >
                {/* Lock Icon */}
                <div className="flex justify-center mb-6">
                    <div className="flex h-14 w-14 items-center justify-center rounded-full bg-amber-500/10 border border-amber-500/20">
                        <Lock className="h-6 w-6 text-amber-500" />
                    </div>
                </div>

                {/* Title */}
                <h1 className="text-xl font-bold text-center text-foreground mb-1">
                    Musical Basics
                </h1>
                <p className="text-sm text-muted-foreground text-center mb-6">
                    Enter password to continue
                </p>

                {/* Form */}
                <form onSubmit={handleUnlock} className="space-y-4">
                    <div className="relative">
                        <input
                            type={showPassword ? "text" : "password"}
                            value={password}
                            onChange={(e) => {
                                setPassword(e.target.value)
                                setError(false)
                            }}
                            placeholder="Password"
                            autoFocus
                            className={`w-full rounded-lg border bg-background px-4 py-3 pr-10 text-sm text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 transition-colors ${error
                                    ? "border-red-500 focus:ring-red-500/30"
                                    : "border-border focus:ring-amber-500/30"
                                }`}
                        />
                        <button
                            type="button"
                            onClick={() => setShowPassword(!showPassword)}
                            className="absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground transition-colors"
                        >
                            {showPassword ? <EyeOff className="h-4 w-4" /> : <Eye className="h-4 w-4" />}
                        </button>
                    </div>

                    {error && (
                        <p className="text-xs text-red-400 text-center">
                            Incorrect password. Try again.
                        </p>
                    )}

                    <button
                        type="submit"
                        className="w-full rounded-lg bg-amber-500 px-4 py-3 text-sm font-semibold text-zinc-900 hover:bg-amber-400 transition-colors"
                    >
                        Unlock Dashboard
                    </button>
                </form>
            </div>

            {/* Shake animation */}
            <style jsx>{`
                @keyframes shake {
                    0%, 100% { transform: translateX(0); }
                    20%, 60% { transform: translateX(-8px); }
                    40%, 80% { transform: translateX(8px); }
                }
                .animate-shake {
                    animation: shake 0.4s ease-in-out;
                }
            `}</style>
        </div>
    )
}
</file>

<file path="hooks/use-mobile.ts">
import * as React from 'react'

const MOBILE_BREAKPOINT = 768

export function useIsMobile() {
  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined)

  React.useEffect(() => {
    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)
    const onChange = () => {
      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)
    }
    mql.addEventListener('change', onChange)
    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)
    return () => mql.removeEventListener('change', onChange)
  }, [])

  return !!isMobile
}
</file>

<file path="hooks/use-toast.ts">
'use client'

// Inspired by react-hot-toast library
import * as React from 'react'

import type { ToastActionElement, ToastProps } from '@/components/ui/toast'

const TOAST_LIMIT = 1
const TOAST_REMOVE_DELAY = 1000000

type ToasterToast = ToastProps & {
  id: string
  title?: React.ReactNode
  description?: React.ReactNode
  action?: ToastActionElement
}

const actionTypes = {
  ADD_TOAST: 'ADD_TOAST',
  UPDATE_TOAST: 'UPDATE_TOAST',
  DISMISS_TOAST: 'DISMISS_TOAST',
  REMOVE_TOAST: 'REMOVE_TOAST',
} as const

let count = 0

function genId() {
  count = (count + 1) % Number.MAX_SAFE_INTEGER
  return count.toString()
}

type ActionType = typeof actionTypes

type Action =
  | {
      type: ActionType['ADD_TOAST']
      toast: ToasterToast
    }
  | {
      type: ActionType['UPDATE_TOAST']
      toast: Partial<ToasterToast>
    }
  | {
      type: ActionType['DISMISS_TOAST']
      toastId?: ToasterToast['id']
    }
  | {
      type: ActionType['REMOVE_TOAST']
      toastId?: ToasterToast['id']
    }

interface State {
  toasts: ToasterToast[]
}

const toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()

const addToRemoveQueue = (toastId: string) => {
  if (toastTimeouts.has(toastId)) {
    return
  }

  const timeout = setTimeout(() => {
    toastTimeouts.delete(toastId)
    dispatch({
      type: 'REMOVE_TOAST',
      toastId: toastId,
    })
  }, TOAST_REMOVE_DELAY)

  toastTimeouts.set(toastId, timeout)
}

export const reducer = (state: State, action: Action): State => {
  switch (action.type) {
    case 'ADD_TOAST':
      return {
        ...state,
        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),
      }

    case 'UPDATE_TOAST':
      return {
        ...state,
        toasts: state.toasts.map((t) =>
          t.id === action.toast.id ? { ...t, ...action.toast } : t,
        ),
      }

    case 'DISMISS_TOAST': {
      const { toastId } = action

      // ! Side effects ! - This could be extracted into a dismissToast() action,
      // but I'll keep it here for simplicity
      if (toastId) {
        addToRemoveQueue(toastId)
      } else {
        state.toasts.forEach((toast) => {
          addToRemoveQueue(toast.id)
        })
      }

      return {
        ...state,
        toasts: state.toasts.map((t) =>
          t.id === toastId || toastId === undefined
            ? {
                ...t,
                open: false,
              }
            : t,
        ),
      }
    }
    case 'REMOVE_TOAST':
      if (action.toastId === undefined) {
        return {
          ...state,
          toasts: [],
        }
      }
      return {
        ...state,
        toasts: state.toasts.filter((t) => t.id !== action.toastId),
      }
  }
}

const listeners: Array<(state: State) => void> = []

let memoryState: State = { toasts: [] }

function dispatch(action: Action) {
  memoryState = reducer(memoryState, action)
  listeners.forEach((listener) => {
    listener(memoryState)
  })
}

type Toast = Omit<ToasterToast, 'id'>

function toast({ ...props }: Toast) {
  const id = genId()

  const update = (props: ToasterToast) =>
    dispatch({
      type: 'UPDATE_TOAST',
      toast: { ...props, id },
    })
  const dismiss = () => dispatch({ type: 'DISMISS_TOAST', toastId: id })

  dispatch({
    type: 'ADD_TOAST',
    toast: {
      ...props,
      id,
      open: true,
      onOpenChange: (open) => {
        if (!open) dismiss()
      },
    },
  })

  return {
    id: id,
    dismiss,
    update,
  }
}

function useToast() {
  const [state, setState] = React.useState<State>(memoryState)

  React.useEffect(() => {
    listeners.push(setState)
    return () => {
      const index = listeners.indexOf(setState)
      if (index > -1) {
        listeners.splice(index, 1)
      }
    }
  }, [state])

  return {
    ...state,
    toast,
    dismiss: (toastId?: string) => dispatch({ type: 'DISMISS_TOAST', toastId }),
  }
}

export { useToast, toast }
</file>

<file path="lib/dnd-blocks/compiler.ts">
import type {
  EmailBlock, EmailDesign, HeadingProps, TextProps, ImageProps,
  ButtonProps, DividerProps, SpacerProps, SocialProps
} from './types'

// ============================================================
// Blog HTML Compiler
// Converts EmailBlock[] → modern HTML5 (divs, flexbox, inline styles)
// ============================================================

const SOCIAL_ICONS: Record<string, { label: string; color: string }> = {
  facebook: { label: 'Facebook', color: '#1877F2' },
  instagram: { label: 'Instagram', color: '#E4405F' },
  twitter: { label: 'Twitter', color: '#1DA1F2' },
  youtube: { label: 'YouTube', color: '#FF0000' },
  linkedin: { label: 'LinkedIn', color: '#0A66C2' },
  tiktok: { label: 'TikTok', color: '#000000' },
}

function escapeHtml(text: string): string {
  return text
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
}

// --- Individual Block Compilers ---

function compileHeading(props: HeadingProps): string {
  const tag = props.level || 'h1'
  const sizes: Record<string, string> = { h1: '28px', h2: '22px', h3: '18px' }
  return `
<div style="padding: 10px 20px; text-align: ${props.alignment};">
  <${tag} style="margin: 0; font-size: ${sizes[tag]}; color: ${props.color}; font-family: ${props.fontFamily}; font-weight: bold;">
    ${props.text}
  </${tag}>
</div>`
}

function compileText(props: TextProps): string {
  const htmlText = props.text.replace(/\n/g, '<br>')
  return `
<div style="padding: 10px 20px; font-size: ${props.fontSize}px; line-height: ${props.lineHeight}; color: ${props.color}; font-family: Arial, Helvetica, sans-serif; text-align: ${props.alignment};">
  ${htmlText}
</div>`
}

function compileImage(props: ImageProps): string {
  const widthStyle = props.width ? `width: ${props.width}px;` : 'width: 100%;'
  const heightStyle = props.height === 'auto' ? 'height: auto;' : `height: ${props.height}px;`
  const imgTag = `<img src="${props.src}" alt="${escapeHtml(props.alt)}" style="display: block; max-width: 100%; ${widthStyle} ${heightStyle} border: 0; outline: none;" />`
  const content = props.linkUrl ? `<a href="${props.linkUrl}" target="_blank" style="display: inline-block;">${imgTag}</a>` : imgTag

  return `
<div style="padding: 0; text-align: ${props.alignment};">
  ${content}
</div>`
}

function compileButton(props: ButtonProps): string {
  const widthStyle = props.fullWidth ? 'display: block; width: 100%;' : 'display: inline-block;'
  return `
<div style="padding: 10px 20px; text-align: ${props.alignment};">
  <a href="${props.url}" target="_blank" style="${widthStyle} padding: ${props.paddingY}px ${props.paddingX}px; background-color: ${props.bgColor}; color: ${props.textColor}; font-family: Arial, Helvetica, sans-serif; font-size: ${props.fontSize}px; font-weight: bold; text-decoration: none; text-align: center; border-radius: ${props.borderRadius}px;">
    ${escapeHtml(props.text)}
  </a>
</div>`
}

function compileDivider(props: DividerProps): string {
  return `
<div style="padding: 10px 20px; text-align: center;">
  <hr style="border: none; border-top: ${props.thickness}px ${props.style} ${props.color}; width: ${props.widthPercent}%; margin: 0 auto;" />
</div>`
}

function compileSpacer(props: SpacerProps): string {
  return `<div style="height: ${props.height}px;"></div>`
}

function compileSocial(props: SocialProps): string {
  const icons = props.networks.map(n => {
    const info = SOCIAL_ICONS[n.platform] || { label: n.platform, color: '#333' }
    return `<a href="${n.url}" target="_blank" style="text-decoration: none; display: inline-block; margin: 0 6px;">
      <span style="display: inline-block; width: ${props.iconSize}px; height: ${props.iconSize}px; background-color: ${info.color}; border-radius: 50%; text-align: center; line-height: ${props.iconSize}px; color: #ffffff; font-size: ${Math.round(props.iconSize * 0.4)}px; font-family: Arial, sans-serif; font-weight: bold;">${info.label.charAt(0)}</span>
    </a>`
  }).join('\n')

  return `
<div style="padding: 10px 20px; text-align: ${props.alignment};">
  ${icons}
</div>`
}

// --- Main Compiler ---

function compileBlock(block: EmailBlock): string {
  switch (block.type) {
    case 'heading': return compileHeading(block.props as HeadingProps)
    case 'text': return compileText(block.props as TextProps)
    case 'image': return compileImage(block.props as ImageProps)
    case 'button': return compileButton(block.props as ButtonProps)
    case 'divider': return compileDivider(block.props as DividerProps)
    case 'spacer': return compileSpacer(block.props as SpacerProps)
    case 'social': return compileSocial(block.props as SocialProps)
    default: return `<!-- unknown block type: ${(block as any).type} -->`
  }
}

export function compileBlocksToHtml(blocks: EmailDesign): string {
  const bodyContent = blocks.map(compileBlock).join('\n')

  return `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Blog Post</title>
  <style>
    /* Reset */
    body { margin: 0; padding: 0; -webkit-text-size-adjust: 100%; }
    img { border: 0; height: auto; line-height: 100%; outline: none; text-decoration: none; max-width: 100%; }
    a { color: inherit; }
    @media only screen and (max-width: 640px) {
      .blog-container { width: 100% !important; padding: 0 16px !important; }
      .blog-container img { width: 100% !important; height: auto !important; }
    }
  </style>
</head>
<body style="margin: 0; padding: 0; background-color: #f4f4f7; font-family: Arial, Helvetica, sans-serif;">
  <div style="max-width: 800px; margin: 0 auto; padding: 20px 0;">
    <article class="blog-container" style="max-width: 800px; margin: 0 auto; background-color: #ffffff;">
${bodyContent}
    </article>
  </div>
</body>
</html>`
}
</file>

<file path="lib/dnd-blocks/defaults.ts">
import type {
    BlockType, BlockPropsMap, HeadingProps, TextProps, ImageProps,
    ButtonProps, DividerProps, SpacerProps, SocialProps
} from './types'

// Default props for each block type — used when creating a new block from the palette.

const headingDefaults: HeadingProps = {
    text: 'Your Heading Here',
    level: 'h1',
    alignment: 'center',
    color: '#1a1a1a',
    fontFamily: 'Arial, Helvetica, sans-serif',
}

const textDefaults: TextProps = {
    text: 'Write your email copy here. Keep it concise and compelling.',
    alignment: 'left',
    color: '#444444',
    fontSize: 16,
    lineHeight: 1.6,
}

const imageDefaults: ImageProps = {
    src: '{{hero_src}}',
    alt: 'Email hero image',
    width: 600,
    height: 'auto',
    linkUrl: '{{hero_link_url}}',
    alignment: 'center',
}

const buttonDefaults: ButtonProps = {
    text: 'Shop Now',
    url: '{{cta_link_url}}',
    bgColor: '#2563eb',
    textColor: '#ffffff',
    borderRadius: 6,
    alignment: 'center',
    fullWidth: false,
    fontSize: 16,
    paddingX: 32,
    paddingY: 14,
}

const dividerDefaults: DividerProps = {
    color: '#e5e7eb',
    thickness: 1,
    widthPercent: 100,
    style: 'solid',
}

const spacerDefaults: SpacerProps = {
    height: 24,
}

const socialDefaults: SocialProps = {
    networks: [
        { platform: 'facebook', url: 'https://facebook.com' },
        { platform: 'instagram', url: 'https://instagram.com' },
        { platform: 'youtube', url: 'https://youtube.com' },
    ],
    alignment: 'center',
    iconSize: 32,
}

export const BLOCK_DEFAULTS: { [K in BlockType]: BlockPropsMap[K] } = {
    heading: headingDefaults,
    text: textDefaults,
    image: imageDefaults,
    button: buttonDefaults,
    divider: dividerDefaults,
    spacer: spacerDefaults,
    social: socialDefaults,
}

// Human-readable labels for the palette
export const BLOCK_LABELS: Record<BlockType, string> = {
    heading: 'Heading',
    text: 'Text Block',
    image: 'Image',
    button: 'Button',
    divider: 'Divider',
    spacer: 'Spacer',
    social: 'Social Links',
}

export const BLOCK_DESCRIPTIONS: Record<BlockType, string> = {
    heading: 'Large title or section header',
    text: 'Paragraph of body copy',
    image: 'Full-width or centered image',
    button: 'Call-to-action button',
    divider: 'Horizontal line separator',
    spacer: 'Empty vertical space',
    social: 'Social media icon row',
}
</file>

<file path="lib/dnd-blocks/types.ts">
// ============================================================
// DnD Email Editor — Block Type Definitions
// ============================================================

export type BlockType = 'heading' | 'text' | 'image' | 'button' | 'divider' | 'spacer' | 'social'

// --- Per-Block Props ---

export interface HeadingProps {
    text: string
    level: 'h1' | 'h2' | 'h3'
    alignment: 'left' | 'center' | 'right'
    color: string
    fontFamily: string
}

export interface TextProps {
    text: string
    alignment: 'left' | 'center' | 'right'
    color: string
    fontSize: number
    lineHeight: number
}

export interface ImageProps {
    src: string          // mustache var like {{hero_src}}
    alt: string
    width: number        // px, max 600
    height: 'auto' | number
    linkUrl: string      // mustache var like {{hero_link_url}}
    alignment: 'left' | 'center' | 'right'
}

export interface ButtonProps {
    text: string
    url: string          // mustache var like {{cta_link_url}}
    bgColor: string
    textColor: string
    borderRadius: number
    alignment: 'left' | 'center' | 'right'
    fullWidth: boolean
    fontSize: number
    paddingX: number
    paddingY: number
}

export interface DividerProps {
    color: string
    thickness: number
    widthPercent: number
    style: 'solid' | 'dashed' | 'dotted'
}

export interface SpacerProps {
    height: number
}

export interface SocialNetwork {
    platform: 'facebook' | 'instagram' | 'twitter' | 'youtube' | 'linkedin' | 'tiktok'
    url: string
}

export interface SocialProps {
    networks: SocialNetwork[]
    alignment: 'left' | 'center' | 'right'
    iconSize: number
}

// --- Union Block Type ---

export type BlockPropsMap = {
    heading: HeadingProps
    text: TextProps
    image: ImageProps
    button: ButtonProps
    divider: DividerProps
    spacer: SpacerProps
    social: SocialProps
}

export interface EmailBlock<T extends BlockType = BlockType> {
    id: string
    type: T
    props: BlockPropsMap[T]
}

// --- Design (array of blocks) ---

export type EmailDesign = EmailBlock[]

// --- Marker for JSON storage ---
// When we store block JSON in the campaigns table, we prefix it
// with this marker so the system can distinguish DnD data from raw HTML.
export const DND_META_MARKER = '__dnd_blocks__'

export interface DndCampaignData {
    _marker: typeof DND_META_MARKER
    blocks: EmailDesign
}

export function isDndCampaignData(data: unknown): data is DndCampaignData {
    return (
        typeof data === 'object' &&
        data !== null &&
        '_marker' in data &&
        (data as any)._marker === DND_META_MARKER
    )
}

export function serializeBlocks(blocks: EmailDesign): string {
    const data: DndCampaignData = { _marker: DND_META_MARKER, blocks }
    return JSON.stringify(data)
}

export function deserializeBlocks(raw: string): EmailDesign | null {
    try {
        const parsed = JSON.parse(raw)
        if (isDndCampaignData(parsed)) return parsed.blocks
        return null
    } catch {
        return null
    }
}
</file>

<file path="lib/supabase/client.ts">
import { createBrowserClient } from '@supabase/ssr'

export function createClient() {
  return createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  )
}
</file>

<file path="lib/supabase/middleware.ts">
import { createServerClient } from '@supabase/ssr'
import { NextResponse, type NextRequest } from 'next/server'

export async function updateSession(request: NextRequest) {
    let response = NextResponse.next({
        request: {
            headers: request.headers,
        },
    })

    const supabase = createServerClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
        {
            cookies: {
                getAll() {
                    return request.cookies.getAll()
                },
                setAll(cookiesToSet) {
                    cookiesToSet.forEach(({ name, value, options }) =>
                        request.cookies.set(name, value)
                    )
                    response = NextResponse.next({
                        request: {
                            headers: request.headers,
                        },
                    })
                    cookiesToSet.forEach(({ name, value, options }) =>
                        response.cookies.set(name, value, options)
                    )
                },
            },
        }
    )

    await supabase.auth.getUser()

    return response
}
</file>

<file path="lib/supabase/server.ts">
import { createServerClient, type CookieOptions } from "@supabase/ssr"
import { cookies } from "next/headers"

export async function createClient() {
    const cookieStore = await cookies()

    return createServerClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
        {
            cookies: {
                getAll() {
                    return cookieStore.getAll()
                },
                setAll(cookiesToSet) {
                    try {
                        cookiesToSet.forEach(({ name, value, options }) =>
                            cookieStore.set(name, value, options)
                        )
                    } catch {
                        // The `setAll` method was called from a Server Component.
                        // This can be ignored if you have middleware refreshing
                        // user sessions.
                    }
                },
            },
        }
    )
}
</file>

<file path="lib/blog-data.tsx">
// Blog Types - Frontend display types
export interface BlogPost {
    id: string;
    title: string;
    slug: string;
    excerpt: string;
    content: string;
    heroImage: string;
    category: "tutorials" | "artist-stories" | "product-news";
    author: {
        name: string;
        avatar?: string;
    };
    publishedAt: string;
    readTime: string;
    featured?: boolean;
}

export interface Comment {
    id: string;
    name: string;
    email: string;
    comment: string;
    createdAt: string;
    likes?: number;
}

// Helper functions
export function formatDate(dateString: string): string {
    return new Date(dateString).toLocaleDateString("en-US", {
        year: "numeric",
        month: "long",
        day: "numeric",
    });
}

export function getCategoryLabel(category: BlogPost["category"]): string {
    const labels: Record<BlogPost["category"], string> = {
        tutorials: "Tutorials",
        "artist-stories": "Artist Stories",
        "product-news": "Product News",
    };
    return labels[category] || category;
}
</file>

<file path="lib/render-template.ts">
/**
 * Renders a template by replacing all {{key}} placeholders with actual values from the assets object.
 * @param html - The raw HTML template string containing {{variable}} placeholders
 * @param assets - An object mapping variable names to their replacement values
 * @returns The processed HTML string with all placeholders replaced
 */
export function renderTemplate(html: string, assets: Record<string, string>, subscriberTags: string[] = []): string {
    let result = html

    // Pass 0: Smart Blocks — Conditional Tag Content
    // Syntax: {{#if tag_Europe}} content {{/endif}}
    // Keeps content if subscriberTags includes the tag name, strips it otherwise.
    result = result.replace(
        /\{\{#if\s+tag_(\w+)\}\}([\s\S]*?)\{\{\/?endif\}\}/gi,
        (_match, tagName: string, content: string) => {
            // Check manual tags (case-insensitive)
            const hasTag = subscriberTags.some(
                t => t.toLowerCase() === tagName.toLowerCase()
            );
            return hasTag ? content.trim() : "";
        }
    );

    // 1. (Removed premature replacement)

    // NEW APPROACH: Two-Pass
    // Pass 1: Handle "Fit" injection for Image Variables
    for (const [key, value] of Object.entries(assets)) {
        const fitKey = `${key}_fit`
        const fitValue = assets[fitKey]

        if (fitValue) {
            // Look for <img ... src="{{key}}" ... >
            // We want to inject/replace object-fit in the style attribute.
            // Regex explanation:
            // <img[^>]*       Start of img tag
            // src=["']\{\{key\}\}["']  src attribute with variable
            // [^>]*           Other attributes
            // >               End of tag

            // This is too complex to reliably parse/replace in one go due to attribute order.
            // However, we can handle the common case: `style="..."` exists.

            // Strategy: Find strings that look like `<img ... src="{{key}}"` 
            // and then look for `style="` nearby?

            // Actually, let's keep it simple.
            // If the user hasn't put `{{key_fit}}` in their style, we try to force it.
            // BUT, if we just blindly modify `renderTemplate`, we might break things.

            // Let's try a safer regex that targets the specific structure user has?
            // User: `style="width: 100%; height: 300px; object-fit: cover;"`
            // We can look for `object-fit: \w+` inside a style attribute that is inside a tag with `src="{{key}}"`.

            // We will match the whole IMG tag containing the src variable.
            const imgTagRegex = new RegExp(`(<img[^>]*src=["']\\{\\{${key}\\}\\}["'][^>]*>)`, 'gi')

            result = result.replace(imgTagRegex, (match) => {
                // 'match' is the full <img> tag (assuming no > inside attributes, which is standard HTML)

                // Check if style exists
                if (match.match(/style=["'][^"']*["']/i)) {
                    // Update existing style
                    return match.replace(/(style=["'][^"']*)object-fit:\s*[\w-]+;?([^"']*["'])/i, `$1object-fit: ${fitValue};$2`)
                        .replace(/(style=["'])(?!.*object-fit)([^"']*["'])/i, `$1object-fit: ${fitValue}; $2`)
                    // The second replace is for when object-fit is NOT present but style IS.
                    // However, the first replace might have already handled it. 
                    // Let's be careful.

                    // Actually, simpler: Parse the style attribute value.
                    return match.replace(/style=(["'])(.*?)\1/i, (styleMatch, quote, styleContent) => {
                        let newStyle = styleContent
                        // 1. Handle object-fit
                        if (newStyle.includes('object-fit:')) {
                            newStyle = newStyle.replace(/object-fit:\s*[\w-]+/i, `object-fit: ${fitValue}`)
                        } else {
                            newStyle = `${newStyle}; object-fit: ${fitValue}`
                        }

                        // 2. Handle dimensions for robustness (Email clients often strip classes)
                        // This ensures the image doesn't overflow its container
                        if (!newStyle.includes('max-width:')) {
                            newStyle = `${newStyle}; max-width: 100%`
                        }
                        if (!newStyle.includes('height:')) {
                            newStyle = `${newStyle}; height: auto` // Prevent stretching if width is constrained
                        }

                        return `style=${quote}${newStyle}${quote}`
                    })
                } else {
                    // No style attribute, add one
                    // Insert before the closing /> or >
                    if (match.endsWith('/>')) {
                        return match.slice(0, -2) + ` style="object-fit: ${fitValue}; max-width: 100%; height: auto;" />`
                    } else {
                        return match.slice(0, -1) + ` style="object-fit: ${fitValue}; max-width: 100%; height: auto;">`
                    }
                }
            })
        }
    }

    // Pass 2: Standard Replacement (Existing Logic)
    for (const [key, value] of Object.entries(assets)) {
        const pattern = new RegExp(`\\{\\{${key}\\}\\}`, "g")
        result = result.replace(pattern, value || "")
    }

    return result
}
</file>

<file path="lib/types.ts">
export type PostStatus = 'draft' | 'published'

export interface Post {
    id: string
    created_at: string
    updated_at: string
    title: string
    slug: string
    excerpt: string | null
    category: string
    featured_image: string | null
    html_content: string | null
    variable_values: Record<string, any> | null
    status: PostStatus
    published_at: string | null
}

export interface PostVersion {
    id: string
    post_id: string
    html_content: string
    prompt: string | null
    created_at: string
}
</file>

<file path="lib/utils.ts">
import { clsx, type ClassValue } from 'clsx'
import { twMerge } from 'tailwind-merge'

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}
</file>

<file path=".gitignore">
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
/node_modules
/.pnp
.pnp.*
.yarn/*
!.yarn/patches
!.yarn/plugins
!.yarn/releases
!.yarn/versions

# testing
/coverage

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*
.pnpm-debug.log*

# env files (can opt-in for committing if needed)
.env*

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts
</file>

<file path="eslint.config.mjs">
import { defineConfig, globalIgnores } from "eslint/config";
import nextVitals from "eslint-config-next/core-web-vitals";
import nextTs from "eslint-config-next/typescript";

const eslintConfig = defineConfig([
  ...nextVitals,
  ...nextTs,
  // Override default ignores of eslint-config-next.
  globalIgnores([
    // Default ignores of eslint-config-next:
    ".next/**",
    "out/**",
    "build/**",
    "next-env.d.ts",
  ]),
]);

export default eslintConfig;
</file>

<file path="middleware.ts">
import { type NextRequest } from 'next/server'
import { updateSession } from '@/lib/supabase/middleware'

export async function middleware(request: NextRequest) {
    return await updateSession(request)
}

export const config = {
    matcher: [
        /*
         * Match all request paths except for the ones starting with:
         * - _next/static (static files)
         * - _next/image (image optimization files)
         * - favicon.ico (favicon file)
         * Feel free to modify this pattern to include more paths.
         */
        '/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',
    ],
}
</file>

<file path="next.config.ts">
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  /* config options here */
};

export default nextConfig;
</file>

<file path="postcss.config.mjs">
const config = {
  plugins: {
    "@tailwindcss/postcss": {},
  },
};

export default config;
</file>

<file path="README.md">
This is a [Next.js](https://nextjs.org) project bootstrapped with [`create-next-app`](https://nextjs.org/docs/app/api-reference/cli/create-next-app).

## Getting Started

First, run the development server:

```bash
npm run dev
# or
yarn dev
# or
pnpm dev
# or
bun dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.

You can start editing the page by modifying `app/page.tsx`. The page auto-updates as you edit the file.

This project uses [`next/font`](https://nextjs.org/docs/app/building-your-application/optimizing/fonts) to automatically optimize and load [Geist](https://vercel.com/font), a new font family for Vercel.

## Learn More

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.

You can check out [the Next.js GitHub repository](https://github.com/vercel/next.js) - your feedback and contributions are welcome!

## Deploy on Vercel

The easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.

Check out our [Next.js deployment documentation](https://nextjs.org/docs/app/building-your-application/deploying) for more details.
</file>

<file path="repomix.config.json">
{
    "output": {
        "filePath": "repomix-output.xml"
    },
    "ignore": {
        "useGitignore": true,
        "useDefaultPatterns": true,
        "customPatterns": [
            "public/**",
            "pnpm-lock.yaml",
            "package-lock.json",
            "yarn.lock",
            "**/*.svg",
            "**/*.png",
            "**/*.jpg",
            "**/*.jpeg",
            "**/*.gif",
            "**/*.ico",
            "**/*.webp",
            "**/*.avif",
            "**/*.mp4",
            "**/*.mov",
            "**/*.pdf",
            "dist/**",
            ".next/**",
            "node_modules/**",
            "**/*.xml",
            "**/*.backup.*",
            "**/*backup*",
            "_backup_files/**",
            "components/ui/**",
            "supabase/**",
            "pnpm-workspace.yaml",
            "tsconfig.tsbuildinfo"
        ]
    }
}
</file>

<file path="tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./*"]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts",
    "**/*.mts"
  ],
  "exclude": ["node_modules"]
}
</file>

<file path="app/(site)/blog/page.tsx">
import { createClient } from '@/lib/supabase/server'
import BlogClientPage from './client-page'
import type { BlogPost } from '@/lib/blog-data'

export const dynamic = 'force-dynamic'

export default async function BlogIndexPage() {
    const supabase = await createClient()

    const { data: posts, error } = await supabase
        .from('posts')
        .select('*')
        .eq('status', 'published')
        .order('created_at', { ascending: false })
        .limit(100)

    if (error) {
        console.error('Error fetching posts:', error)
    }

    const formattedPosts: BlogPost[] = (posts || []).map((post) => ({
        id: post.id,
        title: post.title || '',
        slug: post.slug || '',
        excerpt: post.excerpt || '',
        content: post.html_content || '',
        heroImage: post.featured_image || '/placeholder.svg',
        category: (post.category as BlogPost['category']) || 'tutorials',
        author: {
            name: post.author || 'Admin',
        },
        publishedAt: post.published_at || post.created_at,
        readTime: post.read_time || '5 min read',
        featured: post.featured || false,
    }))

    return <BlogClientPage posts={formattedPosts} />
}
</file>

<file path="app/(site)/homepage/page.tsx">
import { createClient } from "@/lib/supabase/server"
import Link from "next/link"
import { BlogHeader } from "@/components/blog/blog-header"
import { ArrowRight, Clock } from "lucide-react"

export default async function HomepagePage() {
    const supabase = await createClient()

    const { data: posts } = await supabase
        .from("posts")
        .select("id, title, slug, excerpt, category, featured_image, published_at")
        .eq("status", "published")
        .order("published_at", { ascending: false })

    return (
        <div className="min-h-screen bg-[#050505] text-white font-sans selection:bg-white/20">
            {/* Navigation */}
            <BlogHeader forceOpaque={true} darkMode={true} />

            {/* Hero */}
            <header className="max-w-6xl mx-auto px-6 pt-[120px] md:pt-[160px] pb-16 text-center">
                <p className="font-sans text-[10px] uppercase tracking-[0.3em] text-white/50 mb-4 font-bold">The Journal</p>
                <h1 className="text-5xl md:text-7xl font-serif font-semibold text-white mb-6 tracking-tight leading-tight">DreamPlay Blog</h1>
                <p className="text-base md:text-lg text-white/60 max-w-2xl mx-auto leading-relaxed">
                    Tutorials, insights, and stories from the DreamPlay team.
                </p>
            </header>

            {/* Posts Grid */}
            <section className="max-w-6xl mx-auto px-6 pb-24 border-t border-white/10 pt-16">
                {!posts || posts.length === 0 ? (
                    <div className="text-center py-24 border border-white/10 bg-white/5">
                        <p className="text-white/50 font-sans text-sm">No published posts yet.</p>
                    </div>
                ) : (
                    <div className="grid gap-6 md:gap-8 sm:grid-cols-2 lg:grid-cols-3">
                        {posts.map((post) => (
                            <Link
                                key={post.id}
                                href={`/blog/${post.slug}`}
                                className="group flex flex-col border border-white/10 bg-[#050505] transition-all duration-500 hover:-translate-y-1 hover:border-white/30 hover:bg-white/[0.04] hover:shadow-2xl"
                            >
                                {post.featured_image && (
                                    <div className="relative aspect-[4/3] overflow-hidden border-b border-white/10">
                                        <img
                                            src={post.featured_image}
                                            alt={post.title}
                                            className="h-full w-full object-cover opacity-90 transition-transform duration-700 group-hover:scale-105"
                                        />
                                        <div className="absolute inset-0 bg-black/10 transition-opacity duration-300 group-hover:opacity-0" />
                                    </div>
                                )}
                                <div className="flex flex-col flex-1 p-6 md:p-8 text-left">
                                    <div className="mb-4 flex items-center justify-between">
                                        <span className="font-sans text-[9px] font-bold uppercase tracking-[0.2em] text-white/60 group-hover:text-white/80 transition-colors">
                                            {post.category || "Blog"}
                                        </span>
                                    </div>
                                    <h3 className="mb-4 font-serif text-xl font-medium leading-tight text-white transition-colors duration-300 group-hover:text-gray-300 line-clamp-2">
                                        {post.title}
                                    </h3>
                                    {post.excerpt && (
                                        <p className="mb-6 line-clamp-3 font-sans text-sm leading-relaxed text-white/50 flex-1">
                                            {post.excerpt}
                                        </p>
                                    )}
                                    <div className="mt-auto pt-6 border-t border-white/10 flex items-center justify-between">
                                        {post.published_at && (
                                            <span className="font-sans text-[10px] uppercase tracking-widest text-white/40">
                                                {new Date(post.published_at).toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" })}
                                            </span>
                                        )}
                                        <span className="inline-flex items-center gap-2 font-sans text-[10px] font-bold uppercase tracking-widest text-white transition-colors group-hover:text-gray-400">
                                            Read <ArrowRight className="h-3 w-3 transition-transform group-hover:translate-x-1" />
                                        </span>
                                    </div>
                                </div>
                            </Link>
                        ))}
                    </div>
                )}
            </section>
        </div>
    )
}
</file>

<file path="app/admin/assets/page.tsx">
"use client"

import { useState, useEffect } from "react"
import { getAllLibraryAssets, updateAssetDescription, toggleAssetStar } from "@/app/actions/assets"
import { Loader2, ImageIcon, Search, Check, Star } from "lucide-react"
import { Input } from "@/components/ui/input"
import { Textarea } from "@/components/ui/textarea"
import { cn } from "@/lib/utils"

type FilterMode = "all" | "starred" | "unstarred"

export default function AssetsLibraryPage() {
    const [assets, setAssets] = useState<any[]>([])
    const [loading, setLoading] = useState(true)
    const [search, setSearch] = useState("")
    const [savingId, setSavingId] = useState<string | null>(null)
    const [filter, setFilter] = useState<FilterMode>("all")

    useEffect(() => {
        const fetchAllAssets = async () => {
            const dbAssets = await getAllLibraryAssets()
            setAssets(dbAssets)
            setLoading(false)
        }
        fetchAllAssets()
    }, [])

    const handleSaveDescription = async (id: string, description: string) => {
        setSavingId(id)
        await updateAssetDescription(id, description)
        setTimeout(() => setSavingId(null), 1000)
    }

    const handleToggleStar = async (id: string, currentlyStarred: boolean) => {
        // Optimistic update
        setAssets(prev => prev.map(a => a.id === id ? { ...a, is_starred: !currentlyStarred } : a))
        await toggleAssetStar(id, !currentlyStarred)
    }

    const filteredAssets = assets.filter(a => {
        const matchesSearch = a.filename.toLowerCase().includes(search.toLowerCase()) ||
            (a.description || "").toLowerCase().includes(search.toLowerCase())
        const matchesFilter = filter === "all" ||
            (filter === "starred" && a.is_starred) ||
            (filter === "unstarred" && !a.is_starred)
        return matchesSearch && matchesFilter
    })

    const starredCount = assets.filter(a => a.is_starred).length

    return (
        <div className="p-6 max-w-7xl mx-auto space-y-6">
            <div>
                <h1 className="text-2xl font-bold flex items-center gap-2">
                    <ImageIcon className="w-6 h-6 text-primary" />
                    AI Asset Library
                </h1>
                <p className="text-muted-foreground mt-1 text-sm">
                    Star images and add descriptions so the AI Copilot can embed them directly into blog posts. Only <strong>starred</strong> images are sent to the AI.
                </p>
            </div>

            <div className="flex flex-col sm:flex-row gap-3 sm:items-center sm:justify-between">
                <div className="relative max-w-md flex-1">
                    <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground" />
                    <Input
                        placeholder="Search by filename or description..."
                        value={search}
                        onChange={(e) => setSearch(e.target.value)}
                        className="pl-9"
                    />
                </div>

                {/* Filter tabs */}
                <div className="flex items-center gap-1 bg-muted/50 p-1 rounded-lg border border-border">
                    <button
                        onClick={() => setFilter("all")}
                        className={cn(
                            "text-xs font-medium px-3 py-1.5 rounded-md transition-all",
                            filter === "all" ? "bg-background shadow-sm text-foreground" : "text-muted-foreground hover:text-foreground"
                        )}
                    >
                        All ({assets.length})
                    </button>
                    <button
                        onClick={() => setFilter("starred")}
                        className={cn(
                            "text-xs font-medium px-3 py-1.5 rounded-md transition-all flex items-center gap-1",
                            filter === "starred" ? "bg-background shadow-sm text-foreground" : "text-muted-foreground hover:text-foreground"
                        )}
                    >
                        <Star className="w-3 h-3 fill-yellow-400 text-yellow-400" />
                        Starred ({starredCount})
                    </button>
                    <button
                        onClick={() => setFilter("unstarred")}
                        className={cn(
                            "text-xs font-medium px-3 py-1.5 rounded-md transition-all",
                            filter === "unstarred" ? "bg-background shadow-sm text-foreground" : "text-muted-foreground hover:text-foreground"
                        )}
                    >
                        Unstarred ({assets.length - starredCount})
                    </button>
                </div>
            </div>

            {loading ? (
                <div className="flex justify-center py-12"><Loader2 className="w-8 h-8 animate-spin text-muted-foreground" /></div>
            ) : (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    {filteredAssets.map(asset => (
                        <div
                            key={asset.id}
                            className={cn(
                                "bg-card border rounded-xl overflow-hidden shadow-sm flex flex-col transition-colors",
                                asset.is_starred ? "border-yellow-500/40 ring-1 ring-yellow-500/20" : "border-border"
                            )}
                        >
                            <div className="h-40 bg-muted/30 border-b border-border flex items-center justify-center p-2 relative">
                                <img src={asset.public_url} alt={asset.filename} className="max-h-full max-w-full object-contain rounded" />
                                {/* Star button overlay */}
                                <button
                                    onClick={() => handleToggleStar(asset.id, !!asset.is_starred)}
                                    className={cn(
                                        "absolute top-2 right-2 p-1.5 rounded-full transition-all",
                                        asset.is_starred
                                            ? "bg-yellow-500/20 text-yellow-400 hover:bg-yellow-500/30"
                                            : "bg-black/40 text-white/60 hover:text-white hover:bg-black/60"
                                    )}
                                    title={asset.is_starred ? "Remove from AI library" : "Add to AI library"}
                                >
                                    <Star className={cn("w-4 h-4", asset.is_starred && "fill-yellow-400")} />
                                </button>
                            </div>
                            <div className="p-4 flex flex-col flex-1 gap-3">
                                <p className="text-xs font-mono text-muted-foreground truncate" title={asset.filename}>
                                    {asset.filename}
                                </p>
                                <div className="flex-1">
                                    <Textarea
                                        defaultValue={asset.description || ""}
                                        placeholder="Describe for AI (e.g. 'Pianist hand stretching in pain')..."
                                        className="text-xs resize-none h-24 bg-muted/30 focus:bg-background"
                                        onBlur={(e) => {
                                            if (e.target.value !== asset.description) {
                                                handleSaveDescription(asset.id, e.target.value);
                                                asset.description = e.target.value;
                                            }
                                        }}
                                    />
                                </div>
                                <div className="flex justify-end text-[10px] text-muted-foreground h-4">
                                    {savingId === asset.id && <span className="text-primary flex items-center gap-1"><Check className="w-3 h-3" /> Saved</span>}
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            )}
        </div>
    )
}
</file>

<file path="app/admin/knowledgebase/page.tsx">
"use client"

import { useState, useEffect, useRef } from "react"
import { getKnowledgebase, saveResearchDoc, toggleResearchStatus, deleteResearchDoc, extractPdf, type ResearchDoc } from "@/app/actions/knowledgebase"
import { BookOpen, UploadCloud, Loader2, Plus, Trash2, X, CheckCircle2 } from "lucide-react"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { Textarea } from "@/components/ui/textarea"
import { Switch } from "@/components/ui/switch"
import { Card, CardContent } from "@/components/ui/card"

export default function KnowledgebasePage() {
    const [docs, setDocs] = useState<ResearchDoc[]>([])
    const [loading, setLoading] = useState(true)

    const [form, setForm] = useState<Partial<ResearchDoc> | null>(null)
    const [isConverting, setIsConverting] = useState(false)
    const [isSaving, setIsSaving] = useState(false)
    const [statusMessage, setStatusMessage] = useState<{ type: 'success' | 'error'; text: string } | null>(null)

    const fileInputRef = useRef<HTMLInputElement>(null)

    useEffect(() => { fetchDocs() }, [])

    // Auto-dismiss status messages
    useEffect(() => {
        if (statusMessage) {
            const t = setTimeout(() => setStatusMessage(null), 4000)
            return () => clearTimeout(t)
        }
    }, [statusMessage])

    const fetchDocs = async () => {
        setLoading(true)
        try {
            const data = await getKnowledgebase()
            setDocs(data)
        } catch {
            setStatusMessage({ type: 'error', text: 'Failed to load knowledgebase' })
        }
        setLoading(false)
    }

    const handlePdfUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
        const file = e.target.files?.[0]
        if (!file) return

        setIsConverting(true)
        setStatusMessage({ type: 'success', text: 'Extracting PDF... Gemini is reading the document (~15s).' })

        try {
            const fd = new FormData()
            fd.append("file", file)
            const data = await extractPdf(fd)
            if (data.error) throw new Error(data.error)

            setForm(prev => ({
                ...prev,
                title: prev?.title || file.name.replace(".pdf", ""),
                content: data.markdown
            }))
            setStatusMessage({ type: 'success', text: 'PDF successfully converted to Markdown!' })
        } catch (error: unknown) {
            const message = error instanceof Error ? error.message : "Unknown error"
            setStatusMessage({ type: 'error', text: `Extraction failed: ${message}` })
        } finally {
            setIsConverting(false)
            if (fileInputRef.current) fileInputRef.current.value = ""
        }
    }

    const handleSave = async () => {
        if (!form?.title || !form?.content) {
            setStatusMessage({ type: 'error', text: 'Title and content are required.' })
            return
        }

        setIsSaving(true)
        try {
            await saveResearchDoc(form)
            setStatusMessage({ type: 'success', text: 'Saved to Knowledgebase!' })
            setForm(null)
            fetchDocs()
        } catch (error: unknown) {
            const message = error instanceof Error ? error.message : "Unknown error"
            setStatusMessage({ type: 'error', text: `Failed to save: ${message}` })
        }
        setIsSaving(false)
    }

    const handleDelete = async (id: string) => {
        if (!confirm("Are you sure you want to delete this source forever?")) return
        await deleteResearchDoc(id)
        setStatusMessage({ type: 'success', text: 'Source deleted.' })
        if (form?.id === id) setForm(null)
        fetchDocs()
    }

    return (
        <div className="p-6 max-w-7xl mx-auto h-[calc(100vh-4rem)] flex flex-col">
            {/* Status toast */}
            {statusMessage && (
                <div className={`fixed top-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg text-sm font-medium animate-in fade-in ${statusMessage.type === 'error'
                    ? 'bg-red-500/10 border border-red-500/30 text-red-400'
                    : 'bg-green-500/10 border border-green-500/30 text-green-400'
                    }`}>
                    {statusMessage.text}
                </div>
            )}

            <div className="flex items-center justify-between mb-6 shrink-0">
                <div>
                    <h1 className="text-2xl font-bold flex items-center gap-2">
                        <BookOpen className="w-6 h-6 text-primary" />
                        AI Knowledgebase
                    </h1>
                    <p className="text-muted-foreground mt-1 text-sm">Upload research PDFs to train your AI Blog Writer with hard facts.</p>
                </div>
                <Button onClick={() => setForm({ title: "", author: "", year: "", url: "", content: "", is_active: true })} className="gap-2">
                    <Plus className="w-4 h-4" /> Add Source
                </Button>
            </div>

            <div className="flex gap-6 flex-1 min-h-0">
                {/* LEFT COL: List of Sources */}
                <div className="w-1/3 flex flex-col gap-4 overflow-y-auto pr-2">
                    {loading ? (
                        <div className="flex justify-center py-10"><Loader2 className="animate-spin text-muted-foreground w-6 h-6" /></div>
                    ) : docs.length === 0 ? (
                        <div className="text-center py-10 border border-dashed border-border rounded-lg text-muted-foreground text-sm">
                            No sources added yet.
                        </div>
                    ) : (
                        docs.map(doc => (
                            <Card
                                key={doc.id}
                                className={`cursor-pointer transition-all hover:border-primary/50 ${form?.id === doc.id ? "border-primary ring-1 ring-primary" : ""} ${!doc.is_active ? "opacity-50" : ""}`}
                                onClick={() => setForm(doc)}
                            >
                                <CardContent className="p-4">
                                    <div className="flex items-start justify-between mb-2">
                                        <h3 className="font-semibold text-sm line-clamp-2">{doc.title}</h3>
                                        <Switch
                                            checked={doc.is_active}
                                            onCheckedChange={async (val) => {
                                                await toggleResearchStatus(doc.id, val)
                                                fetchDocs()
                                            }}
                                            onClick={e => e.stopPropagation()}
                                        />
                                    </div>
                                    <p className="text-xs text-muted-foreground">
                                        {doc.author || "Unknown"} {doc.year ? `(${doc.year})` : ""}
                                    </p>
                                </CardContent>
                            </Card>
                        ))
                    )}
                </div>

                {/* RIGHT COL: Editor */}
                <div className="w-2/3 flex flex-col h-full bg-card border border-border rounded-xl overflow-hidden shadow-sm">
                    {form ? (
                        <div className="flex flex-col h-full">
                            <div className="p-4 border-b border-border bg-muted/20 flex items-center justify-between shrink-0">
                                <h3 className="font-semibold text-sm">{form.id ? "Edit Source" : "New Source"}</h3>
                                <div className="flex items-center gap-2">
                                    {form.id && (
                                        <Button variant="ghost" size="icon" onClick={() => handleDelete(form.id!)} className="text-red-400 hover:text-red-500 hover:bg-red-500/10">
                                            <Trash2 className="w-4 h-4" />
                                        </Button>
                                    )}
                                    <Button onClick={handleSave} disabled={isSaving || isConverting || !form.title || !form.content} size="sm">
                                        {isSaving ? <Loader2 className="w-4 h-4 mr-2 animate-spin" /> : <CheckCircle2 className="w-4 h-4 mr-2" />}
                                        Save
                                    </Button>
                                    <Button variant="ghost" size="icon" onClick={() => setForm(null)}>
                                        <X className="w-4 h-4" />
                                    </Button>
                                </div>
                            </div>

                            <div className="p-6 overflow-y-auto flex-1 space-y-6">
                                {/* PDF Import Box */}
                                {!form.id && (
                                    <div
                                        className="border-2 border-dashed border-primary/30 bg-primary/5 rounded-lg p-6 text-center cursor-pointer hover:bg-primary/10 transition-colors"
                                        onClick={() => fileInputRef.current?.click()}
                                    >
                                        <input type="file" accept=".pdf" className="hidden" ref={fileInputRef} onChange={handlePdfUpload} />
                                        {isConverting ? (
                                            <div className="flex flex-col items-center">
                                                <Loader2 className="w-6 h-6 animate-spin text-primary mb-3" />
                                                <p className="text-sm font-medium text-primary">Extracting PDF layout & text...</p>
                                            </div>
                                        ) : (
                                            <div>
                                                <UploadCloud className="w-6 h-6 text-primary mx-auto mb-3" />
                                                <p className="text-sm font-medium mb-1">Upload PDF</p>
                                                <p className="text-xs text-muted-foreground">AI will automatically extract and format the text into Markdown.</p>
                                            </div>
                                        )}
                                    </div>
                                )}

                                <div className="grid grid-cols-2 gap-4">
                                    <div className="col-span-2 space-y-1.5">
                                        <Label className="text-xs">Document Title *</Label>
                                        <Input value={form.title || ""} onChange={e => setForm({ ...form, title: e.target.value })} placeholder="e.g. Ergonomic Equity in Keyboards" />
                                    </div>
                                    <div className="space-y-1.5">
                                        <Label className="text-xs">Author(s)</Label>
                                        <Input value={form.author || ""} onChange={e => setForm({ ...form, author: e.target.value })} placeholder="e.g. Yoshimura & Chesky" />
                                    </div>
                                    <div className="space-y-1.5">
                                        <Label className="text-xs">Year</Label>
                                        <Input value={form.year || ""} onChange={e => setForm({ ...form, year: e.target.value })} placeholder="e.g. 2008" />
                                    </div>
                                    <div className="col-span-2 space-y-1.5">
                                        <Label className="text-xs">Source URL (For hyperlinking citations)</Label>
                                        <Input value={form.url || ""} onChange={e => setForm({ ...form, url: e.target.value })} placeholder="https://..." />
                                    </div>
                                </div>

                                <div className="space-y-1.5 flex flex-col h-[500px]">
                                    <Label className="text-xs">Content (Markdown) *</Label>
                                    <Textarea
                                        value={form.content || ""}
                                        onChange={e => setForm({ ...form, content: e.target.value })}
                                        className="h-full font-mono text-sm resize-none bg-muted/30 p-4"
                                        placeholder="Paste research text here, or use the PDF importer above..."
                                    />
                                </div>
                            </div>
                        </div>
                    ) : (
                        <div className="flex flex-col items-center justify-center h-full text-muted-foreground">
                            <BookOpen className="w-12 h-12 mb-4 opacity-20" />
                            <p className="text-sm">Select a source from the left, or add a new one.</p>
                        </div>
                    )}
                </div>
            </div>
        </div>
    )
}
</file>

<file path="app/globals.css">
@import 'tailwindcss';
@import 'tw-animate-css';
@plugin "@tailwindcss/typography";

@custom-variant dark (&:is(.dark *));

@import "tailwindcss/theme.css";

:root {
  /* Light Mode Defaults */
  --background: oklch(0.98 0 0);
  --foreground: oklch(0.2 0 0);
  --card: oklch(1 0 0);
  --card-foreground: oklch(0.2 0 0);
  --popover: oklch(1 0 0);
  --popover-foreground: oklch(0.2 0 0);
  --primary: oklch(0.2 0 0);
  --primary-foreground: oklch(0.98 0 0);
  --secondary: oklch(0.96 0 0);
  --secondary-foreground: oklch(0.2 0 0);
  --muted: oklch(0.96 0 0);
  --muted-foreground: oklch(0.55 0 0);
  --accent: oklch(0.55 0.2 25);
  --accent-foreground: oklch(0.98 0 0);
  --destructive: oklch(0.55 0.2 25);
  --destructive-foreground: oklch(0.98 0 0);
  --border: oklch(0.9 0 0);
  --input: oklch(0.9 0 0);
  --ring: oklch(0.55 0.2 25);

  --radius: 0.5rem;
  --chart-1: oklch(0.55 0.2 25);
  --chart-2: oklch(0.6 0.118 184.704);
  --chart-3: oklch(0.398 0.07 227.392);
  --chart-4: oklch(0.828 0.189 84.429);
  --chart-5: oklch(0.769 0.188 70.08);

  --sidebar: oklch(0.98 0 0);
  --sidebar-foreground: oklch(0.2 0 0);
  --sidebar-primary: oklch(0.2 0 0);
  --sidebar-primary-foreground: oklch(0.98 0 0);
  --sidebar-accent: oklch(0.96 0 0);
  --sidebar-accent-foreground: oklch(0.2 0 0);
  --sidebar-border: oklch(0.9 0 0);
  --sidebar-ring: oklch(0.55 0.2 25);
}

.dark {
  --background: oklch(0.08 0 0);
  --foreground: oklch(0.98 0 0);
  --card: oklch(0.12 0 0);
  --card-foreground: oklch(0.98 0 0);
  --popover: oklch(0.1 0 0);
  --popover-foreground: oklch(0.98 0 0);
  --primary: oklch(0.98 0 0);
  --primary-foreground: oklch(0.08 0 0);
  --secondary: oklch(0.18 0 0);
  --secondary-foreground: oklch(0.98 0 0);
  --muted: oklch(0.15 0 0);
  --muted-foreground: oklch(0.65 0 0);
  --accent: oklch(0.55 0.2 25);
  --accent-foreground: oklch(0.98 0 0);
  --destructive: oklch(0.55 0.2 25);
  --destructive-foreground: oklch(0.98 0 0);
  --border: oklch(0.22 0 0);
  --input: oklch(0.18 0 0);
  --ring: oklch(0.55 0.2 25);

  --sidebar: oklch(0.1 0 0);
  --sidebar-foreground: oklch(0.98 0 0);
  --sidebar-primary: oklch(0.55 0.2 25);
  --sidebar-primary-foreground: oklch(0.98 0 0);
  --sidebar-accent: oklch(0.15 0 0);
  --sidebar-accent-foreground: oklch(0.98 0 0);
  --sidebar-border: oklch(0.22 0 0);
  --sidebar-ring: oklch(0.55 0.2 25);
}

@theme inline {
  --font-sans: var(--font-geist), 'Geist', 'Geist Fallback', sans-serif;
  --font-serif: var(--font-cormorant), 'Cormorant Garamond', 'Cormorant Garamond Fallback', serif;
  --font-mono: var(--font-geist-mono), 'Geist Mono', 'Geist Mono Fallback', monospace;
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --color-card: var(--card);
  --color-card-foreground: var(--card-foreground);
  --color-popover: var(--popover);
  --color-popover-foreground: var(--popover-foreground);
  --color-primary: var(--primary);
  --color-primary-foreground: var(--primary-foreground);
  --color-secondary: var(--secondary);
  --color-secondary-foreground: var(--secondary-foreground);
  --color-muted: var(--muted);
  --color-muted-foreground: var(--muted-foreground);
  --color-accent: var(--accent);
  --color-accent-foreground: var(--accent-foreground);
  --color-destructive: var(--destructive);
  --color-destructive-foreground: var(--destructive-foreground);
  --color-border: var(--border);
  --color-input: var(--input);
  --color-ring: var(--ring);
  --color-chart-1: var(--chart-1);
  --color-chart-2: var(--chart-2);
  --color-chart-3: var(--chart-3);
  --color-chart-4: var(--chart-4);
  --color-chart-5: var(--chart-5);
  --radius-sm: calc(var(--radius) - 4px);
  --radius-md: calc(var(--radius) - 2px);
  --radius-lg: var(--radius);
  --radius-xl: calc(var(--radius) + 4px);
  --color-sidebar: var(--sidebar);
  --color-sidebar-foreground: var(--sidebar-foreground);
  --color-sidebar-primary: var(--sidebar-primary);
  --color-sidebar-primary-foreground: var(--sidebar-primary-foreground);
  --color-sidebar-accent: var(--sidebar-accent);
  --color-sidebar-accent-foreground: var(--sidebar-accent-foreground);
  --color-sidebar-border: var(--sidebar-border);
  --color-sidebar-ring: var(--sidebar-ring);
}

@layer base {
  * {
    @apply border-border outline-ring/50;
  }

  body {
    @apply bg-background text-foreground;
  }
}

/* Custom prose styles for blog content */
.prose-dreamplay {
  --tw-prose-body: var(--foreground);
  --tw-prose-headings: var(--foreground);
  --tw-prose-lead: var(--muted-foreground);
  --tw-prose-links: var(--accent);
  --tw-prose-bold: var(--foreground);
  --tw-prose-counters: var(--muted-foreground);
  --tw-prose-bullets: var(--foreground);
  --tw-prose-hr: var(--border);
  --tw-prose-quotes: var(--foreground);
  --tw-prose-quote-borders: var(--accent);
  --tw-prose-captions: var(--muted-foreground);
  --tw-prose-code: var(--foreground);
  --tw-prose-pre-code: var(--foreground);
  --tw-prose-pre-bg: var(--secondary);
  --tw-prose-th-borders: var(--border);
  --tw-prose-td-borders: var(--border);
}
</file>

<file path="app/page.tsx">
import { redirect } from "next/navigation";

export default function Home() {
  redirect("/blog");
}
</file>

<file path="components/blog/blog-card.tsx">
"use client";

import Link from "next/link";
import { Clock, ArrowRight } from "lucide-react";
import { type BlogPost, getCategoryLabel, formatDate } from "@/lib/blog-data";

interface BlogCardProps {
    post: BlogPost;
}

export function BlogCard({ post }: BlogCardProps) {
    return (
        <Link href={`/blog/${post.slug}`} className="group block h-full">
            <article className="flex h-full flex-col border border-white/10 bg-[#050505] transition-all duration-500 hover:-translate-y-1 hover:border-white/30 hover:bg-white/[0.04] hover:shadow-2xl">
                <div className="relative aspect-[4/3] overflow-hidden border-b border-white/10">
                    <img
                        src={post.heroImage || "/placeholder.svg"}
                        alt={post.title}
                        className="h-full w-full object-cover opacity-90 transition-transform duration-700 group-hover:scale-105"
                    />
                    <div className="absolute inset-0 bg-black/10 transition-opacity duration-300 group-hover:opacity-0" />
                </div>
                <div className="flex flex-1 flex-col p-6 md:p-8 text-left">
                    <div className="mb-4 flex items-center justify-between">
                        <span className="font-sans text-[9px] font-bold uppercase tracking-[0.2em] text-white/60">
                            {getCategoryLabel(post.category)}
                        </span>
                        <span className="flex items-center gap-1.5 font-sans text-[9px] uppercase tracking-widest text-white/40">
                            <Clock className="h-3 w-3" />
                            {post.readTime}
                        </span>
                    </div>
                    <h3 className="mb-4 font-serif text-2xl font-medium leading-tight text-white transition-colors duration-300 group-hover:text-gray-300">
                        {post.title}
                    </h3>
                    <p className="mb-8 flex-1 font-sans text-sm leading-relaxed text-white/50 line-clamp-3">
                        {post.excerpt}
                    </p>
                    <div className="mt-auto flex items-center justify-between border-t border-white/10 pt-6">
                        <span className="font-sans text-[10px] uppercase tracking-widest text-white/40">
                            {formatDate(post.publishedAt)}
                        </span>
                        <span className="inline-flex items-center gap-2 font-sans text-[10px] font-bold uppercase tracking-widest text-white transition-colors group-hover:text-gray-400">
                            Read <ArrowRight className="h-3 w-3 transition-transform group-hover:translate-x-1" />
                        </span>
                    </div>
                </div>
            </article>
        </Link>
    );
}
</file>

<file path="components/blog/category-filter.tsx">
"use client";

import { Search } from "lucide-react";
import { cn } from "@/lib/utils";

type Category = "all" | "tutorials" | "artist-stories" | "product-news";

interface CategoryFilterProps {
    activeCategory: Category;
    onCategoryChange: (category: Category) => void;
    searchQuery: string;
    onSearchChange: (query: string) => void;
}

const categories: { value: Category; label: string }[] = [
    { value: "all", label: "All Posts" },
    { value: "tutorials", label: "Tutorials" },
    { value: "artist-stories", label: "Artist Stories" },
    { value: "product-news", label: "Product News" },
];

export function CategoryFilter({
    activeCategory,
    onCategoryChange,
    searchQuery,
    onSearchChange,
}: CategoryFilterProps) {
    return (
        <div className="flex flex-col gap-6 lg:flex-row lg:items-center lg:justify-between border-b border-white/10 pb-8">
            <div className="flex flex-wrap gap-2">
                {categories.map((category) => (
                    <button
                        key={category.value}
                        onClick={() => onCategoryChange(category.value)}
                        className={cn(
                            "px-5 py-3 font-sans text-[10px] font-bold uppercase tracking-[0.2em] transition-all duration-300 border cursor-pointer",
                            activeCategory === category.value
                                ? "border-white bg-white text-black"
                                : "border-white/10 bg-transparent text-white/60 hover:border-white/50 hover:text-white"
                        )}
                    >
                        {category.label}
                    </button>
                ))}
            </div>
            <div className="relative w-full lg:w-72 shrink-0">
                <Search className="absolute left-4 top-1/2 h-4 w-4 -translate-y-1/2 text-white/40" />
                <input
                    type="text"
                    placeholder="Search articles..."
                    value={searchQuery}
                    onChange={(e) => onSearchChange(e.target.value)}
                    className="w-full rounded-none border border-white/20 bg-transparent py-3 pl-12 pr-4 font-sans text-sm text-white placeholder:text-white/40 focus:border-white focus:outline-none focus:ring-0 transition-colors"
                />
            </div>
        </div>
    );
}
</file>

<file path="components/blog/featured-post.tsx">
"use client";

import Link from "next/link";
import { Clock, ArrowRight } from "lucide-react";
import { type BlogPost, getCategoryLabel, formatDate } from "@/lib/blog-data";

interface FeaturedPostProps {
    post: BlogPost;
}

export function FeaturedPost({ post }: FeaturedPostProps) {
    return (
        <Link href={`/blog/${post.slug}`} className="group block text-left">
            <article className="relative min-h-[500px] overflow-hidden border border-white/10 bg-[#050505] transition-all duration-500 hover:border-white/30 hover:shadow-2xl lg:min-h-[600px]">
                <div className="absolute inset-0 lg:w-[65%]">
                    <img
                        src={post.heroImage || "/placeholder.svg"}
                        alt={post.title}
                        className="h-full w-full object-cover opacity-80 transition-transform duration-700 group-hover:scale-105"
                    />
                    <div className="absolute inset-0 bg-gradient-to-t from-[#050505] via-[#050505]/60 to-transparent lg:bg-gradient-to-r lg:from-transparent lg:to-[#050505]" />
                </div>
                <div className="relative flex h-full min-h-[500px] flex-col justify-end p-8 md:p-12 lg:min-h-[600px] lg:items-end lg:justify-center">
                    <div className="max-w-xl lg:w-1/2 lg:pl-12">
                        <div className="mb-6 flex flex-wrap items-center gap-4">
                            <span className="font-sans text-[10px] font-bold uppercase tracking-[0.3em] text-black bg-white px-3 py-1">
                                Featured
                            </span>
                            <span className="font-sans text-[10px] font-bold uppercase tracking-[0.3em] text-white/60">
                                {getCategoryLabel(post.category)}
                            </span>
                            <span className="flex items-center gap-1.5 font-sans text-[10px] uppercase tracking-[0.3em] text-white/40">
                                <Clock className="h-3 w-3" />
                                {post.readTime}
                            </span>
                        </div>

                        <h2 className="mb-6 font-serif text-4xl leading-tight text-white md:text-5xl lg:text-6xl group-hover:text-white/90 transition-colors text-balance">
                            {post.title}
                        </h2>

                        <p className="mb-8 font-sans text-sm md:text-base leading-relaxed text-white/70 line-clamp-3">
                            {post.excerpt}
                        </p>

                        <div className="flex flex-wrap items-center gap-6 border-t border-white/10 pt-8">
                            <div className="flex items-center gap-4">
                                <div className="flex h-10 w-10 items-center justify-center border border-white/20 bg-white/5 font-serif text-sm text-white">
                                    {post.author.name
                                        .split(" ")
                                        .map((n) => n[0])
                                        .join("")}
                                </div>
                                <div className="flex flex-col">
                                    <span className="font-sans text-[11px] font-bold uppercase tracking-widest text-white">
                                        {post.author.name}
                                    </span>
                                    <span className="mt-1 font-sans text-[10px] uppercase tracking-widest text-white/40">
                                        {formatDate(post.publishedAt)}
                                    </span>
                                </div>
                            </div>
                            <span className="hidden h-8 w-px bg-white/20 md:block" />
                            <span className="inline-flex items-center gap-2 border border-white bg-white px-6 py-3 font-sans text-[10px] font-bold uppercase tracking-widest text-black transition-colors hover:bg-white/90">
                                Read Article
                                <ArrowRight className="h-4 w-4 transition-transform group-hover:translate-x-1" />
                            </span>
                        </div>
                    </div>
                </div>
            </article>
        </Link>
    );
}
</file>

<file path="components/dnd-editor/block-renderers.tsx">
"use client"

import type { EmailBlock, HeadingProps, TextProps, ImageProps, ButtonProps, DividerProps, SpacerProps, SocialProps } from "@/lib/dnd-blocks/types"

// Visual preview renderers for the DnD canvas.
// These render aesthetically in React — NOT the same as the email HTML compiler output.

function HeadingPreview({ props }: { props: HeadingProps }) {
    const Tag = props.level as 'h1' | 'h2' | 'h3'
    const sizes = { h1: 'text-2xl', h2: 'text-xl', h3: 'text-lg' }
    return (
        <div style={{ textAlign: props.alignment, padding: '10px 20px' }}>
            <Tag
                className={`${sizes[props.level]} font-bold`}
                style={{ color: props.color, fontFamily: props.fontFamily, margin: 0 }}
            >
                {props.text}
            </Tag>
        </div>
    )
}

function TextPreview({ props }: { props: TextProps }) {
    return (
        <div
            style={{
                textAlign: props.alignment,
                padding: '10px 20px',
                fontSize: `${props.fontSize}px`,
                lineHeight: props.lineHeight,
                color: props.color,
            }}
        >
            {props.text.split('\n').map((line, i) => (
                <span key={i}>
                    {line}
                    {i < props.text.split('\n').length - 1 && <br />}
                </span>
            ))}
        </div>
    )
}

function ImagePreview({ props }: { props: ImageProps }) {
    const isMustache = props.src.startsWith('{{')
    return (
        <div style={{ textAlign: props.alignment, padding: '0' }}>
            {isMustache ? (
                <div
                    className="bg-muted/50 border-2 border-dashed border-border flex items-center justify-center"
                    style={{ width: props.width, maxWidth: '100%', height: 200, margin: props.alignment === 'center' ? '0 auto' : undefined }}
                >
                    <span className="text-sm text-muted-foreground font-mono">{props.src}</span>
                </div>
            ) : (
                <img
                    src={props.src}
                    alt={props.alt}
                    style={{
                        width: props.width,
                        maxWidth: '100%',
                        height: props.height === 'auto' ? 'auto' : props.height,
                        display: 'block',
                        margin: props.alignment === 'center' ? '0 auto' : undefined,
                    }}
                />
            )}
        </div>
    )
}

function ButtonPreview({ props }: { props: ButtonProps }) {
    return (
        <div style={{ textAlign: props.alignment, padding: '10px 20px' }}>
            <span
                className="inline-block cursor-default"
                style={{
                    display: props.fullWidth ? 'block' : 'inline-block',
                    padding: `${props.paddingY}px ${props.paddingX}px`,
                    backgroundColor: props.bgColor,
                    color: props.textColor,
                    borderRadius: `${props.borderRadius}px`,
                    fontSize: `${props.fontSize}px`,
                    fontWeight: 'bold',
                    textAlign: 'center',
                    textDecoration: 'none',
                }}
            >
                {props.text}
            </span>
        </div>
    )
}

function DividerPreview({ props }: { props: DividerProps }) {
    return (
        <div style={{ padding: '10px 20px', textAlign: 'center' }}>
            <hr
                style={{
                    width: `${props.widthPercent}%`,
                    border: 'none',
                    borderTop: `${props.thickness}px ${props.style} ${props.color}`,
                    margin: '0 auto',
                }}
            />
        </div>
    )
}

function SpacerPreview({ props }: { props: SpacerProps }) {
    return (
        <div
            className="relative"
            style={{ height: props.height }}
        >
            <div className="absolute inset-x-0 top-1/2 border-t border-dashed border-border/50" />
            <span className="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 bg-white px-2 text-[10px] text-muted-foreground">
                {props.height}px
            </span>
        </div>
    )
}

const SOCIAL_COLORS: Record<string, string> = {
    facebook: '#1877F2', instagram: '#E4405F', twitter: '#1DA1F2',
    youtube: '#FF0000', linkedin: '#0A66C2', tiktok: '#000000',
}

function SocialPreview({ props }: { props: SocialProps }) {
    return (
        <div style={{ textAlign: props.alignment, padding: '10px 20px' }}>
            <div style={{ display: 'inline-flex', gap: 12 }}>
                {props.networks.map((n, i) => (
                    <div
                        key={i}
                        style={{
                            width: props.iconSize,
                            height: props.iconSize,
                            borderRadius: '50%',
                            backgroundColor: SOCIAL_COLORS[n.platform] || '#333',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            color: '#fff',
                            fontSize: Math.round(props.iconSize * 0.4),
                            fontWeight: 'bold',
                        }}
                    >
                        {n.platform.charAt(0).toUpperCase()}
                    </div>
                ))}
            </div>
        </div>
    )
}

// --- Main Dispatcher ---

export function BlockRenderer({ block }: { block: EmailBlock }) {
    switch (block.type) {
        case 'heading': return <HeadingPreview props={block.props as HeadingProps} />
        case 'text': return <TextPreview props={block.props as TextProps} />
        case 'image': return <ImagePreview props={block.props as ImageProps} />
        case 'button': return <ButtonPreview props={block.props as ButtonProps} />
        case 'divider': return <DividerPreview props={block.props as DividerProps} />
        case 'spacer': return <SpacerPreview props={block.props as SpacerProps} />
        case 'social': return <SocialPreview props={block.props as SocialProps} />
        default: return <div className="p-4 text-red-500">Unknown block type</div>
    }
}
</file>

<file path="components/dnd-editor/block-settings.tsx">
"use client"

import { useCallback, useState } from "react"
import { ScrollArea } from "@/components/ui/scroll-area"
import { Label } from "@/components/ui/label"
import { Input } from "@/components/ui/input"
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select"
import { Switch } from "@/components/ui/switch"
import { Slider } from "@/components/ui/slider"
import { Settings, AlignLeft, AlignCenter, AlignRight, Upload } from "lucide-react"
import { cn } from "@/lib/utils"
import { AssetPickerModal } from "@/components/editor/asset-picker-modal"
import type {
    EmailBlock, BlockType, HeadingProps, TextProps, ImageProps,
    ButtonProps, DividerProps, SpacerProps, SocialProps, SocialNetwork
} from "@/lib/dnd-blocks/types"
import { BLOCK_LABELS } from "@/lib/dnd-blocks/defaults"

interface BlockSettingsProps {
    block: EmailBlock | null
    onUpdate: (id: string, props: Record<string, any>) => void
}

// --- Shared Controls ---

function AlignmentPicker({ value, onChange }: { value: string; onChange: (v: string) => void }) {
    return (
        <div className="flex bg-muted p-0.5 rounded-md">
            {(['left', 'center', 'right'] as const).map((a) => {
                const Icon = a === 'left' ? AlignLeft : a === 'center' ? AlignCenter : AlignRight
                return (
                    <button
                        key={a}
                        onClick={() => onChange(a)}
                        className={cn(
                            "p-1.5 rounded-sm transition-colors flex-1 flex justify-center",
                            value === a ? "bg-background shadow-sm" : "hover:bg-background/50"
                        )}
                    >
                        <Icon className="w-3.5 h-3.5" />
                    </button>
                )
            })}
        </div>
    )
}

function ColorInput({ value, onChange, label }: { value: string; onChange: (v: string) => void; label: string }) {
    return (
        <div className="space-y-1">
            <Label className="text-[10px] uppercase text-muted-foreground">{label}</Label>
            <div className="flex items-center gap-2">
                <input
                    type="color"
                    value={value}
                    onChange={(e) => onChange(e.target.value)}
                    className="w-8 h-8 rounded border border-border cursor-pointer"
                />
                <Input
                    value={value}
                    onChange={(e) => onChange(e.target.value)}
                    className="h-8 text-xs font-mono flex-1"
                />
            </div>
        </div>
    )
}

function NumberSlider({ value, onChange, label, min, max, step = 1, unit = 'px' }: {
    value: number; onChange: (v: number) => void; label: string
    min: number; max: number; step?: number; unit?: string
}) {
    return (
        <div className="space-y-1.5">
            <div className="flex items-center justify-between">
                <Label className="text-[10px] uppercase text-muted-foreground">{label}</Label>
                <span className="text-xs text-muted-foreground">{value}{unit}</span>
            </div>
            <Slider
                value={[value]}
                onValueChange={([v]: number[]) => onChange(v)}
                min={min}
                max={max}
                step={step}
                className="w-full"
            />
        </div>
    )
}

// --- Per-Type Settings ---

function HeadingSettings({ props, onChange }: { props: HeadingProps; onChange: (p: Partial<HeadingProps>) => void }) {
    return (
        <div className="space-y-4">
            <div className="space-y-1">
                <Label className="text-[10px] uppercase text-muted-foreground">Heading Text</Label>
                <Input value={props.text} onChange={(e) => onChange({ text: e.target.value })} className="text-sm" />
            </div>
            <div className="space-y-1">
                <Label className="text-[10px] uppercase text-muted-foreground">Level</Label>
                <Select value={props.level} onValueChange={(v) => onChange({ level: v as any })}>
                    <SelectTrigger className="h-8 text-xs"><SelectValue /></SelectTrigger>
                    <SelectContent>
                        <SelectItem value="h1">H1 - Large</SelectItem>
                        <SelectItem value="h2">H2 - Medium</SelectItem>
                        <SelectItem value="h3">H3 - Small</SelectItem>
                    </SelectContent>
                </Select>
            </div>
            <div className="space-y-1">
                <Label className="text-[10px] uppercase text-muted-foreground">Alignment</Label>
                <AlignmentPicker value={props.alignment} onChange={(v) => onChange({ alignment: v as any })} />
            </div>
            <ColorInput value={props.color} onChange={(v) => onChange({ color: v })} label="Color" />
            <div className="space-y-1">
                <Label className="text-[10px] uppercase text-muted-foreground">Font Family</Label>
                <Select value={props.fontFamily} onValueChange={(v) => onChange({ fontFamily: v })}>
                    <SelectTrigger className="h-8 text-xs"><SelectValue /></SelectTrigger>
                    <SelectContent>
                        <SelectItem value="Arial, Helvetica, sans-serif">Arial</SelectItem>
                        <SelectItem value="Georgia, serif">Georgia</SelectItem>
                        <SelectItem value="'Trebuchet MS', sans-serif">Trebuchet</SelectItem>
                        <SelectItem value="Verdana, sans-serif">Verdana</SelectItem>
                        <SelectItem value="'Courier New', monospace">Courier New</SelectItem>
                    </SelectContent>
                </Select>
            </div>
        </div>
    )
}

function TextSettings({ props, onChange }: { props: TextProps; onChange: (p: Partial<TextProps>) => void }) {
    return (
        <div className="space-y-4">
            <div className="space-y-1">
                <Label className="text-[10px] uppercase text-muted-foreground">Text Content</Label>
                <textarea
                    value={props.text}
                    onChange={(e) => onChange({ text: e.target.value })}
                    rows={5}
                    className="w-full bg-background border border-border rounded-md px-3 py-2 text-sm focus:outline-none focus:border-primary resize-y"
                />
            </div>
            <div className="space-y-1">
                <Label className="text-[10px] uppercase text-muted-foreground">Alignment</Label>
                <AlignmentPicker value={props.alignment} onChange={(v) => onChange({ alignment: v as any })} />
            </div>
            <ColorInput value={props.color} onChange={(v) => onChange({ color: v })} label="Text Color" />
            <NumberSlider value={props.fontSize} onChange={(v) => onChange({ fontSize: v })} label="Font Size" min={10} max={32} />
            <NumberSlider value={props.lineHeight} onChange={(v) => onChange({ lineHeight: v })} label="Line Height" min={1} max={2.5} step={0.1} unit="x" />
        </div>
    )
}

function ImageSettings({ props, onChange }: { props: ImageProps; onChange: (p: Partial<ImageProps>) => void }) {
    const [isPickerOpen, setIsPickerOpen] = useState(false)
    const isMustache = props.src.startsWith('{{')
    const hasDirectUrl = !isMustache && props.src.startsWith('http')

    return (
        <div className="space-y-4">
            <div className="space-y-1.5">
                <Label className="text-[10px] uppercase text-muted-foreground">Image Source</Label>
                <div className="flex gap-2">
                    <Input
                        value={props.src}
                        onChange={(e) => onChange({ src: e.target.value })}
                        className="text-sm font-mono flex-1 h-8"
                        placeholder="{{hero_src}} or URL"
                    />
                    <button
                        onClick={() => setIsPickerOpen(true)}
                        className="h-8 px-2.5 rounded-md border border-border bg-background hover:bg-muted transition-colors flex items-center gap-1.5 flex-shrink-0"
                        title="Browse Asset Library"
                    >
                        <Upload className="w-3.5 h-3.5" />
                        <span className="text-[11px] font-medium">Browse</span>
                    </button>
                </div>
                <p className="text-[10px] text-muted-foreground">Use {"{{variable}}"} for mustache vars, or pick from Asset Library</p>

                {/* Image Preview */}
                {hasDirectUrl && (
                    <div className="rounded border border-border overflow-hidden bg-muted/50 flex items-center justify-center p-2 mt-2">
                        <img
                            src={props.src}
                            alt={props.alt}
                            className="max-w-full max-h-24 object-contain"
                            onError={(e) => { e.currentTarget.style.display = 'none' }}
                        />
                    </div>
                )}
            </div>
            <div className="space-y-1">
                <Label className="text-[10px] uppercase text-muted-foreground">Alt Text</Label>
                <Input value={props.alt} onChange={(e) => onChange({ alt: e.target.value })} className="text-sm" />
            </div>
            <div className="space-y-1">
                <Label className="text-[10px] uppercase text-muted-foreground">Link URL</Label>
                <Input value={props.linkUrl} onChange={(e) => onChange({ linkUrl: e.target.value })} className="text-sm font-mono" placeholder="{{hero_link_url}}" />
            </div>
            <NumberSlider value={props.width} onChange={(v) => onChange({ width: v })} label="Width" min={100} max={600} />
            <div className="space-y-1">
                <Label className="text-[10px] uppercase text-muted-foreground">Alignment</Label>
                <AlignmentPicker value={props.alignment} onChange={(v) => onChange({ alignment: v as any })} />
            </div>

            <AssetPickerModal
                isOpen={isPickerOpen}
                onClose={() => setIsPickerOpen(false)}
                onSelect={(url) => {
                    onChange({ src: url })
                    setIsPickerOpen(false)
                }}
            />
        </div>
    )
}

function ButtonSettings({ props, onChange }: { props: ButtonProps; onChange: (p: Partial<ButtonProps>) => void }) {
    return (
        <div className="space-y-4">
            <div className="space-y-1">
                <Label className="text-[10px] uppercase text-muted-foreground">Button Text</Label>
                <Input value={props.text} onChange={(e) => onChange({ text: e.target.value })} className="text-sm" />
            </div>
            <div className="space-y-1">
                <Label className="text-[10px] uppercase text-muted-foreground">Link URL</Label>
                <Input value={props.url} onChange={(e) => onChange({ url: e.target.value })} className="text-sm font-mono" placeholder="{{cta_link_url}}" />
            </div>
            <ColorInput value={props.bgColor} onChange={(v) => onChange({ bgColor: v })} label="Background Color" />
            <ColorInput value={props.textColor} onChange={(v) => onChange({ textColor: v })} label="Text Color" />
            <NumberSlider value={props.borderRadius} onChange={(v) => onChange({ borderRadius: v })} label="Border Radius" min={0} max={50} />
            <NumberSlider value={props.fontSize} onChange={(v) => onChange({ fontSize: v })} label="Font Size" min={12} max={24} />
            <NumberSlider value={props.paddingX} onChange={(v) => onChange({ paddingX: v })} label="Horizontal Padding" min={8} max={60} />
            <NumberSlider value={props.paddingY} onChange={(v) => onChange({ paddingY: v })} label="Vertical Padding" min={4} max={30} />
            <div className="flex items-center justify-between">
                <Label className="text-[10px] uppercase text-muted-foreground">Full Width</Label>
                <Switch checked={props.fullWidth} onCheckedChange={(v) => onChange({ fullWidth: v })} />
            </div>
            <div className="space-y-1">
                <Label className="text-[10px] uppercase text-muted-foreground">Alignment</Label>
                <AlignmentPicker value={props.alignment} onChange={(v) => onChange({ alignment: v as any })} />
            </div>
        </div>
    )
}

function DividerSettings({ props, onChange }: { props: DividerProps; onChange: (p: Partial<DividerProps>) => void }) {
    return (
        <div className="space-y-4">
            <ColorInput value={props.color} onChange={(v) => onChange({ color: v })} label="Line Color" />
            <NumberSlider value={props.thickness} onChange={(v) => onChange({ thickness: v })} label="Thickness" min={1} max={8} />
            <NumberSlider value={props.widthPercent} onChange={(v) => onChange({ widthPercent: v })} label="Width" min={10} max={100} unit="%" />
            <div className="space-y-1">
                <Label className="text-[10px] uppercase text-muted-foreground">Style</Label>
                <Select value={props.style} onValueChange={(v) => onChange({ style: v as any })}>
                    <SelectTrigger className="h-8 text-xs"><SelectValue /></SelectTrigger>
                    <SelectContent>
                        <SelectItem value="solid">Solid</SelectItem>
                        <SelectItem value="dashed">Dashed</SelectItem>
                        <SelectItem value="dotted">Dotted</SelectItem>
                    </SelectContent>
                </Select>
            </div>
        </div>
    )
}

function SpacerSettings({ props, onChange }: { props: SpacerProps; onChange: (p: Partial<SpacerProps>) => void }) {
    return (
        <div className="space-y-4">
            <NumberSlider value={props.height} onChange={(v) => onChange({ height: v })} label="Height" min={4} max={120} />
        </div>
    )
}

function SocialSettings({ props, onChange }: { props: SocialProps; onChange: (p: Partial<SocialProps>) => void }) {
    const PLATFORMS: SocialNetwork['platform'][] = ['facebook', 'instagram', 'twitter', 'youtube', 'linkedin', 'tiktok']

    const updateNetwork = (index: number, field: keyof SocialNetwork, value: string) => {
        const updated = [...props.networks]
        updated[index] = { ...updated[index], [field]: value }
        onChange({ networks: updated })
    }

    const addNetwork = () => {
        const used = new Set(props.networks.map(n => n.platform))
        const next = PLATFORMS.find(p => !used.has(p))
        if (next) {
            onChange({ networks: [...props.networks, { platform: next, url: '' }] })
        }
    }

    const removeNetwork = (index: number) => {
        onChange({ networks: props.networks.filter((_, i) => i !== index) })
    }

    return (
        <div className="space-y-4">
            <div className="space-y-1">
                <Label className="text-[10px] uppercase text-muted-foreground">Alignment</Label>
                <AlignmentPicker value={props.alignment} onChange={(v) => onChange({ alignment: v as any })} />
            </div>
            <NumberSlider value={props.iconSize} onChange={(v) => onChange({ iconSize: v })} label="Icon Size" min={20} max={48} />
            <div className="space-y-2">
                <Label className="text-[10px] uppercase text-muted-foreground">Networks</Label>
                {props.networks.map((n, i) => (
                    <div key={i} className="flex items-center gap-2">
                        <Select value={n.platform} onValueChange={(v) => updateNetwork(i, 'platform', v)}>
                            <SelectTrigger className="h-8 text-xs w-[100px]"><SelectValue /></SelectTrigger>
                            <SelectContent>
                                {PLATFORMS.map(p => <SelectItem key={p} value={p}>{p.charAt(0).toUpperCase() + p.slice(1)}</SelectItem>)}
                            </SelectContent>
                        </Select>
                        <Input
                            value={n.url}
                            onChange={(e) => updateNetwork(i, 'url', e.target.value)}
                            className="h-8 text-xs flex-1"
                            placeholder="https://..."
                        />
                        <button onClick={() => removeNetwork(i)} className="text-red-500 hover:text-red-700 text-xs px-1">×</button>
                    </div>
                ))}
                {props.networks.length < PLATFORMS.length && (
                    <button onClick={addNetwork} className="text-xs text-primary hover:underline">+ Add network</button>
                )}
            </div>
        </div>
    )
}

// --- Main Component ---

export function BlockSettings({ block, onUpdate }: BlockSettingsProps) {
    const handleChange = useCallback((partial: Record<string, any>) => {
        if (!block) return
        onUpdate(block.id, { ...block.props, ...partial })
    }, [block, onUpdate])

    if (!block) {
        return (
            <div className="flex flex-col items-center justify-center h-full text-muted-foreground p-6">
                <Settings className="w-8 h-8 mb-3 opacity-30" />
                <p className="text-sm text-center">Select a block to edit its properties</p>
            </div>
        )
    }

    return (
        <div className="flex flex-col h-full">
            <div className="p-3 border-b border-border bg-muted/20">
                <p className="text-xs font-semibold text-foreground">{BLOCK_LABELS[block.type]}</p>
                <p className="text-[10px] text-muted-foreground">Edit the properties below</p>
            </div>
            <ScrollArea className="flex-1">
                <div className="p-4">
                    {block.type === 'heading' && <HeadingSettings props={block.props as HeadingProps} onChange={handleChange} />}
                    {block.type === 'text' && <TextSettings props={block.props as TextProps} onChange={handleChange} />}
                    {block.type === 'image' && <ImageSettings props={block.props as ImageProps} onChange={handleChange} />}
                    {block.type === 'button' && <ButtonSettings props={block.props as ButtonProps} onChange={handleChange} />}
                    {block.type === 'divider' && <DividerSettings props={block.props as DividerProps} onChange={handleChange} />}
                    {block.type === 'spacer' && <SpacerSettings props={block.props as SpacerProps} onChange={handleChange} />}
                    {block.type === 'social' && <SocialSettings props={block.props as SocialProps} onChange={handleChange} />}
                </div>
            </ScrollArea>
        </div>
    )
}
</file>

<file path="components/dnd-editor/dnd-editor.tsx">
"use client"

import { useState, useMemo, useCallback, useRef, useEffect } from "react"
import { Monitor, Smartphone, ArrowLeft, Loader2, Check, Eye, Pencil, ChevronDown } from "lucide-react"
import Link from "next/link"
import { cn } from "@/lib/utils"
import { ScrollArea } from "@/components/ui/scroll-area"

import { BlockPalette } from "./block-palette"
import { DndCanvas } from "./dnd-canvas"
import { BlockSettings } from "./block-settings"
import { DndCopilotPane } from "./dnd-copilot-pane"

import type { EmailBlock, BlockType, EmailDesign } from "@/lib/dnd-blocks/types"
import { BLOCK_DEFAULTS } from "@/lib/dnd-blocks/defaults"
import { compileBlocksToHtml } from "@/lib/dnd-blocks/compiler"
import { renderTemplate } from "@/lib/render-template"

interface DndEmailEditorProps {
    blocks: EmailDesign
    assets: Record<string, string>
    subjectLine: string
    fromName: string
    fromEmail: string
    audienceContext: "dreamplay" | "musicalbasics" | "both"
    aiDossier?: string
    onBlocksChange: (blocks: EmailDesign) => void
    onAssetsChange: (assets: Record<string, string>) => void
    onSubjectChange: (value: string) => void
    onSenderChange: (field: "name" | "email", value: string) => void
    onAudienceChange: (value: "dreamplay" | "musicalbasics" | "both") => void
    campaignName: string
    onNameChange: (name: string) => void
    onSave?: () => void
    onSaveAsNew?: () => void
    isExisting?: boolean
}

export function DndEmailEditor({
    blocks,
    assets,
    subjectLine,
    fromName,
    fromEmail,
    audienceContext,
    aiDossier,
    onBlocksChange,
    onAssetsChange,
    onSubjectChange,
    onSenderChange,
    onAudienceChange,
    campaignName,
    onNameChange,
    onSave,
    onSaveAsNew,
    isExisting,
}: DndEmailEditorProps) {
    const [selectedBlockId, setSelectedBlockId] = useState<string | null>(null)
    const [viewMode, setViewMode] = useState<'desktop' | 'mobile'>('desktop')
    const [mode, setMode] = useState<'edit' | 'preview'>('edit')
    const [saveStatus, setSaveStatus] = useState<'idle' | 'saving' | 'success'>('idle')
    const [saveDropdownOpen, setSaveDropdownOpen] = useState(false)
    const saveDropdownRef = useRef<HTMLDivElement>(null)

    // Close dropdown when clicking outside
    useEffect(() => {
        const handleClick = (e: MouseEvent) => {
            if (saveDropdownRef.current && !saveDropdownRef.current.contains(e.target as Node)) {
                setSaveDropdownOpen(false)
            }
        }
        if (saveDropdownOpen) document.addEventListener('mousedown', handleClick)
        return () => document.removeEventListener('mousedown', handleClick)
    }, [saveDropdownOpen])

    const selectedBlock = useMemo(
        () => blocks.find(b => b.id === selectedBlockId) || null,
        [blocks, selectedBlockId]
    )

    // Extract mustache variables from all block props
    const extractedVariables = useMemo(() => {
        const regex = /\{\{(\w+)\}\}/g
        const matches = new Set<string>()
        const jsonStr = JSON.stringify(blocks)
        let match
        while ((match = regex.exec(jsonStr)) !== null) {
            matches.add(match[1])
        }
        return Array.from(matches)
    }, [blocks])

    const updateAsset = useCallback((key: string, value: string) => {
        onAssetsChange({ ...assets, [key]: value })
    }, [assets, onAssetsChange])

    // Compile blocks → HTML → replace mustache vars for preview
    const compiledHtml = useMemo(() => compileBlocksToHtml(blocks), [blocks])
    const previewHtml = useMemo(() => renderTemplate(compiledHtml, assets), [compiledHtml, assets])

    // --- Handlers ---

    const addBlock = (type: BlockType) => {
        const newBlock: EmailBlock = {
            id: `block-${Date.now()}-${Math.random().toString(36).slice(2, 7)}`,
            type,
            props: { ...BLOCK_DEFAULTS[type] } as any,
        }
        onBlocksChange([...blocks, newBlock])
        setSelectedBlockId(newBlock.id)
    }

    const updateBlockProps = useCallback((id: string, newProps: Record<string, any>) => {
        onBlocksChange(blocks.map(b => b.id === id ? { ...b, props: newProps } as any : b))
    }, [blocks, onBlocksChange])

    const handleCopilotUpdate = (newBlocks: EmailBlock[], prompt: string) => {
        onBlocksChange(newBlocks)
        if (newBlocks.length > 0) {
            setSelectedBlockId(newBlocks[0].id)
        }
    }

    const handleSaveClick = async () => {
        if (!onSave) return
        setSaveStatus('saving')
        await Promise.resolve(onSave())
        setSaveStatus('success')
        setTimeout(() => setSaveStatus('idle'), 2000)
    }

    return (
        <div className="flex h-screen bg-background text-foreground overflow-hidden">
            {/* === LEFT SIDEBAR: Palette + Settings + Assets === */}
            <div className="flex-shrink-0 w-[280px] border-r border-border h-full flex flex-col bg-card">
                {/* Back Link */}
                <div className="p-3 border-b border-border">
                    <Link href="/admin" className="inline-flex items-center gap-1 text-xs text-muted-foreground hover:text-foreground transition-colors">
                        <ArrowLeft className="w-3 h-3" />
                        Back to Dashboard
                    </Link>
                </div>

                {/* Campaign Settings (compact) */}
                <div className="p-3 border-b border-border bg-muted/20 space-y-2">
                    <div className="space-y-1">
                        <label className="text-[10px] uppercase font-semibold text-muted-foreground">Campaign Name</label>
                        <input
                            type="text"
                            value={campaignName}
                            onChange={(e) => onNameChange(e.target.value)}
                            className="w-full bg-background border border-border rounded px-2 py-1 text-xs focus:outline-none focus:border-primary"
                            placeholder="Campaign Name"
                        />
                    </div>
                    <div className="space-y-1">
                        <label className="text-[10px] uppercase font-semibold text-muted-foreground">Subject Line</label>
                        <input
                            type="text"
                            value={subjectLine}
                            onChange={(e) => onSubjectChange(e.target.value)}
                            className="w-full bg-background border border-border rounded px-2 py-1 text-xs focus:outline-none focus:border-primary"
                            placeholder="Enter subject line..."
                        />
                    </div>
                    <div className="grid grid-cols-2 gap-2">
                        <div className="space-y-1">
                            <label className="text-[10px] uppercase font-semibold text-muted-foreground">From Name</label>
                            <input type="text" value={fromName} onChange={(e) => onSenderChange("name", e.target.value)} className="w-full bg-background border border-border rounded px-2 py-1 text-xs focus:outline-none focus:border-primary" />
                        </div>
                        <div className="space-y-1">
                            <label className="text-[10px] uppercase font-semibold text-muted-foreground">From Email</label>
                            <input type="text" value={fromEmail} onChange={(e) => onSenderChange("email", e.target.value)} className="w-full bg-background border border-border rounded px-2 py-1 text-xs focus:outline-none focus:border-primary" />
                        </div>
                    </div>
                    <div className="space-y-1">
                        <label className="text-[10px] uppercase font-semibold text-muted-foreground">Target Audience</label>
                        <select
                            value={audienceContext}
                            onChange={(e) => onAudienceChange(e.target.value as any)}
                            className="w-full bg-background border border-border rounded px-2 py-1 text-xs focus:outline-none focus:border-primary cursor-pointer"
                        >
                            <option value="dreamplay">DreamPlay</option>
                            <option value="musicalbasics">MusicalBasics</option>
                            <option value="both">Both (Crossover)</option>
                        </select>
                    </div>
                </div>

                {/* Block Palette */}
                <div className="border-b border-border">
                    <BlockPalette onAddBlock={addBlock} />
                </div>

                {/* Assets */}
                {extractedVariables.length > 0 && (
                    <ScrollArea className="flex-1">
                        <div className="p-3 space-y-2">
                            <p className="text-[10px] uppercase font-semibold text-muted-foreground">Variables</p>
                            {extractedVariables.map(v => (
                                <div key={v} className="space-y-0.5">
                                    <label className="text-[10px] text-muted-foreground font-mono">{`{{${v}}}`}</label>
                                    <input
                                        type="text"
                                        value={assets[v] || ""}
                                        onChange={(e) => updateAsset(v, e.target.value)}
                                        className="w-full bg-background border border-border rounded px-2 py-1 text-xs focus:outline-none focus:border-primary"
                                        placeholder={v.includes('src') || v.includes('img') || v.includes('image') ? 'Image URL' : 'Value'}
                                    />
                                </div>
                            ))}
                        </div>
                    </ScrollArea>
                )}
            </div>

            {/* === CENTER: Canvas or Preview === */}
            <div className="flex-1 flex flex-col min-w-[400px] h-full overflow-hidden">
                {/* Toolbar */}
                <div className="h-12 border-b border-border flex items-center justify-between px-4 bg-card flex-shrink-0">
                    <div className="flex items-center gap-2">
                        {/* Edit / Preview toggle */}
                        <div className="flex bg-muted p-0.5 rounded-lg">
                            <button onClick={() => setMode('edit')} className={cn("px-3 py-1 rounded-md text-xs font-medium flex items-center gap-1.5 transition-colors", mode === 'edit' ? "bg-background shadow-sm" : "hover:bg-background/50")}>
                                <Pencil className="w-3 h-3" /> Edit
                            </button>
                            <button onClick={() => setMode('preview')} className={cn("px-3 py-1 rounded-md text-xs font-medium flex items-center gap-1.5 transition-colors", mode === 'preview' ? "bg-background shadow-sm" : "hover:bg-background/50")}>
                                <Eye className="w-3 h-3" /> Preview
                            </button>
                        </div>

                        {mode === 'preview' && (
                            <div className="flex bg-muted p-0.5 rounded-lg ml-2">
                                <button onClick={() => setViewMode('desktop')} className={cn("p-1.5 rounded-md", viewMode === 'desktop' && "bg-background shadow-sm")}>
                                    <Monitor className="w-3.5 h-3.5" />
                                </button>
                                <button onClick={() => setViewMode('mobile')} className={cn("p-1.5 rounded-md", viewMode === 'mobile' && "bg-background shadow-sm")}>
                                    <Smartphone className="w-3.5 h-3.5" />
                                </button>
                            </div>
                        )}
                    </div>

                    <div className="flex items-center gap-2">
                        <span className="text-xs text-muted-foreground">{blocks.length} blocks</span>
                        {onSave && (
                            <div className="relative" ref={saveDropdownRef}>
                                <div className="flex">
                                    {/* Main save button */}
                                    <button
                                        type="button"
                                        onClick={handleSaveClick}
                                        disabled={saveStatus === 'saving'}
                                        className={cn(
                                            "px-4 py-1.5 rounded-l-md text-sm font-medium flex items-center gap-2",
                                            saveStatus === 'success' ? "bg-green-600 text-white" : "bg-primary text-primary-foreground"
                                        )}
                                    >
                                        {saveStatus === 'saving' && <Loader2 className="w-3.5 h-3.5 animate-spin" />}
                                        {saveStatus === 'success' && <Check className="w-3.5 h-3.5" />}
                                        {saveStatus === 'idle' && (isExisting ? "Save" : "Save")}
                                    </button>
                                    {/* Dropdown chevron */}
                                    <button
                                        type="button"
                                        onClick={() => setSaveDropdownOpen(!saveDropdownOpen)}
                                        className={cn(
                                            "px-1.5 py-1.5 rounded-r-md border-l border-primary-foreground/20 text-sm",
                                            saveStatus === 'success' ? "bg-green-600 text-white" : "bg-primary text-primary-foreground"
                                        )}
                                    >
                                        <ChevronDown className="w-3.5 h-3.5" />
                                    </button>
                                </div>
                                {/* Dropdown menu */}
                                {saveDropdownOpen && (
                                    <div className="absolute right-0 top-full mt-1 w-44 bg-card border border-border rounded-md shadow-lg z-50 py-1">
                                        <button
                                            onClick={() => { setSaveDropdownOpen(false); handleSaveClick() }}
                                            className="w-full text-left px-3 py-2 text-sm hover:bg-muted transition-colors"
                                        >
                                            {isExisting ? 'Save (Overwrite)' : 'Save'}
                                        </button>
                                        {onSaveAsNew && (
                                            <button
                                                onClick={() => { setSaveDropdownOpen(false); onSaveAsNew() }}
                                                className="w-full text-left px-3 py-2 text-sm hover:bg-muted transition-colors"
                                            >
                                                Save as New
                                            </button>
                                        )}
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>

                {/* Content area */}
                {mode === 'edit' ? (
                    <div className="flex-1 bg-[#f0f0f2] overflow-hidden">
                        <DndCanvas
                            blocks={blocks}
                            selectedBlockId={selectedBlockId}
                            onSelectBlock={setSelectedBlockId}
                            onUpdateBlocks={onBlocksChange}
                        />
                    </div>
                ) : (
                    <div className="flex-1 overflow-y-auto bg-[#0f0f10] p-8">
                        <div className="mx-auto transition-all duration-300 bg-white shadow-lg" style={{ maxWidth: viewMode === 'mobile' ? '375px' : '600px' }}>
                            <iframe
                                srcDoc={previewHtml}
                                className="w-full border-0"
                                style={{ minHeight: 600 }}
                                title="Email Preview"
                            />
                        </div>
                    </div>
                )}
            </div>

            {/* === RIGHT SIDEBAR: Block Settings + Copilot === */}
            <div className="flex-shrink-0 w-[320px] border-l border-border bg-card h-full flex flex-col">
                {/* Settings panel (top half) */}
                <div className="flex-1 border-b border-border overflow-hidden">
                    <BlockSettings block={selectedBlock} onUpdate={updateBlockProps} />
                </div>

                {/* Copilot (bottom half) */}
                <div className="h-[45%] overflow-hidden">
                    <DndCopilotPane blocks={blocks} onBlocksChange={handleCopilotUpdate} audienceContext={audienceContext} aiDossier={aiDossier} />
                </div>
            </div>
        </div>
    )
}
</file>

<file path="components/editor/asset-loader.tsx">
"use client"

import { useState, useEffect } from "react"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { Button } from "@/components/ui/button"
import { Textarea } from "@/components/ui/textarea"
import {
    Select,
    SelectContent,
    SelectItem,
    SelectTrigger,
    SelectValue,
} from "@/components/ui/select"
import Link from "next/link"
import { Upload, ImageIcon, ArrowLeft, Bookmark } from "lucide-react"
import { AssetPickerModal } from "./asset-picker-modal"
import { getDefaultLinks, getCustomLinks, type DefaultLinks, type CustomLink } from "@/app/actions/settings"

interface AssetLoaderProps {
    variables: string[]
    assets: Record<string, string>
    onUpdateAsset: (key: string, value: string) => void
    showBackButton?: boolean
}

export function AssetLoader({ variables, assets, onUpdateAsset, showBackButton = true }: AssetLoaderProps) {
    const [activeVariable, setActiveVariable] = useState<string | null>(null)
    const [savedLinks, setSavedLinks] = useState<DefaultLinks | null>(null)
    const [customLinks, setCustomLinks] = useState<CustomLink[]>([])

    useEffect(() => {
        Promise.all([
            getDefaultLinks("dreamplay"),
            getCustomLinks("dreamplay"),
        ]).then(([defaults, custom]) => {
            setSavedLinks(defaults)
            setCustomLinks(custom)
        })
    }, [])

    // Build non-empty saved links for the dropdown (default + custom)
    const linkEntries = [
        ...(savedLinks
            ? Object.entries(savedLinks)
                .filter(([_, v]) => v && v.trim() !== "")
                .map(([key, url]) => ({ label: key.replace(/_/g, " ").replace(/\b\w/g, c => c.toUpperCase()), url }))
            : []),
        ...customLinks
            .filter(cl => cl.label && cl.url)
            .map(cl => ({ label: cl.label, url: cl.url })),
    ]

    const isImageVariable = (variable: string) => {
        const lower = variable.toLowerCase()
        if (lower.endsWith("_fit")) return false
        if (lower.endsWith("_link_url") || lower.includes("link_url")) return false
        // Exclude known page/action link variables
        if (lower === "unsubscribe_url" || lower === "privacy_url" || lower === "contact_url" ||
            lower === "about_url" || lower === "homepage_url" || lower === "shipping_url" ||
            lower === "main_cta_url" || lower === "crowdfunding_cta_url") return false
        return lower.includes("image") || lower.includes("url") || lower.endsWith("_src") || lower.endsWith("_bg") || lower.endsWith("_logo") || lower.endsWith("_icon") || lower.endsWith("_img")
    }

    const isLinkVariable = (variable: string) => {
        const lower = variable.toLowerCase()
        return lower.endsWith("_link_url") || lower.includes("link_url")
    }

    const isTextAreaVariable = (variable: string) => {
        const lower = variable.toLowerCase()
        return lower.includes("text") || lower.includes("paragraph")
    }

    const isFitVariable = (variable: string) => {
        return variable.toLowerCase().endsWith("_fit")
    }

    // Find the matching image variable for a link variable
    // e.g. "lifestyle_link_url" → looks for "lifestyle_img", "lifestyle_src", etc.
    const findPairedImageVar = (linkVar: string): string | null => {
        const prefix = linkVar.replace(/_?link_url$/i, "")
        if (!prefix) return null
        return variables.find(v => {
            const lower = v.toLowerCase()
            return lower.startsWith(prefix.toLowerCase()) && isImageVariable(v)
        }) || null
    }

    // Find the matching link variable for an image variable
    // Handles: "lifestyle_img" + "lifestyle_link_url", "video_thumbnail_src" + "video_link_url"
    const findPairedLinkVar = (imageVar: string): string | null => {
        // Extract prefix: "lifestyle_img" → "lifestyle", "hero_src" → "hero", "video_thumbnail_src" → "video_thumbnail"
        const prefix = imageVar.replace(/(_img|_src|_bg|_logo|_icon|_image|_thumbnail_src|_thumbnail)$/i, "")
        if (!prefix || prefix === imageVar) return null

        // Look for exact match first: e.g. lifestyle → lifestyle_link_url
        const exactMatch = variables.find(v => {
            const lower = v.toLowerCase()
            return lower === `${prefix.toLowerCase()}_link_url` || lower === `${prefix.toLowerCase()}link_url`
        })
        if (exactMatch) return exactMatch

        // Fallback: check if any link var's prefix is a prefix of the image var
        // e.g. video_link_url → prefix "video" is a prefix of "video_thumbnail_src"
        return variables.find(v => {
            if (!isLinkVariable(v)) return false
            const linkPrefix = v.replace(/_?link_url$/i, "").toLowerCase()
            return linkPrefix && prefix.toLowerCase().startsWith(linkPrefix)
        }) || null
    }

    const handleImageUpload = (variable: string) => {
        setActiveVariable(variable)
    }

    const handleAssetSelect = (url: string) => {
        if (activeVariable) {
            onUpdateAsset(activeVariable, url)
        }
    }

    // Build grouped variables: skip link vars that are paired with an image (they'll render inside the image card)
    const pairedLinkVars = new Set<string>()
    variables.forEach(v => {
        if (isImageVariable(v)) {
            const linkVar = findPairedLinkVar(v)
            if (linkVar) pairedLinkVars.add(linkVar)
        }
    })

    // Also skip standalone _fit vars that are paired with images (they render inline)
    const pairedFitVars = new Set<string>()
    variables.forEach(v => {
        if (isImageVariable(v)) {
            const fitKey = `${v}_fit`
            if (variables.includes(fitKey)) pairedFitVars.add(fitKey)
        }
    })

    const displayVariables = variables.filter(v => !pairedLinkVars.has(v) && !pairedFitVars.has(v))

    return (
        <aside className="w-full h-full flex flex-col bg-card overflow-hidden">
            <div className="p-4 border-b border-border">
                {showBackButton && (
                    <Link href="/admin" className="mb-4 inline-flex items-center gap-1 text-xs text-muted-foreground hover:text-foreground transition-colors">
                        <ArrowLeft className="w-3 h-3" />
                        Back to Dashboard
                    </Link>
                )}
                <div className="flex items-center gap-2">
                    <ImageIcon className="w-4 h-4 text-primary" />
                    <h2 className="text-sm font-semibold text-foreground">
                        Asset Loader
                    </h2>
                </div>
                <p className="text-xs text-muted-foreground mt-1">Variables detected in your template</p>
            </div>

            <div className="flex-1 overflow-y-auto p-4 space-y-4">
                {displayVariables.length === 0 ? (
                    <p className="text-sm text-muted-foreground">No variables found. Add {"{{variable_name}}"} to your code.</p>
                ) : (
                    displayVariables.map((variable) => {
                        // ─── Image variable: render as a grouped card with optional link + fit ───
                        if (isImageVariable(variable)) {
                            const pairedLink = findPairedLinkVar(variable)
                            return (
                                <div key={variable} className="rounded-lg border-l-4 border-l-primary/60 border border-border bg-muted/50 p-3 space-y-3">
                                    {/* Image source */}
                                    <div className="space-y-1.5">
                                        <Label htmlFor={variable} className="text-xs font-mono text-muted-foreground">
                                            {`{{${variable}}}`}
                                        </Label>
                                        <div className="flex gap-2">
                                            <Input
                                                id={variable}
                                                value={assets[variable] || ""}
                                                onChange={(e) => onUpdateAsset(variable, e.target.value)}
                                                placeholder={`Image URL`}
                                                className="flex-1 text-sm bg-muted border-border font-mono"
                                            />
                                            <Button
                                                variant="outline"
                                                size="icon"
                                                onClick={() => handleImageUpload(variable)}
                                                title="Upload/Select Image"
                                                className="flex-shrink-0"
                                            >
                                                <Upload className="w-4 h-4" />
                                            </Button>
                                        </div>
                                    </div>

                                    {/* Fit Control */}
                                    <div className="flex gap-2 items-center">
                                        <Label className="text-xs text-muted-foreground w-12">Fit:</Label>
                                        <Select
                                            value={assets[`${variable}_fit`] || "cover"}
                                            onValueChange={(value) => onUpdateAsset(`${variable}_fit`, value)}
                                        >
                                            <SelectTrigger className="h-8 text-xs">
                                                <SelectValue placeholder="Fit" />
                                            </SelectTrigger>
                                            <SelectContent>
                                                <SelectItem value="cover">Cover</SelectItem>
                                                <SelectItem value="contain">Contain</SelectItem>
                                                <SelectItem value="fill">Fill</SelectItem>
                                                <SelectItem value="scale-down">Scale Down</SelectItem>
                                            </SelectContent>
                                        </Select>
                                    </div>

                                    {/* Paired link URL */}
                                    {pairedLink && (
                                        <div className="space-y-1.5">
                                            <Label htmlFor={pairedLink} className="text-xs font-mono text-muted-foreground">
                                                {`{{${pairedLink}}}`}
                                            </Label>
                                            <div className="flex gap-1">
                                                <Input
                                                    id={pairedLink}
                                                    value={assets[pairedLink] || ""}
                                                    onChange={(e) => onUpdateAsset(pairedLink, e.target.value)}
                                                    placeholder="Link destination URL"
                                                    className="flex-1 text-sm bg-muted border-border font-mono"
                                                />
                                                {linkEntries.length > 0 && (
                                                    <Select onValueChange={(url) => onUpdateAsset(pairedLink, url)}>
                                                        <SelectTrigger className="w-9 h-9 p-0 flex-shrink-0" title="Insert saved link">
                                                            <Bookmark className="w-3.5 h-3.5" />
                                                        </SelectTrigger>
                                                        <SelectContent align="end">
                                                            {linkEntries.map(({ label, url }) => (
                                                                <SelectItem key={label} value={url}>
                                                                    <span className="text-xs">{label}</span>
                                                                </SelectItem>
                                                            ))}
                                                        </SelectContent>
                                                    </Select>
                                                )}
                                            </div>
                                        </div>
                                    )}

                                    {/* Image preview */}
                                    {assets[variable] && (
                                        <div className="rounded border border-border overflow-hidden bg-muted/50 flex items-center justify-center p-2">
                                            <img
                                                src={assets[variable]}
                                                alt={variable}
                                                className="max-w-full max-h-32 object-contain"
                                                style={{
                                                    objectFit: (assets[`${variable}_fit`] as any) || "cover",
                                                    width: '100%',
                                                    height: '100px'
                                                }}
                                                onError={(e) => {
                                                    e.currentTarget.style.display = "none"
                                                }}
                                            />
                                        </div>
                                    )}
                                </div>
                            )
                        }

                        // ─── Standalone link variable (not paired with any image) ───
                        if (isLinkVariable(variable)) {
                            return (
                                <div key={variable} className="space-y-2">
                                    <Label htmlFor={variable} className="text-xs font-mono text-muted-foreground">
                                        {`{{${variable}}}`}
                                    </Label>
                                    <div className="flex gap-1">
                                        <Input
                                            id={variable}
                                            value={assets[variable] || ""}
                                            onChange={(e) => onUpdateAsset(variable, e.target.value)}
                                            placeholder="Link destination URL"
                                            className="flex-1 text-sm bg-muted border-border font-mono"
                                        />
                                        {linkEntries.length > 0 && (
                                            <Select onValueChange={(url) => onUpdateAsset(variable, url)}>
                                                <SelectTrigger className="w-9 h-9 p-0 flex-shrink-0" title="Insert saved link">
                                                    <Bookmark className="w-3.5 h-3.5" />
                                                </SelectTrigger>
                                                <SelectContent align="end">
                                                    {linkEntries.map(({ label, url }) => (
                                                        <SelectItem key={label} value={url}>
                                                            <span className="text-xs">{label}</span>
                                                        </SelectItem>
                                                    ))}
                                                </SelectContent>
                                            </Select>
                                        )}
                                    </div>
                                </div>
                            )
                        }

                        // ─── Textarea variable ───
                        if (isTextAreaVariable(variable)) {
                            return (
                                <div key={variable} className="space-y-2">
                                    <Label htmlFor={variable} className="text-xs font-mono text-muted-foreground">
                                        {`{{${variable}}}`}
                                    </Label>
                                    <Textarea
                                        id={variable}
                                        value={assets[variable] || ""}
                                        onChange={(e) => onUpdateAsset(variable, e.target.value)}
                                        placeholder={`Enter ${variable}`}
                                        className="text-sm bg-muted border-border font-mono min-h-[100px] resize-y"
                                        rows={4}
                                    />
                                </div>
                            )
                        }

                        // ─── Fit variable (standalone, not paired) ───
                        if (isFitVariable(variable)) {
                            return (
                                <div key={variable} className="space-y-2">
                                    <Label htmlFor={variable} className="text-xs font-mono text-muted-foreground">
                                        {`{{${variable}}}`}
                                    </Label>
                                    <Select
                                        value={assets[variable] || "cover"}
                                        onValueChange={(value) => onUpdateAsset(variable, value)}
                                    >
                                        <SelectTrigger className="w-full">
                                            <SelectValue placeholder="Select fit" />
                                        </SelectTrigger>
                                        <SelectContent>
                                            <SelectItem value="cover">Cover</SelectItem>
                                            <SelectItem value="contain">Contain</SelectItem>
                                            <SelectItem value="fill">Fill</SelectItem>
                                            <SelectItem value="scale-down">Scale Down</SelectItem>
                                        </SelectContent>
                                    </Select>
                                </div>
                            )
                        }

                        // ─── Default: plain text input ───
                        return (
                            <div key={variable} className="space-y-2">
                                <Label htmlFor={variable} className="text-xs font-mono text-muted-foreground">
                                    {`{{${variable}}}`}
                                </Label>
                                <Input
                                    id={variable}
                                    value={assets[variable] || ""}
                                    onChange={(e) => onUpdateAsset(variable, e.target.value)}
                                    placeholder={`Enter ${variable}`}
                                    className="flex-1 text-sm bg-muted border-border font-mono"
                                />
                            </div>
                        )
                    })
                )}
            </div>

            <AssetPickerModal
                isOpen={!!activeVariable}
                onClose={() => setActiveVariable(null)}
                onSelect={handleAssetSelect}
            />
        </aside>
    )
}
</file>

<file path="app/(site)/blog/client-page.tsx">
"use client";

import { useState, useMemo } from "react";
import type { BlogPost } from "@/lib/blog-data";
import { FeaturedPost } from "@/components/blog/featured-post";
import { BlogCard } from "@/components/blog/blog-card";
import { CategoryFilter } from "@/components/blog/category-filter";
import { NewsletterForm } from "@/components/blog/newsletter-form";
import { BlogHeader } from "@/components/blog/blog-header";
import { Music } from "lucide-react";

type Category = "all" | "tutorials" | "artist-stories" | "product-news";

interface BlogClientPageProps {
    posts: BlogPost[];
}

export default function BlogClientPage({ posts }: BlogClientPageProps) {
    const [activeCategory, setActiveCategory] = useState<Category>("all");
    const [searchQuery, setSearchQuery] = useState("");

    const featuredPost = useMemo(() => posts.find((post) => post.featured), [posts]);

    const filteredPosts = useMemo(() => {
        let filtered = posts.filter((post) => !post.featured);

        if (activeCategory !== "all") {
            filtered = filtered.filter((post) => post.category === activeCategory);
        }

        if (searchQuery.trim()) {
            const query = searchQuery.toLowerCase();
            filtered = filtered.filter(
                (post) =>
                    post.title.toLowerCase().includes(query) ||
                    post.excerpt.toLowerCase().includes(query)
            );
        }

        return filtered;
    }, [posts, activeCategory, searchQuery]);

    return (
        <div className="min-h-screen bg-[#050505] text-white font-sans selection:bg-white/20">
            <BlogHeader forceOpaque={true} darkMode={true} />

            <main className="pt-[100px] md:pt-[120px]">
                {/* Hero Section */}
                <section className="px-6 py-12 md:py-20 lg:py-24">
                    <div className="mx-auto max-w-6xl text-center">
                        <p className="font-sans text-[10px] uppercase tracking-[0.3em] text-white/50 mb-4 font-bold">Discover</p>
                        <h1 className="mb-6 font-serif text-5xl md:text-6xl lg:text-7xl font-semibold tracking-tight text-white leading-tight">
                            The DreamPlay Journal
                        </h1>
                        <p className="mx-auto max-w-2xl font-sans text-sm md:text-base text-white/60 leading-relaxed">
                            Read the latest news, tutorials, and artist stories from the world of narrow & ergonomic keyboards.
                        </p>
                    </div>
                </section>

                {/* Featured Post */}
                {featuredPost && (
                    <section className="px-6 pb-12 md:pb-24">
                        <div className="mx-auto max-w-6xl">
                            <FeaturedPost post={featuredPost} />
                        </div>
                    </section>
                )}

                {/* Filter & Grid Section */}
                <section className="border-t border-white/10 px-6 py-16 md:py-24 bg-[#0a0a0f]">
                    <div className="mx-auto max-w-6xl">
                        <div className="mb-12">
                            <CategoryFilter
                                activeCategory={activeCategory}
                                onCategoryChange={setActiveCategory}
                                searchQuery={searchQuery}
                                onSearchChange={setSearchQuery}
                            />
                        </div>

                        {filteredPosts.length > 0 ? (
                            <div className="grid gap-6 md:gap-8 sm:grid-cols-2 lg:grid-cols-3">
                                {filteredPosts.map((post) => (
                                    <BlogCard key={post.id} post={post} />
                                ))}
                            </div>
                        ) : (
                            <div className="py-24 text-center border border-white/10 bg-[#050505]">
                                <p className="font-sans text-sm text-white/60">
                                    No articles found matching your criteria.
                                </p>
                                <button
                                    type="button"
                                    onClick={() => {
                                        setActiveCategory("all");
                                        setSearchQuery("");
                                    }}
                                    className="mt-6 inline-block border border-white/30 px-6 py-3 font-sans text-[10px] font-bold uppercase tracking-widest text-white transition-colors hover:bg-white hover:text-black cursor-pointer"
                                >
                                    Clear filters
                                </button>
                            </div>
                        )}
                    </div>
                </section>

                {/* Newsletter Section */}
                <NewsletterForm />
            </main>

            {/* Footer */}
            <footer className="border-t border-white/10 px-6 py-12 bg-[#050505]">
                <div className="mx-auto flex max-w-6xl flex-col items-center justify-between gap-6 sm:flex-row">
                    <div className="flex items-center gap-2">
                        <Music className="h-5 w-5 text-white/50" />
                        <span className="font-serif text-lg tracking-wide text-white">DreamPlay Pianos</span>
                    </div>
                    <div className="flex gap-6">
                        <a href="https://www.dreamplaypianos.com/privacy" className="font-sans text-[10px] uppercase tracking-[0.2em] text-white/40 hover:text-white transition-colors">Privacy</a>
                        <a href="https://www.dreamplaypianos.com/terms" className="font-sans text-[10px] uppercase tracking-[0.2em] text-white/40 hover:text-white transition-colors">Terms</a>
                    </div>
                    <p className="font-sans text-[10px] uppercase tracking-[0.2em] text-white/40">
                        © 2026 DreamPlay Pianos.
                    </p>
                </div>
            </footer>
        </div>
    );
}
</file>

<file path="app/actions/assets.ts">
"use server"

import { createClient } from "@supabase/supabase-js"
import { createHash } from "crypto"

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!
const supabaseServiceKey = process.env.SUPABASE_SERVICE_KEY!

function getSupabase() {
    return createClient(supabaseUrl, supabaseServiceKey)
}

// ─────────────────────────────────────────────
//  UPLOAD — Content-Addressable (SHA-256 hash)
// ─────────────────────────────────────────────

export async function uploadHashedAsset(formData: FormData, folderPath: string) {
    const supabase = getSupabase()
    const file = formData.get("file") as File
    if (!file) return { success: false, error: "No file provided" }

    // 1. Hash file content → deterministic filename
    const buffer = await file.arrayBuffer()
    const hashHex = createHash("sha256").update(Buffer.from(buffer)).digest("hex")
    const ext = file.name.substring(file.name.lastIndexOf("."))
    const storageFilename = `${hashHex}${ext}`

    // 2. Upload to bucket (silently deduplicates — upsert: false ignores if exists)
    await supabase.storage
        .from("email-assets")
        .upload(storageFilename, Buffer.from(buffer), {
            contentType: file.type,
            upsert: false,
        })

    // 3. Build permanent public URL
    const { data: urlData } = supabase.storage
        .from("email-assets")
        .getPublicUrl(storageFilename)

    // 4. Create DB record (user-facing view)
    const { data, error } = await supabase
        .from("media_assets")
        .insert({
            filename: file.name,
            folder_path: folderPath || "",
            storage_hash: storageFilename,
            public_url: urlData.publicUrl,
            size: file.size,
            is_deleted: false,
        })
        .select()
        .single()

    if (error) return { success: false, error: error.message }
    return { success: true, asset: data }
}

// ─────────────────────────────────────────────
//  SOFT DELETE — bucket files are NEVER removed
// ─────────────────────────────────────────────

export async function deleteAsset(assetId: string) {
    const supabase = getSupabase()
    const { error } = await supabase
        .from("media_assets")
        .update({ is_deleted: true })
        .eq("id", assetId)

    if (error) return { success: false, error: error.message }
    return { success: true }
}

export async function deleteAssets(assetIds: string[]) {
    const supabase = getSupabase()
    const { error } = await supabase
        .from("media_assets")
        .update({ is_deleted: true })
        .in("id", assetIds)

    if (error) return { success: false, error: error.message }
    return { success: true }
}

// ─────────────────────────────────────────────
//  VIRTUAL MOVE — only changes folder_path in DB
// ─────────────────────────────────────────────

export async function moveAsset(assetId: string, newFolderPath: string) {
    const supabase = getSupabase()
    const { error } = await supabase
        .from("media_assets")
        .update({ folder_path: newFolderPath })
        .eq("id", assetId)

    if (error) return { success: false, error: error.message }
    return { success: true }
}

export async function moveAssets(assetIds: string[], newFolderPath: string) {
    const supabase = getSupabase()
    const { error } = await supabase
        .from("media_assets")
        .update({ folder_path: newFolderPath })
        .in("id", assetIds)

    if (error) return { success: false, error: error.message }
    return { success: true }
}

// ─────────────────────────────────────────────
//  QUERY — fetch assets & folders from DB
// ─────────────────────────────────────────────

export async function getAssets(folderPath: string) {
    const supabase = getSupabase()

    const { data, error } = await supabase
        .from("media_assets")
        .select("*")
        .eq("folder_path", folderPath || "")
        .eq("is_deleted", false)
        .order("created_at", { ascending: false })

    if (error) return { assets: [], error: error.message }
    return { assets: data || [] }
}

export async function getFolders() {
    const supabase = getSupabase()

    // Get all distinct folder_paths that have active assets
    const { data, error } = await supabase
        .from("media_assets")
        .select("folder_path")
        .eq("is_deleted", false)
        .neq("folder_path", "")

    if (error) return { folders: [], error: error.message }

    // Extract unique top-level folder names
    const folderSet = new Set<string>()
    for (const row of data || []) {
        const parts = row.folder_path.split("/")
        if (parts[0]) folderSet.add(parts[0])
    }

    return { folders: Array.from(folderSet).sort() }
}

export async function getSubFolders(parentPath: string) {
    const supabase = getSupabase()

    const { data, error } = await supabase
        .from("media_assets")
        .select("folder_path")
        .eq("is_deleted", false)
        .like("folder_path", `${parentPath}/%`)

    if (error) return { folders: [], error: error.message }

    // Extract the next-level folder names relative to parentPath
    const folderSet = new Set<string>()
    for (const row of data || []) {
        const relative = row.folder_path.substring(parentPath.length + 1)
        const nextPart = relative.split("/")[0]
        if (nextPart) folderSet.add(nextPart)
    }

    return { folders: Array.from(folderSet).sort() }
}

// ─────────────────────────────────────────────
//  FOLDER OPERATIONS — virtual (DB-only)
// ─────────────────────────────────────────────

export async function createFolder(name: string) {
    // Folders exist implicitly via folder_path on assets.
    // To create an "empty" folder, we insert a sentinel record.
    const supabase = getSupabase()

    const { error } = await supabase
        .from("media_assets")
        .insert({
            filename: ".folder",
            folder_path: name,
            storage_hash: ".folder",
            public_url: "",
            size: 0,
            is_deleted: false,
        })

    if (error) return { success: false, error: error.message }
    return { success: true }
}

export async function deleteFolder(name: string) {
    // Soft-delete all assets in this folder (and subfolders)
    const supabase = getSupabase()

    // Delete assets exactly in this folder
    const { error: exactError } = await supabase
        .from("media_assets")
        .update({ is_deleted: true })
        .eq("folder_path", name)
        .eq("is_deleted", false)

    if (exactError) return { success: false, error: exactError.message }

    // Delete assets in subfolders
    const { error: subError } = await supabase
        .from("media_assets")
        .update({ is_deleted: true })
        .like("folder_path", `${name}/%`)
        .eq("is_deleted", false)

    if (subError) return { success: false, error: subError.message }
    return { success: true }
}

// ─── AI ASSET LIBRARY ────────────────────────────────────

export async function updateAssetDescription(assetId: string, description: string) {
    const supabase = getSupabase()
    const { error } = await supabase
        .from("media_assets")
        .update({ description })
        .eq("id", assetId)

    if (error) return { success: false, error: error.message }
    return { success: true }
}

export async function toggleAssetStar(assetId: string, isStarred: boolean) {
    const supabase = getSupabase()
    const { error } = await supabase
        .from("media_assets")
        .update({ is_starred: isStarred })
        .eq("id", assetId)

    if (error) return { success: false, error: error.message }
    return { success: true }
}

// Fetches ALL assets for the admin page to let you tag them
export async function getAllLibraryAssets() {
    const supabase = getSupabase()
    const { data, error } = await supabase
        .from("media_assets")
        .select("*")
        .eq("is_deleted", false)
        .neq("filename", ".folder")
        .order("created_at", { ascending: false })

    if (error) return []
    return data || []
}

// Fetches ONLY starred + described assets to feed to the AI Prompt
export async function getDescribedAssets() {
    const supabase = getSupabase()
    try {
        const { data, error } = await supabase
            .from("media_assets")
            .select("public_url, description, filename")
            .eq("is_deleted", false)
            .eq("is_starred", true)
            .neq("filename", ".folder")
            .not("description", "is", null)
            .neq("description", "")
            .limit(50)

        return data || []
    } catch {
        return [] // Fallback if column doesn't exist yet
    }
}
</file>

<file path="app/actions/knowledgebase.ts">
"use server"

import { createClient } from "@/lib/supabase/server"
import { revalidatePath } from "next/cache"
import { GoogleGenAI } from "@google/genai"

export interface ResearchDoc {
    id: string;
    title: string;
    author: string | null;
    year: string | null;
    url: string | null;
    content: string;
    is_active: boolean;
    created_at: string;
}

export async function getKnowledgebase() {
    const supabase = await createClient()
    const { data, error } = await supabase
        .from("research_knowledgebase")
        .select("*")
        .order("created_at", { ascending: false })

    if (error) throw new Error(error.message)
    return data as ResearchDoc[]
}

export async function getActiveKnowledgebase() {
    const supabase = await createClient()
    const { data, error } = await supabase
        .from("research_knowledgebase")
        .select("*")
        .eq("is_active", true)

    if (error) throw new Error(error.message)
    return data as ResearchDoc[]
}

export async function saveResearchDoc(doc: Partial<ResearchDoc>) {
    const supabase = await createClient()

    if (doc.id) {
        const { error } = await supabase
            .from("research_knowledgebase")
            .update({ ...doc, updated_at: new Date().toISOString() })
            .eq("id", doc.id)
        if (error) throw new Error(error.message)
    } else {
        const { error } = await supabase
            .from("research_knowledgebase")
            .insert([doc])
        if (error) throw new Error(error.message)
    }

    revalidatePath("/admin/knowledgebase")
    return { success: true }
}

export async function toggleResearchStatus(id: string, is_active: boolean) {
    const supabase = await createClient()
    const { error } = await supabase.from("research_knowledgebase").update({ is_active }).eq("id", id)
    if (error) throw new Error(error.message)
    revalidatePath("/admin/knowledgebase")
    return { success: true }
}

export async function deleteResearchDoc(id: string) {
    const supabase = await createClient()
    const { error } = await supabase.from("research_knowledgebase").delete().eq("id", id)
    if (error) throw new Error(error.message)
    revalidatePath("/admin/knowledgebase")
    return { success: true }
}

export async function extractPdf(formData: FormData): Promise<{ markdown?: string; error?: string }> {
    try {
        const file = formData.get("file") as File
        if (!file || file.type !== "application/pdf") {
            return { error: "Invalid file. Please upload a PDF." }
        }

        const arrayBuffer = await file.arrayBuffer()
        const base64Data = Buffer.from(arrayBuffer).toString("base64")

        const ai = new GoogleGenAI({ apiKey: process.env.GEMINI_API_KEY! })

        const response = await ai.models.generateContent({
            model: "gemini-2.5-pro",
            contents: [
                {
                    role: "user",
                    parts: [
                        {
                            inlineData: {
                                data: base64Data,
                                mimeType: "application/pdf"
                            }
                        },
                        {
                            text: "Extract the complete text of this research paper and convert it into highly readable Markdown. Preserve all statistics, quotes, headings, and data accurately. Remove any page numbers, headers, footers, or irrelevant publishing stamps. Do not include introductory conversational text, just output the raw Markdown."
                        }
                    ]
                }
            ]
        })

        let markdown = response.text || ""

        if (markdown.startsWith("```markdown")) {
            markdown = markdown.replace(/^```markdown\n/, "").replace(/\n```$/, "")
        } else if (markdown.startsWith("```")) {
            markdown = markdown.replace(/^```\n/, "").replace(/\n```$/, "")
        }

        return { markdown: markdown.trim() }
    } catch (error: unknown) {
        const message = error instanceof Error ? error.message : "Unknown error"
        console.error("PDF Parsing Error:", error)
        return { error: message }
    }
}
</file>

<file path="app/actions/posts.ts">
"use server"

import { createClient } from "@/lib/supabase/server"
import { revalidatePath } from "next/cache"
import { Post } from "@/lib/types"

// ─── GET ALL POSTS ───────────────────────────────────────
export async function getPosts(): Promise<Post[]> {
    const supabase = await createClient()
    const { data, error } = await supabase
        .from("posts")
        .select("*")
        .order("created_at", { ascending: false })

    if (error) {
        console.error("Error fetching posts:", error)
        return []
    }
    return data || []
}

// ─── GET SINGLE POST ─────────────────────────────────────
export async function getPost(id: string): Promise<Post | null> {
    const supabase = await createClient()
    const { data, error } = await supabase
        .from("posts")
        .select("*")
        .eq("id", id)
        .single()

    if (error) return null
    return data
}

// ─── CREATE POST ─────────────────────────────────────────
export async function createPost(data: {
    title: string
    slug?: string
    html_content?: string
    variable_values?: Record<string, any>
}): Promise<{ data: Post | null; error: string | null }> {
    const supabase = await createClient()

    const slug = data.slug || data.title
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/^-|-$/g, "")

    const { data: post, error } = await supabase
        .from("posts")
        .insert({
            title: data.title,
            slug,
            html_content: data.html_content || "",
            variable_values: data.variable_values || {},
        })
        .select("*")
        .single()

    if (error) return { data: null, error: error.message }

    revalidatePath("/")
    revalidatePath("/posts")
    return { data: post, error: null }
}

// ─── UPDATE POST ─────────────────────────────────────────
export async function updatePost(
    id: string,
    updates: Partial<Pick<Post, "title" | "slug" | "excerpt" | "category" | "featured_image" | "html_content" | "variable_values" | "status" | "published_at">>
): Promise<{ error: string | null }> {
    const supabase = await createClient()

    const { error } = await supabase
        .from("posts")
        .update({
            ...updates,
            updated_at: new Date().toISOString(),
        })
        .eq("id", id)

    if (error) return { error: error.message }

    revalidatePath("/")
    revalidatePath("/posts")
    return { error: null }
}

// ─── DELETE POST ─────────────────────────────────────────
export async function deletePost(id: string): Promise<{ error: string | null }> {
    const supabase = await createClient()
    const { error } = await supabase.from("posts").delete().eq("id", id)

    if (error) return { error: error.message }

    revalidatePath("/")
    revalidatePath("/posts")
    return { error: null }
}

// ─── PUBLISH POST ────────────────────────────────────────
export async function publishPost(id: string): Promise<{ error: string | null }> {
    return updatePost(id, {
        status: "published",
        published_at: new Date().toISOString(),
    })
}

// ─── UNPUBLISH POST ──────────────────────────────────────
export async function unpublishPost(id: string): Promise<{ error: string | null }> {
    return updatePost(id, {
        status: "draft",
        published_at: null,
    })
}

// ─── TOGGLE POST STATUS ─────────────────────────────────
export async function togglePostStatus(id: string): Promise<Post | null> {
    const supabase = await createClient()
    const { data: post } = await supabase
        .from("posts")
        .select("status")
        .eq("id", id)
        .single()

    if (!post) return null

    const newStatus = post.status === "published" ? "draft" : "published"
    const { data: updated, error } = await supabase
        .from("posts")
        .update({
            status: newStatus,
            published_at: newStatus === "published" ? new Date().toISOString() : null,
            updated_at: new Date().toISOString(),
        })
        .eq("id", id)
        .select("*")
        .single()

    if (error) return null

    revalidatePath("/")
    revalidatePath("/posts")
    return updated
}

// ─── BULK DELETE POSTS ───────────────────────────────────
export async function deletePosts(ids: string[]): Promise<{ error: string | null }> {
    const supabase = await createClient()
    const { error } = await supabase.from("posts").delete().in("id", ids)

    if (error) return { error: error.message }

    revalidatePath("/")
    revalidatePath("/posts")
    return { error: null }
}

// ─── BULK UPDATE STATUS ──────────────────────────────────
export async function updatePostsStatus(ids: string[], status: "draft" | "published"): Promise<{ error: string | null }> {
    const supabase = await createClient()
    const { error } = await supabase
        .from("posts")
        .update({
            status,
            published_at: status === "published" ? new Date().toISOString() : null,
            updated_at: new Date().toISOString(),
        })
        .in("id", ids)

    if (error) return { error: error.message }

    revalidatePath("/")
    revalidatePath("/posts")
    return { error: null }
}

// ─── GET POST STATS ──────────────────────────────────────
export async function getPostStats(): Promise<{ total: number; published: number; draft: number }> {
    const supabase = await createClient()
    const { data } = await supabase
        .from("posts")
        .select("status")

    const posts = data || []
    return {
        total: posts.length,
        published: posts.filter(p => p.status === "published").length,
        draft: posts.filter(p => p.status === "draft").length,
    }
}

// ─── GET TEMPLATE LIST (for Copilot reference picker) ────
export async function getTemplateList(): Promise<{ id: string; name: string; created_at: string }[]> {
    const supabase = await createClient()
    const { data } = await supabase
        .from("posts")
        .select("id, title, created_at")
        .order("created_at", { ascending: false })
        .limit(50)

    return (data || []).map(p => ({
        id: p.id,
        name: p.title,
        created_at: p.created_at,
    }))
}

// ─── GET POST HTML (for Copilot reference capture) ───────
export async function getPostHtml(id: string): Promise<{ html_content: string | null; variable_values: Record<string, any> | null } | null> {
    const supabase = await createClient()
    const { data } = await supabase
        .from("posts")
        .select("html_content, variable_values")
        .eq("id", id)
        .single()

    return data
}

// ─── SAVE BACKUP (before each save) ──────────────────────
export async function savePostBackup(postId: string): Promise<void> {
    const supabase = await createClient()
    const { data: post } = await supabase
        .from("posts")
        .select("html_content, variable_values, title")
        .eq("id", postId)
        .single()

    if (!post || !post.html_content) return

    // Save a snapshot to post_versions
    await supabase.from("post_versions").insert({
        post_id: postId,
        html_content: post.html_content,
        prompt: `Backup: ${post.title}`,
    })

    // Keep only the last 5 versions per post
    const { data: versions } = await supabase
        .from("post_versions")
        .select("id")
        .eq("post_id", postId)
        .order("created_at", { ascending: false })

    if (versions && versions.length > 5) {
        const idsToDelete = versions.slice(5).map(v => v.id)
        await supabase.from("post_versions").delete().in("id", idsToDelete)
    }
}

// ─── GET POST BACKUPS ────────────────────────────────────
export async function getPostBackups(postId: string): Promise<{ id: string; saved_at: string; title: string }[]> {
    const supabase = await createClient()
    const { data } = await supabase
        .from("post_versions")
        .select("id, created_at, prompt")
        .eq("post_id", postId)
        .order("created_at", { ascending: false })
        .limit(20)

    return (data || []).map(v => ({
        id: v.id,
        saved_at: v.created_at,
        title: v.prompt || "Untitled version",
    }))
}

// ─── RESTORE BACKUP ──────────────────────────────────────
export async function restorePostBackup(postId: string, versionId: string): Promise<{ success: boolean; data?: { html_content: string; variable_values: Record<string, any> } }> {
    const supabase = await createClient()
    const { data: version } = await supabase
        .from("post_versions")
        .select("html_content")
        .eq("id", versionId)
        .single()

    if (!version) return { success: false }

    // Save current state as backup first
    await savePostBackup(postId)

    // Restore the version
    await supabase
        .from("posts")
        .update({
            html_content: version.html_content,
            updated_at: new Date().toISOString(),
        })
        .eq("id", postId)

    return {
        success: true,
        data: {
            html_content: version.html_content,
            variable_values: {},
        },
    }
}
</file>

<file path="app/admin/page.tsx">
import Link from 'next/link'
import { Plus, ExternalLink, FileText, Eye, FilePen } from 'lucide-react'
import { Button } from '@/components/ui/button'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { getPostStats, getPosts } from '@/app/actions/posts'
import { DownloadHtmlButton } from '@/components/admin/download-html-button'

export default async function AdminDashboard() {
    const stats = await getPostStats()
    const posts = await getPosts()
    const recentPosts = posts.slice(0, 10)

    const statCards = [
        { label: 'Total Posts', value: stats.total, icon: FileText, color: 'text-blue-400' },
        { label: 'Published', value: stats.published, icon: Eye, color: 'text-green-400' },
        { label: 'Drafts', value: stats.draft, icon: FilePen, color: 'text-yellow-400' },
    ]

    return (
        <div className="space-y-8 p-6">
            {/* Header */}
            <div className="flex items-center justify-between">
                <div>
                    <h1 className="text-3xl font-bold tracking-tight text-foreground">Dashboard</h1>
                    <p className="text-muted-foreground">Welcome back! Here&apos;s an overview of your blog.</p>
                </div>
                <div className="flex items-center gap-3">
                    <Button variant="outline" asChild>
                        <Link href="/blog" target="_blank">
                            <ExternalLink className="mr-2 h-4 w-4" />
                            View Blog
                        </Link>
                    </Button>
                    <Button asChild>
                        <Link href="/editor">
                            <Plus className="mr-2 h-4 w-4" />
                            New Post
                        </Link>
                    </Button>
                </div>
            </div>

            {/* Stats Cards */}
            <div className="grid gap-4 md:grid-cols-3">
                {statCards.map((stat) => (
                    <Card key={stat.label}>
                        <CardHeader className="flex flex-row items-center justify-between pb-2">
                            <CardTitle className="text-sm font-medium text-muted-foreground">
                                {stat.label}
                            </CardTitle>
                            <stat.icon className={`h-4 w-4 ${stat.color}`} />
                        </CardHeader>
                        <CardContent>
                            <div className="text-3xl font-bold text-foreground">{stat.value}</div>
                        </CardContent>
                    </Card>
                ))}
            </div>

            {/* Recent Posts */}
            <Card>
                <CardHeader>
                    <div className="flex items-center justify-between">
                        <div>
                            <CardTitle>Recent Posts</CardTitle>
                            <p className="text-sm text-muted-foreground mt-1">Your latest blog posts and their status.</p>
                        </div>
                        <Button variant="outline" size="sm" asChild>
                            <Link href="/admin/posts">View All</Link>
                        </Button>
                    </div>
                </CardHeader>
                <CardContent>
                    {recentPosts.length === 0 ? (
                        <div className="rounded-xl border border-dashed border-border p-12 text-center">
                            <FileText className="h-10 w-10 text-muted-foreground mx-auto mb-4 opacity-50" />
                            <h3 className="text-lg font-medium text-foreground">No posts yet</h3>
                            <p className="text-muted-foreground mt-2">Create your first blog post using one of the editors.</p>
                        </div>
                    ) : (
                        <div className="rounded-lg border border-border">
                            <table className="w-full">
                                <thead>
                                    <tr className="border-b border-border bg-muted/50">
                                        <th className="px-4 py-3 text-left text-sm font-medium text-muted-foreground">Title</th>
                                        <th className="px-4 py-3 text-left text-sm font-medium text-muted-foreground">Status</th>
                                        <th className="px-4 py-3 text-left text-sm font-medium text-muted-foreground">Category</th>
                                        <th className="px-4 py-3 text-left text-sm font-medium text-muted-foreground">Updated</th>
                                        <th className="px-4 py-3 w-10"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {recentPosts.map((post) => (
                                        <tr key={post.id} className="border-b border-border last:border-0">
                                            <td className="px-4 py-3">
                                                <Link
                                                    href={`/editor?id=${post.id}`}
                                                    className="font-medium text-foreground hover:underline"
                                                >
                                                    {post.title || 'Untitled'}
                                                </Link>
                                            </td>
                                            <td className="px-4 py-3">
                                                <Badge
                                                    variant={post.status === 'published' ? 'default' : 'secondary'}
                                                    className={post.status === 'published'
                                                        ? 'bg-green-500/20 text-green-400 hover:bg-green-500/30'
                                                        : 'bg-yellow-500/20 text-yellow-400 hover:bg-yellow-500/30'
                                                    }
                                                >
                                                    {post.status}
                                                </Badge>
                                            </td>
                                            <td className="px-4 py-3">
                                                <span className="text-sm capitalize text-muted-foreground">{post.category}</span>
                                            </td>
                                            <td className="px-4 py-3">
                                                <span className="text-sm text-muted-foreground">
                                                    {new Date(post.updated_at).toLocaleDateString('en-US', {
                                                        month: 'short',
                                                        day: 'numeric',
                                                        year: 'numeric',
                                                    })}
                                                </span>
                                            </td>
                                            <td className="px-4 py-3">
                                                <DownloadHtmlButton
                                                    htmlContent={post.html_content}
                                                    filename={`${post.slug || post.id}.html`}
                                                />
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </CardContent>
            </Card>
        </div>
    )
}
</file>

<file path="app/api/copilot-dnd/route.ts">
import { createClient } from "@supabase/supabase-js";
import Anthropic from "@anthropic-ai/sdk";
import { NextResponse } from "next/server";
import { getAllContextForAudience, formatContextForPrompt } from "@/app/actions/settings";

const supabase = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_KEY!
);

// Robust JSON extractor: finds the first '{' and last '}' to ignore chatty text
function extractJson(text: string) {
    const start = text.indexOf('{');
    const end = text.lastIndexOf('}');
    if (start !== -1 && end !== -1 && end > start) {
        return text.substring(start, end + 1);
    }
    return text; // Fallback
}

async function urlToBase64(url: string) {
    try {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Failed to fetch image: ${response.statusText}`);
        const arrayBuffer = await response.arrayBuffer();
        const buffer = Buffer.from(arrayBuffer);
        const base64 = buffer.toString('base64');
        const mediaType = response.headers.get('content-type') || 'image/jpeg';
        return { base64, mediaType };
    } catch (e) {
        console.error("Image fetch failed", e);
        return null;
    }
}

// Block type schema for the AI prompt
const BLOCK_SCHEMA = `
You MUST return blocks as a JSON array. Each block has this shape:
{ "id": "<unique-string>", "type": "<block_type>", "props": { ... } }

VALID BLOCK TYPES AND THEIR PROPS:

1. "heading" — { text: string, level: "h1"|"h2"|"h3", alignment: "left"|"center"|"right", color: "#hex", fontFamily: "Arial, Helvetica, sans-serif" }
2. "text" — { text: string, alignment: "left"|"center"|"right", color: "#hex", fontSize: number(px), lineHeight: number }
3. "image" — { src: "{{mustache_var}}", alt: string, width: number(px, max 600), height: "auto"|number, linkUrl: "{{mustache_var}}", alignment: "left"|"center"|"right" }
4. "button" — { text: string, url: "{{mustache_var}}", bgColor: "#hex", textColor: "#hex", borderRadius: number, alignment: "left"|"center"|"right", fullWidth: boolean, fontSize: number, paddingX: number, paddingY: number }
5. "divider" — { color: "#hex", thickness: number, widthPercent: number(0-100), style: "solid"|"dashed"|"dotted" }
6. "spacer" — { height: number(px) }
7. "social" — { networks: [{ platform: "facebook"|"instagram"|"twitter"|"youtube"|"linkedin"|"tiktok", url: string }], alignment: "left"|"center"|"right", iconSize: number }

RULES:
- All image src values MUST be mustache variables like {{hero_src}}, {{product_img}}, etc.
- All link URLs MUST be mustache variables like {{cta_link_url}}, {{hero_link_url}}
- All text/copy MUST be hardcoded (NOT mustache variables)
- Generate unique IDs for each block (e.g. "block-heading-1", "block-text-1")
- NO EM-DASHES in any text
`;

function buildBlockSchemaWithImageRules(imageRuleBlock: string) {
    return BLOCK_SCHEMA.replace(
        '- All image src values MUST be mustache variables like {{hero_src}}, {{product_img}}, etc.',
        imageRuleBlock
    );
}

export async function POST(req: Request) {
    try {
        const { currentBlocks, messages, model, audienceContext = "dreamplay", aiDossier: clientDossier = "", imageMode = "library" } = await req.json();

        // --- SMART ROUTER LOGIC ---
        let actualModel = model;
        let routingReason = "";

        if (model === "auto") {
            const lastUserMessage = messages.filter((m: any) => m.role === 'user').pop();
            const hasImages = lastUserMessage?.imageUrls?.length > 0;
            const isEmpty = !currentBlocks || currentBlocks.length === 0;

            if (isEmpty) {
                actualModel = "claude-sonnet-4-20250514";
                routingReason = "New template from scratch → Sonnet.";
            } else if (hasImages) {
                actualModel = "claude-sonnet-4-20250514";
                routingReason = "Vision task (screenshot reference) → Sonnet.";
            } else {
                try {
                    const { GoogleGenerativeAI } = await import("@google/generative-ai");
                    const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY!);
                    const flash = genAI.getGenerativeModel({
                        model: "gemini-2.0-flash",
                        generationConfig: { maxOutputTokens: 10, temperature: 0 }
                    });

                    const routerPrompt = `You are a routing agent for an email editor.
User request: "${lastUserMessage?.content}"
Is this a simple edit (changing text, fixing a typo, updating a color, swapping a link) or a complex edit (creating new layouts, adding new sections, structural redesign)?
Reply ONLY with the exact word "SIMPLE" or "COMPLEX".`;

                    const routerResult = await flash.generateContent(routerPrompt);
                    const intent = routerResult.response.text().trim().toUpperCase();

                    if (intent.includes("COMPLEX")) {
                        actualModel = "claude-sonnet-4-20250514";
                        routingReason = "Complex structural edit → Sonnet.";
                    } else {
                        actualModel = "claude-3-5-haiku-latest";
                        routingReason = "Simple text/style edit → Haiku.";
                    }
                } catch (e) {
                    actualModel = "claude-sonnet-4-20250514";
                    routingReason = "Router fallback → Sonnet.";
                }
            }
            console.log(`[Smart Router DnD] ${routingReason} (model: ${actualModel})`);
        }
        // ------------------------------

        // Fetch audience-driven context
        const payload = await getAllContextForAudience(audienceContext);
        const { contextBlock: dynamicContext, linksBlock: defaultLinksBlock } = await formatContextForPrompt(payload, audienceContext);

        // FETCH KNOWLEDGEBASE (server-side) ⚡️
        let aiDossier = clientDossier;
        if (!aiDossier) {
            try {
                const { data: kbDocs } = await supabase
                    .from("research_knowledgebase")
                    .select("*")
                    .eq("is_active", true);
                if (kbDocs && kbDocs.length > 0) {
                    aiDossier = kbDocs.map((doc: any) => `--- SOURCE: ${doc.title} ${doc.author ? `(by ${doc.author})` : ''} ---\n${doc.content}`).join("\n\n");
                    console.log(`[Knowledgebase DnD] Injected ${kbDocs.length} active research doc(s) into prompt`);
                }
            } catch (e) {
                console.error("[Knowledgebase DnD] Failed to fetch:", e);
            }
        }

        // BUILD DYNAMIC IMAGE INSTRUCTIONS ⚡️
        let imageContextBlock = "";
        let imageRuleBlock = `- All image src values MUST be mustache variables like {{hero_src}}, {{product_img}}, etc.`;

        if (imageMode === 'library') {
            const { getDescribedAssets } = await import("@/app/actions/assets");
            const library = await getDescribedAssets();
            if (library && library.length > 0) {
                const libraryText = library.map((img: any) => `- URL: ${img.public_url}\n  Description: ${img.description}`).join("\n\n");
                imageContextBlock = `\n### ASSET LIBRARY:\nYou have access to the following pre-uploaded images.\n${libraryText}\n`;
                imageRuleBlock = `- If a library image (see ASSET LIBRARY section) fits the context, HARDCODE its exact URL directly into the \`src\` prop.\n- If NO library image fits, use a dynamic AI placeholder: \`https://image.pollinations.ai/prompt/{URL_ENCODED_PROMPT}?width=800&height=400&nologo=true\`.\n- DO NOT use {{mustache}} variables for image src! Hardcode URLs so they render immediately.`;
            } else {
                imageRuleBlock = `- HARDCODE a dynamic AI placeholder directly into the \`src\` prop: \`https://image.pollinations.ai/prompt/{URL_ENCODED_PROMPT}?width=800&height=400&nologo=true\`. DO NOT use {{mustache}} variables for image src.`;
            }
        } else if (imageMode === 'creative') {
            imageRuleBlock = `- For ALL images, generate a creative AI placeholder in the \`src\` prop: \`https://image.pollinations.ai/prompt/{URL_ENCODED_PROMPT}?width=800&height=400&nologo=true\`. DO NOT use {{mustache}} variables for image src.`;
        }

        // Process images in messages
        const processedMessages = await Promise.all(messages.map(async (msg: any, index: number) => {
            const isRecent = index >= messages.length - 3;
            let processedImages: any[] = [];
            if (isRecent && msg.imageUrls && msg.imageUrls.length > 0) {
                const downloads = await Promise.all(msg.imageUrls.map((url: string) => urlToBase64(url)));
                processedImages = downloads.filter(img => img !== null);
            }
            return { role: msg.role, content: msg.content, images: processedImages };
        }));

        const dynamicBlockSchema = buildBlockSchemaWithImageRules(imageRuleBlock);

        const systemInstruction = `
You are an expert Email Template Designer that builds emails using a BLOCK-BASED system.
The user will describe what they want, and you return a structured array of blocks.

${dynamicBlockSchema}

### RESPONSE FORMAT (STRICT JSON ONLY):
You MUST return ONLY a valid JSON object. Do not include any conversational text before or after the JSON.
{ 
  "_thoughts": "Think step-by-step about the blocks you need to create/modify.",
  "explanation": "A brief summary of what you created/changed", 
  "blocks": [ ...array of block objects... ] 
}

### COMPANY CONTEXT:
${dynamicContext}
${defaultLinksBlock}

### CURRENT BLOCKS:
${JSON.stringify(currentBlocks, null, 2)}

When modifying existing blocks:
- PRESERVE all blocks that the user did not ask to change
- Use the same IDs for unchanged blocks
- Generate new IDs for new blocks
When creating from scratch, build a complete email with appropriate sections.
${aiDossier ? `
### AUDIENCE INTELLIGENCE:
${aiDossier}
` : ""}
${imageContextBlock}

### 🛑 STRICT FACT & QUOTE RULES:
1. NEVER invent, fabricate, or hallucinate quotes, testimonials, or people.
2. If you quote someone, use a case study, or tell a story, it MUST be extracted verbatim from the provided "AUDIENCE INTELLIGENCE" section. DO NOT invent fake personas.
3. Do NOT make up statistics. Use ONLY the exact data provided. Do not conflate universities or researchers.
4. If the AUDIENCE INTELLIGENCE section is empty or not provided, do NOT fabricate any quotes or case studies. Write general copy instead.
`;

        let rawResponse = "";

        if (actualModel.includes("claude")) {
            const anthropic = new Anthropic({ apiKey: process.env.ANTHROPIC_API_KEY });

            const anthropicMessages = processedMessages.map((msg: any) => {
                const role = (msg.role === 'result' ? 'assistant' : 'user') as "assistant" | "user";
                let content: any[] = [];

                if (msg.images) {
                    msg.images.forEach((img: any) => {
                        const isPdf = img.mediaType === 'application/pdf';
                        content.push({
                            type: isPdf ? "document" : "image",
                            source: { type: "base64", media_type: img.mediaType, data: img.base64 }
                        });
                    });
                }

                if (msg.content) content.push({ type: "text", text: msg.content });
                return { role, content };
            });

            const msg = await anthropic.messages.create({
                model: actualModel,
                max_tokens: 32768,
                temperature: 0,
                system: systemInstruction,
                messages: anthropicMessages
            });

            const textBlock = msg.content[0];
            if (textBlock.type === 'text') rawResponse = textBlock.text;
        } else {
            // Gemini fallback — use same structure
            const { GoogleGenerativeAI } = await import("@google/generative-ai");
            const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY!);
            const geminiModel = genAI.getGenerativeModel({
                model: "gemini-1.5-pro",
                generationConfig: { responseMimeType: "application/json" }
            });

            const geminiHistory = processedMessages.map((msg: any) => {
                const role = msg.role === 'result' ? 'model' : 'user';
                const parts = [];
                if (msg.images) {
                    msg.images.forEach((img: any) => {
                        parts.push({ inlineData: { mimeType: img.mediaType, data: img.base64 } });
                    });
                }
                if (msg.content) parts.push({ text: msg.content });
                return { role, parts };
            });

            if (geminiHistory.length > 0) {
                const firstPart = geminiHistory[0].parts[0];
                if (firstPart.text) {
                    firstPart.text = `${systemInstruction}\n\n${firstPart.text}`;
                } else {
                    geminiHistory[0].parts.unshift({ text: systemInstruction });
                }
            }

            const result = await geminiModel.generateContent({ contents: geminiHistory });
            rawResponse = result.response.text();
        }

        // --- PARSE ---
        try {
            const cleaned = extractJson(rawResponse);
            const parsed = JSON.parse(cleaned);

            if (routingReason) {
                parsed.explanation = `*(⚡️ ${routingReason})*\n\n` + (parsed.explanation || "");
            }

            return NextResponse.json(parsed);
        } catch (e: any) {
            console.error("JSON Parse Error:", e.message);
            return NextResponse.json({
                blocks: currentBlocks,
                explanation: "I successfully generated the blocks, but my output formatting broke. Please try asking me again!"
            });
        }

    } catch (error: any) {
        console.error("DnD Copilot API Error:", error);
        return NextResponse.json({ error: error.message }, { status: 500 });
    }
}
</file>

<file path="app/editor/page.tsx">
"use client"

import { useState, useEffect, Suspense } from "react"
import { useSearchParams, useRouter } from "next/navigation"
import { BlogPostEditor } from "@/components/editor/blog-post-editor"
import { createClient } from "@/lib/supabase/client"
import { togglePostStatus, savePostBackup } from "@/app/actions/posts"
import { Post } from "@/lib/types"

function EditorInner() {
    const searchParams = useSearchParams()
    const router = useRouter()
    const postId = searchParams.get("id")
    const supabase = createClient()

    const [post, setPost] = useState<Post | null>(null)
    const [html, setHtml] = useState("")
    const [assets, setAssets] = useState<Record<string, string>>({})
    const [title, setTitle] = useState("Untitled Post")
    const [slug, setSlug] = useState("")
    const [excerpt, setExcerpt] = useState("")
    const [postStatus, setPostStatus] = useState<'draft' | 'published'>('draft')
    const [loading, setLoading] = useState(!!postId)

    // Load existing post if ID provided
    useEffect(() => {
        if (!postId) return
        const loadPost = async () => {
            setLoading(true)
            const { data } = await supabase
                .from("posts")
                .select("*")
                .eq("id", postId)
                .single()

            if (data) {
                setPost(data)
                setHtml(data.html_content || "")
                setAssets(data.variable_values || {})
                setTitle(data.title)
                setSlug(data.slug)
                setExcerpt(data.excerpt || "")
                setPostStatus(data.status || 'draft')
            }
            setLoading(false)
        }
        loadPost()
    }, [postId])

    const handleSave = async () => {
        if (postId && post) {
            // Snapshot current state before overwriting
            await savePostBackup(postId)
            // Update existing post
            await supabase
                .from("posts")
                .update({
                    title,
                    slug: slug || title.toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/^-|-$/g, ""),
                    excerpt,
                    html_content: html,
                    variable_values: assets,
                    updated_at: new Date().toISOString(),
                })
                .eq("id", postId)
        } else {
            // Create new post
            const newSlug = slug || title.toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/^-|-$/g, "")
            const { data } = await supabase
                .from("posts")
                .insert({
                    title,
                    slug: newSlug,
                    excerpt,
                    html_content: html,
                    variable_values: assets,
                })
                .select("id")
                .single()

            if (data) {
                router.replace(`/editor?id=${data.id}`)
            }
        }
    }

    const handlePublish = async () => {
        if (!postId) return
        const updated = await togglePostStatus(postId)
        if (updated) {
            setPostStatus(updated.status as 'draft' | 'published')
        }
    }

    const handleRestore = (backup: { html_content: string; variable_values: Record<string, any> }) => {
        setHtml(backup.html_content)
        setAssets(backup.variable_values || {})
    }

    if (loading) {
        return (
            <div className="h-screen flex items-center justify-center bg-background text-foreground">
                <p className="text-muted-foreground">Loading post...</p>
            </div>
        )
    }

    return (
        <BlogPostEditor
            html={html}
            assets={assets}
            title={title}
            slug={slug}
            excerpt={excerpt}
            onHtmlChange={setHtml}
            onAssetsChange={setAssets}
            onTitleChange={setTitle}
            onSlugChange={setSlug}
            onExcerptChange={setExcerpt}
            postName={title}
            onNameChange={setTitle}
            onSave={handleSave}
            onPublish={handlePublish}
            postId={postId}
            postStatus={postStatus}
            onRestore={handleRestore}
        />
    )
}

export default function EditorPage() {
    return (
        <Suspense fallback={<div className="h-screen flex items-center justify-center bg-background"><p className="text-muted-foreground">Loading...</p></div>}>
            <EditorInner />
        </Suspense>
    )
}
</file>

<file path="app/layout.tsx">
import type React from "react"
import type { Metadata } from "next"
import { Geist, Geist_Mono, Cormorant_Garamond, Manrope } from "next/font/google"
import { Analytics } from "@vercel/analytics/next"
import { Toaster } from "@/components/ui/toaster"
import "./globals.css"

const geistSans = Geist({
  subsets: ["latin"],
  variable: "--font-geist"
})
const geistMono = Geist_Mono({
  subsets: ["latin"],
  variable: "--font-geist-mono"
})
const cormorant = Cormorant_Garamond({
  subsets: ["latin"],
  weight: ["400", "500", "600", "700"],
  variable: "--font-cormorant",
})
const manrope = Manrope({
  subsets: ["latin"],
  variable: "--font-manrope",
})

export const metadata: Metadata = {
  title: "DreamPlay Pianos | Blog",
  description: "Discover the world of luxury pianos through tutorials, artist stories, and product news from DreamPlay Pianos.",
}

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode
}>) {
  return (
    <html lang="en" className="dark">
      <body className={`${geistSans.variable} ${geistMono.variable} ${cormorant.variable} ${manrope.variable} font-sans antialiased`}>
        {children}
        <Toaster />
        <Analytics />
      </body>
    </html>
  )
}
</file>

<file path="components/blog/newsletter-form.tsx">
"use client";

import { useState } from "react";
import { CheckCircle2, Package, ArrowRight } from "lucide-react";
import { subscribeToNewsletter } from "@/app/actions/email-actions";

export function NewsletterForm() {
    const [email, setEmail] = useState("");
    const [status, setStatus] = useState<"idle" | "loading" | "success" | "error">("idle");

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        if (!email) return;
        setStatus("loading");

        try {
            const res = await subscribeToNewsletter({
                email,
                tags: ["Blog Newsletter", "Free Shipping Lead"],
                temp_session_id: typeof window !== "undefined" ? localStorage.getItem("dp_temp_session") || undefined : undefined
            });

            if (!res.success) {
                throw new Error(res.error || "Failed to subscribe");
            }

            setStatus("success");
            setEmail("");
            if (typeof window !== "undefined") {
                localStorage.setItem("dp_v2_subscribed", "true");
                localStorage.setItem("dp_user_email", email);
            }
        } catch (err) {
            setStatus("error");
        }
    };

    if (status === "success") {
        return (
            <section className="border-t border-white/10 bg-[#050505] px-6 py-24 md:py-32 text-white">
                <div className="mx-auto max-w-2xl text-center">
                    <div className="mx-auto mb-6 flex h-16 w-16 items-center justify-center border border-white/20 bg-white/5">
                        <CheckCircle2 className="text-white" size={32} strokeWidth={1.5} />
                    </div>
                    <h2 className="mb-4 font-serif text-3xl md:text-4xl tracking-tight leading-tight text-white">
                        Check your inbox.
                    </h2>
                    <p className="mx-auto max-w-sm font-sans text-sm md:text-base leading-relaxed text-white/60">
                        We just sent you an email with instructions to unlock your VIP Free Shipping Pass.
                    </p>
                </div>
            </section>
        );
    }

    return (
        <section className="border-t border-white/10 bg-[#050505] px-6 py-24 md:py-32 text-white">
            <div className="mx-auto max-w-2xl text-center">
                <div className="mx-auto mb-6 flex h-14 w-14 items-center justify-center border border-white/10 bg-white/5">
                    <Package className="text-white" size={24} strokeWidth={1.5} />
                </div>
                <p className="mb-3 font-sans text-[10px] font-bold uppercase tracking-[0.3em] text-white/50">
                    VIP Offer
                </p>
                <h2 className="mb-6 font-serif text-3xl md:text-4xl tracking-tight leading-tight text-white">
                    Unlock Free Global Shipping.
                </h2>
                <p className="mx-auto mb-10 max-w-lg font-sans text-sm md:text-base leading-relaxed text-white/50">
                    Join our VIP list to get a Free Shipping Pass applied to your next DreamPlay One reservation (saves $150+).
                </p>
                <form onSubmit={handleSubmit} className="mx-auto flex max-w-md flex-col gap-3 sm:flex-row sm:gap-0 border border-white/20 p-1 sm:p-1.5 bg-white/5">
                    <input
                        type="email"
                        placeholder="Enter your email"
                        required
                        value={email}
                        onChange={(e) => setEmail(e.target.value)}
                        className="flex-1 rounded-none border border-white/20 bg-transparent px-4 py-4 font-sans text-sm text-white placeholder:text-white/40 focus:border-white focus:outline-none focus:ring-0 transition-colors"
                    />
                    <button
                        type="submit"
                        disabled={status === "loading"}
                        className="min-w-[160px] flex items-center justify-center gap-2 rounded-none bg-white px-6 py-4 font-sans text-xs font-bold uppercase tracking-widest text-black transition-colors hover:bg-white/90 disabled:opacity-70 cursor-pointer whitespace-nowrap"
                    >
                        {status === "loading" ? "Processing..." : "Get VIP Pass"}
                        {status !== "loading" && <ArrowRight className="h-4 w-4" />}
                    </button>
                </form>
                {status === "error" && (
                    <div className="mt-4 p-3 border border-red-500/30 bg-red-500/10 text-red-400 text-xs font-sans text-center max-w-md mx-auto">
                        Failed to subscribe. Please try again.
                    </div>
                )}
                <p className="text-[10px] text-white/30 uppercase tracking-widest mt-6">
                    No spam. Unsubscribe anytime.
                </p>
            </div>
        </section>
    );
}
</file>

<file path="components/editor/blog-post-editor.tsx">
"use client"

import { useState, useMemo, useCallback, useRef, useEffect } from "react"
import { AssetLoader } from "./asset-loader"
import { CodePane } from "./code-pane"
import { PreviewPane } from "./preview-pane"
import { CopilotPane } from "./copilot-pane"
import { renderTemplate } from "@/lib/render-template"
import { Monitor, Smartphone, Loader2, Check, PanelRightClose, PanelRightOpen, ArrowLeft, History, Globe, Send } from "lucide-react"
import { useToast } from "@/hooks/use-toast"
import { cn } from "@/lib/utils"
import Link from "next/link"
import { useSearchParams } from "next/navigation"
import { Panel, PanelGroup, PanelResizeHandle, ImperativePanelHandle } from "react-resizable-panels"
import { getPostBackups } from "@/app/actions/posts"
import { formatDistanceToNow } from "date-fns"

interface BlogPostEditorProps {
    html: string
    assets: Record<string, string>
    title: string
    slug: string
    excerpt: string
    onHtmlChange: (html: string) => void
    onAssetsChange: (assets: Record<string, string>) => void
    onTitleChange: (title: string) => void
    onSlugChange: (slug: string) => void
    onExcerptChange: (excerpt: string) => void
    postName: string
    onNameChange: (name: string) => void
    onSave?: () => void
    onPublish?: () => void
    postId?: string | null
    postStatus?: 'draft' | 'published'
    onRestore?: (backup: { html_content: string; variable_values: Record<string, any> }) => void
}

export function BlogPostEditor({
    html,
    assets,
    title,
    slug,
    excerpt,
    onHtmlChange,
    onAssetsChange,
    onTitleChange,
    onSlugChange,
    onExcerptChange,
    postName,
    onNameChange,
    onSave,
    onPublish,
    postId,
    postStatus,
    onRestore
}: BlogPostEditorProps) {
    const [viewMode, setViewMode] = useState<'desktop' | 'mobile'>('desktop')
    const [saveStatus, setSaveStatus] = useState<'idle' | 'saving' | 'success'>('idle')
    const [publishStatus, setPublishStatus] = useState<'idle' | 'publishing' | 'success'>('idle')
    const [isCopilotOpen, setIsCopilotOpen] = useState(true)
    const copilotRef = useRef<ImperativePanelHandle>(null)
    const searchParams = useSearchParams()
    const currentId = searchParams.get("id")
    const { toast } = useToast()

    // Version history
    const [backups, setBackups] = useState<{ id: string; saved_at: string; title: string }[]>([])
    const [historyOpen, setHistoryOpen] = useState(false)
    const [restoringId, setRestoringId] = useState<string | null>(null)
    const historyRef = useRef<HTMLDivElement>(null)

    const fetchBackups = useCallback(async () => {
        if (!postId) return
        const data = await getPostBackups(postId)
        setBackups(data)
    }, [postId])

    useEffect(() => {
        fetchBackups()
    }, [fetchBackups])

    useEffect(() => {
        const handleClickOutside = (e: MouseEvent) => {
            if (historyRef.current && !historyRef.current.contains(e.target as Node)) {
                setHistoryOpen(false)
            }
        }
        document.addEventListener('mousedown', handleClickOutside)
        return () => document.removeEventListener('mousedown', handleClickOutside)
    }, [])

    const extractedVariables = useMemo(() => {
        const regex = /\{\{(\w+)\}\}/g
        const matches: string[] = []
        let match
        while ((match = regex.exec(html)) !== null) {
            if (!matches.includes(match[1])) matches.push(match[1])
        }
        return matches
    }, [html])

    const updateAsset = useCallback((key: string, value: string) => {
        onAssetsChange({ ...assets, [key]: value })
    }, [assets, onAssetsChange])

    const previewHtml = useMemo(() => {
        return renderTemplate(html, assets)
    }, [html, assets])

    const handleSaveClick = async () => {
        if (!onSave) return
        setSaveStatus('saving')
        await Promise.resolve(onSave())
        await fetchBackups()
        setSaveStatus('success')
        setTimeout(() => setSaveStatus('idle'), 2000)
    }

    const handlePublishClick = async () => {
        if (!onPublish) return
        setPublishStatus('publishing')
        await Promise.resolve(onPublish())
        setPublishStatus('success')
        setTimeout(() => setPublishStatus('idle'), 2000)
    }

    const toggleCopilot = () => {
        const panel = copilotRef.current
        if (panel) {
            if (isCopilotOpen) {
                panel.collapse()
            } else {
                panel.expand()
            }
        }
    }

    return (
        <div className="h-screen bg-background text-foreground overflow-hidden">
            <PanelGroup direction="horizontal">
                {/* Left Sidebar - Post Settings + Asset Loader */}
                <Panel defaultSize={15} minSize={12} maxSize={25} className="bg-background border-r border-border">
                    <div className="h-full flex flex-col">
                        {/* Header Link */}
                        <div className="p-3 border-b border-border">
                            <Link href="/admin" className="inline-flex items-center gap-1 text-xs text-muted-foreground hover:text-foreground transition-colors">
                                <ArrowLeft className="w-3 h-3" />
                                Back to Dashboard
                            </Link>
                        </div>

                        {/* Post Settings */}
                        <div className="p-4 border-b border-border bg-muted/20 space-y-3">
                            <div className="space-y-1">
                                <label className="text-[10px] uppercase font-semibold text-muted-foreground">Post Title</label>
                                <input
                                    type="text"
                                    value={title}
                                    onChange={(e) => onTitleChange(e.target.value)}
                                    className="w-full bg-background border border-border rounded px-2 py-1 text-xs focus:outline-none focus:border-primary"
                                    placeholder="My Awesome Blog Post"
                                />
                            </div>
                            <div className="space-y-1">
                                <label className="text-[10px] uppercase font-semibold text-muted-foreground">URL Slug</label>
                                <input
                                    type="text"
                                    value={slug}
                                    onChange={(e) => onSlugChange(e.target.value)}
                                    placeholder="my-awesome-post"
                                    className="w-full bg-background border border-border rounded px-2 py-1 text-xs font-mono focus:outline-none focus:border-primary"
                                />
                            </div>
                            <div className="space-y-1">
                                <label className="text-[10px] uppercase font-semibold text-muted-foreground">Excerpt</label>
                                <textarea
                                    value={excerpt}
                                    onChange={(e) => onExcerptChange(e.target.value)}
                                    className="w-full bg-background border border-border rounded px-2 py-1 text-xs h-16 resize-none focus:outline-none focus:border-primary"
                                    placeholder="A brief summary of the post..."
                                />
                            </div>
                        </div>

                        <div className="flex-1 overflow-y-auto">
                            <AssetLoader variables={extractedVariables} assets={assets} onUpdateAsset={updateAsset} showBackButton={false} />
                        </div>
                    </div>
                </Panel>

                <PanelResizeHandle className="w-1 bg-border hover:bg-primary/20 transition-colors" />

                {/* Center Left - Code Pane */}
                <Panel defaultSize={30} minSize={20} className="bg-background border-r border-border">
                    <div className="h-full overflow-hidden">
                        <CodePane code={html} onChange={onHtmlChange} className="h-full" />
                    </div>
                </Panel>

                <PanelResizeHandle className="w-1 bg-border hover:bg-primary/20 transition-colors" />

                {/* Center Right - Preview Pane */}
                <Panel defaultSize={35} minSize={25} className="bg-background flex flex-col">
                    <div className="h-full flex flex-col overflow-hidden">
                        <div className="h-14 border-b border-border flex items-center justify-between px-4 bg-card flex-shrink-0">
                            <h2 className="text-sm font-semibold">Preview</h2>

                            <div className="flex items-center gap-2">
                                {/* View Toggle */}
                                <div className="flex bg-muted p-1 rounded-lg">
                                    <button
                                        onClick={() => setViewMode('desktop')}
                                        className={cn(
                                            "p-1.5 rounded-md transition-all",
                                            viewMode === 'desktop' ? "bg-background shadow-sm text-foreground" : "text-muted-foreground hover:text-foreground"
                                        )}
                                        title="Desktop View"
                                    >
                                        <Monitor className="w-4 h-4" />
                                    </button>
                                    <button
                                        onClick={() => setViewMode('mobile')}
                                        className={cn(
                                            "p-1.5 rounded-md transition-all",
                                            viewMode === 'mobile' ? "bg-background shadow-sm text-foreground" : "text-muted-foreground hover:text-foreground"
                                        )}
                                        title="Mobile View"
                                    >
                                        <Smartphone className="w-4 h-4" />
                                    </button>
                                </div>

                                {/* Post Name */}
                                <div className="flex items-center gap-2 border-l border-border pl-2 mr-2">
                                    <input
                                        type="text"
                                        value={postName}
                                        onChange={(e) => onNameChange(e.target.value)}
                                        className="bg-transparent border-none text-sm font-medium focus:outline-none focus:ring-1 focus:ring-primary/30 rounded px-2 w-[180px] text-foreground placeholder:text-muted-foreground"
                                        placeholder="Post Title"
                                    />
                                </div>

                                {/* Save Button */}
                                {onSave && (
                                    <button
                                        type="button"
                                        onClick={handleSaveClick}
                                        disabled={saveStatus === 'saving'}
                                        className={cn(
                                            "px-4 py-2 rounded-md text-sm font-medium transition-all flex items-center gap-2",
                                            saveStatus === 'success'
                                                ? "bg-green-600 text-white hover:bg-green-700"
                                                : "bg-primary text-primary-foreground hover:bg-primary/90"
                                        )}
                                    >
                                        {saveStatus === 'saving' && <Loader2 className="w-4 h-4 animate-spin" />}
                                        {saveStatus === 'success' && <Check className="w-4 h-4" />}
                                        {saveStatus === 'idle' && "Save Post"}
                                        {saveStatus === 'saving' && "Saving..."}
                                        {saveStatus === 'success' && "Saved!"}
                                    </button>
                                )}

                                {/* Publish Button */}
                                {onPublish && postId && (
                                    <button
                                        type="button"
                                        onClick={handlePublishClick}
                                        disabled={publishStatus === 'publishing'}
                                        className={cn(
                                            "px-4 py-2 rounded-md text-sm font-medium transition-all flex items-center gap-2",
                                            publishStatus === 'success'
                                                ? "bg-green-600 text-white"
                                                : postStatus === 'published'
                                                    ? "bg-amber-600 text-white hover:bg-amber-700"
                                                    : "bg-emerald-600 text-white hover:bg-emerald-700"
                                        )}
                                    >
                                        {publishStatus === 'publishing' && <Loader2 className="w-4 h-4 animate-spin" />}
                                        {publishStatus === 'success' && <Check className="w-4 h-4" />}
                                        {publishStatus === 'idle' && <Send className="w-4 h-4" />}
                                        {publishStatus === 'publishing' && (postStatus === 'published' ? "Unpublishing..." : "Publishing...")}
                                        {publishStatus === 'success' && (postStatus === 'published' ? "Unpublished!" : "Published!")}
                                        {publishStatus === 'idle' && (postStatus === 'published' ? "Unpublish" : "Publish Post")}
                                    </button>
                                )}

                                {/* Version History */}
                                {postId && backups.length > 0 && (
                                    <div className="relative" ref={historyRef}>
                                        <button
                                            type="button"
                                            onClick={() => setHistoryOpen(!historyOpen)}
                                            className="p-2 rounded-md text-sm font-medium border border-border bg-background hover:bg-muted transition-all flex items-center gap-1.5"
                                            title="Version History"
                                        >
                                            <History className="w-4 h-4" />
                                            <span className="text-xs text-muted-foreground">{backups.length}</span>
                                        </button>
                                        {historyOpen && (
                                            <div className="absolute top-full right-0 mt-1 w-64 bg-card border border-border rounded-lg shadow-xl z-50 overflow-hidden">
                                                <div className="px-3 py-2 border-b border-border">
                                                    <p className="text-xs font-semibold text-muted-foreground uppercase">
                                                        Saved Versions
                                                    </p>
                                                </div>
                                                <div className="max-h-60 overflow-y-auto">
                                                    {backups.map((backup) => (
                                                        <button
                                                            key={backup.id}
                                                            onClick={async () => {
                                                                if (!onRestore || !postId) return
                                                                setRestoringId(backup.id)
                                                                const { restorePostBackup } = await import("@/app/actions/posts")
                                                                const result = await restorePostBackup(postId, backup.id)
                                                                if (result.success && result.data) {
                                                                    onRestore(result.data)
                                                                }
                                                                setRestoringId(null)
                                                                setHistoryOpen(false)
                                                            }}
                                                            disabled={restoringId === backup.id}
                                                            className="w-full text-left px-3 py-2.5 hover:bg-muted/50 transition-colors flex items-center justify-between gap-2 border-b border-border/50 last:border-0"
                                                        >
                                                            <div className="flex flex-col min-w-0">
                                                                <span className="text-xs font-medium text-foreground truncate">
                                                                    {backup.title || "No title"}
                                                                </span>
                                                                <span className="text-[10px] text-muted-foreground">
                                                                    {formatDistanceToNow(new Date(backup.saved_at), { addSuffix: true })}
                                                                </span>
                                                            </div>
                                                            {restoringId === backup.id && (
                                                                <Loader2 className="w-3 h-3 animate-spin text-muted-foreground flex-shrink-0" />
                                                            )}
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                )}

                                {/* Copilot Toggle */}
                                <button
                                    onClick={toggleCopilot}
                                    className={cn(
                                        "p-2 rounded-md transition-all text-sm font-medium border ml-2",
                                        isCopilotOpen
                                            ? "bg-muted text-muted-foreground hover:text-foreground border-transparent"
                                            : "bg-primary/10 text-primary border-primary/20 hover:bg-primary/20"
                                    )}
                                    title={isCopilotOpen ? "Hide Copilot" : "Show Copilot"}
                                >
                                    {isCopilotOpen ? <PanelRightClose className="w-4 h-4" /> : <PanelRightOpen className="w-4 h-4" />}
                                </button>
                            </div>
                        </div>

                        <div className="flex-1 overflow-y-auto bg-[#0f0f10] p-8">
                            <div className="h-fit min-h-[500px] mx-auto transition-all duration-300 bg-white shadow-lg my-8" style={{ maxWidth: viewMode === 'mobile' ? '375px' : '800px' }}>
                                <PreviewPane html={previewHtml} viewMode={viewMode} />
                            </div>
                        </div>
                    </div>
                </Panel>

                <PanelResizeHandle className={cn("w-1 bg-border hover:bg-primary/20 transition-colors", !isCopilotOpen && "hidden")} />

                {/* Right Sidebar - Copilot */}
                <Panel
                    ref={copilotRef}
                    defaultSize={20}
                    minSize={15}
                    maxSize={30}
                    collapsible={true}
                    collapsedSize={0}
                    onCollapse={() => setIsCopilotOpen(false)}
                    onExpand={() => setIsCopilotOpen(true)}
                    className={cn(
                        "bg-card border-l border-border transition-all duration-300 ease-in-out",
                        !isCopilotOpen && "border-none"
                    )}
                >
                    <div className="h-full overflow-hidden">
                        <CopilotPane html={html} onHtmlChange={onHtmlChange} postId={postId} />
                    </div>
                </Panel>
            </PanelGroup>
        </div>
    )
}
</file>

<file path="components/admin/posts-table.tsx">
'use client'

import { useState, useTransition } from 'react'
import Link from 'next/link'
import {
    Plus, Search, MoreHorizontal, Pencil, ExternalLink,
    Trash2, Eye, EyeOff, ChevronDown, ImageIcon, Download
} from 'lucide-react'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Badge } from '@/components/ui/badge'
import { AssetPickerModal } from '@/components/editor/asset-picker-modal'
import { Checkbox } from '@/components/ui/checkbox'
import {
    DropdownMenu,
    DropdownMenuContent,
    DropdownMenuItem,
    DropdownMenuSeparator,
    DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu'
import {
    Select,
    SelectContent,
    SelectItem,
    SelectTrigger,
    SelectValue,
} from '@/components/ui/select'
import {
    AlertDialog,
    AlertDialogAction,
    AlertDialogCancel,
    AlertDialogContent,
    AlertDialogDescription,
    AlertDialogFooter,
    AlertDialogHeader,
    AlertDialogTitle,
} from '@/components/ui/alert-dialog'
import {
    deletePost, deletePosts, togglePostStatus, updatePost, updatePostsStatus
} from '@/app/actions/posts'
import type { Post } from '@/lib/types'

const categories = ['tutorials', 'news', 'design', 'engineering', 'product', 'general']

interface PostsTableProps {
    initialPosts: Post[]
}

export function PostsTable({ initialPosts }: PostsTableProps) {
    const [posts, setPosts] = useState(initialPosts)
    const [search, setSearch] = useState('')
    const [statusFilter, setStatusFilter] = useState<string>('all')
    const [categoryFilter, setCategoryFilter] = useState<string>('all')
    const [selectedIds, setSelectedIds] = useState<string[]>([])
    const [deleteDialogOpen, setDeleteDialogOpen] = useState(false)
    const [postToDelete, setPostToDelete] = useState<string | null>(null)
    const [isPending, startTransition] = useTransition()

    // Featured image picker state
    const [imagePickerOpen, setImagePickerOpen] = useState(false)
    const [imagePostId, setImagePostId] = useState<string | null>(null)

    // Filter posts
    const filteredPosts = posts.filter(post => {
        const matchesSearch = post.title.toLowerCase().includes(search.toLowerCase()) ||
            post.slug?.toLowerCase().includes(search.toLowerCase())
        const matchesStatus = statusFilter === 'all' || post.status === statusFilter
        const matchesCategory = categoryFilter === 'all' || post.category === categoryFilter
        return matchesSearch && matchesStatus && matchesCategory
    })

    const allSelected = filteredPosts.length > 0 &&
        filteredPosts.every(post => selectedIds.includes(post.id))

    const toggleSelectAll = () => {
        if (allSelected) {
            setSelectedIds([])
        } else {
            setSelectedIds(filteredPosts.map(p => p.id))
        }
    }

    const toggleSelect = (id: string) => {
        setSelectedIds(prev =>
            prev.includes(id) ? prev.filter(i => i !== id) : [...prev, id]
        )
    }

    const handleToggleStatus = (id: string) => {
        startTransition(async () => {
            const updated = await togglePostStatus(id)
            if (updated) {
                setPosts(prev => prev.map(p => p.id === id ? updated : p))
            }
        })
    }

    const handleUpdateCategory = (id: string, category: string) => {
        startTransition(async () => {
            await updatePost(id, { category })
            setPosts(prev => prev.map(p => p.id === id ? { ...p, category } : p))
        })
    }

    // ── Featured image handlers ──────────────────────────────
    const openImagePicker = (post: Post) => {
        setImagePostId(post.id)
        setImagePickerOpen(true)
    }

    const handleAssetSelect = (url: string) => {
        if (!imagePostId) return
        startTransition(async () => {
            await updatePost(imagePostId, { featured_image: url || null })
            setPosts(prev => prev.map(p =>
                p.id === imagePostId ? { ...p, featured_image: url || null } : p
            ))
            setImagePickerOpen(false)
        })
    }

    const handleDelete = (id: string) => {
        setPostToDelete(id)
        setDeleteDialogOpen(true)
    }

    const confirmDelete = () => {
        if (!postToDelete) return
        startTransition(async () => {
            await deletePost(postToDelete)
            setPosts(prev => prev.filter(p => p.id !== postToDelete))
            setSelectedIds(prev => prev.filter(id => id !== postToDelete))
            setPostToDelete(null)
            setDeleteDialogOpen(false)
        })
    }

    const handleBulkDelete = () => {
        setPostToDelete(null)
        setDeleteDialogOpen(true)
    }

    const confirmBulkDelete = () => {
        startTransition(async () => {
            await deletePosts(selectedIds)
            setPosts(prev => prev.filter(p => !selectedIds.includes(p.id)))
            setSelectedIds([])
            setDeleteDialogOpen(false)
        })
    }

    const handleBulkStatusChange = (status: 'draft' | 'published') => {
        startTransition(async () => {
            await updatePostsStatus(selectedIds, status)
            setPosts(prev => prev.map(p =>
                selectedIds.includes(p.id)
                    ? { ...p, status, published_at: status === 'published' ? new Date().toISOString() : null }
                    : p
            ))
            setSelectedIds([])
        })
    }

    return (
        <div className="space-y-4">
            {/* Toolbar */}
            <div className="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
                <div className="flex flex-1 items-center gap-3">
                    <div className="relative flex-1 max-w-sm">
                        <Search className="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground" />
                        <Input
                            placeholder="Search posts..."
                            value={search}
                            onChange={(e) => setSearch(e.target.value)}
                            className="pl-9"
                        />
                    </div>
                    <Select value={statusFilter} onValueChange={setStatusFilter}>
                        <SelectTrigger className="w-[130px]">
                            <SelectValue placeholder="Status" />
                        </SelectTrigger>
                        <SelectContent>
                            <SelectItem value="all">All Status</SelectItem>
                            <SelectItem value="published">Published</SelectItem>
                            <SelectItem value="draft">Draft</SelectItem>
                        </SelectContent>
                    </Select>
                    <Select value={categoryFilter} onValueChange={setCategoryFilter}>
                        <SelectTrigger className="w-[140px]">
                            <SelectValue placeholder="Category" />
                        </SelectTrigger>
                        <SelectContent>
                            <SelectItem value="all">All Categories</SelectItem>
                            {categories.map(cat => (
                                <SelectItem key={cat} value={cat} className="capitalize">{cat}</SelectItem>
                            ))}
                        </SelectContent>
                    </Select>
                </div>
                <div className="flex items-center gap-3">
                    {selectedIds.length > 0 && (
                        <DropdownMenu>
                            <DropdownMenuTrigger asChild>
                                <Button variant="outline" size="sm">
                                    Bulk Actions ({selectedIds.length})
                                    <ChevronDown className="ml-2 h-4 w-4" />
                                </Button>
                            </DropdownMenuTrigger>
                            <DropdownMenuContent align="end">
                                <DropdownMenuItem onClick={() => handleBulkStatusChange('published')}>
                                    <Eye className="mr-2 h-4 w-4" />
                                    Publish Selected
                                </DropdownMenuItem>
                                <DropdownMenuItem onClick={() => handleBulkStatusChange('draft')}>
                                    <EyeOff className="mr-2 h-4 w-4" />
                                    Unpublish Selected
                                </DropdownMenuItem>
                                <DropdownMenuSeparator />
                                <DropdownMenuItem
                                    onClick={handleBulkDelete}
                                    className="text-red-400 focus:text-red-400"
                                >
                                    <Trash2 className="mr-2 h-4 w-4" />
                                    Delete Selected
                                </DropdownMenuItem>
                            </DropdownMenuContent>
                        </DropdownMenu>
                    )}
                    <Button asChild>
                        <Link href="/editor">
                            <Plus className="mr-2 h-4 w-4" />
                            New Post
                        </Link>
                    </Button>
                </div>
            </div>

            {/* Table */}
            <div className="rounded-lg border border-border">
                <table className="w-full">
                    <thead>
                        <tr className="border-b border-border bg-muted/50">
                            <th className="w-12 px-4 py-3">
                                <Checkbox
                                    checked={allSelected}
                                    onCheckedChange={toggleSelectAll}
                                    aria-label="Select all"
                                />
                            </th>
                            <th className="px-4 py-3 text-left text-sm font-medium text-muted-foreground">Thumbnail</th>
                            <th className="px-4 py-3 text-left text-sm font-medium text-muted-foreground">Title</th>
                            <th className="px-4 py-3 text-left text-sm font-medium text-muted-foreground">Slug</th>
                            <th className="px-4 py-3 text-left text-sm font-medium text-muted-foreground">Status</th>
                            <th className="px-4 py-3 text-left text-sm font-medium text-muted-foreground">Category</th>
                            <th className="px-4 py-3 text-left text-sm font-medium text-muted-foreground">Updated</th>
                            <th className="w-12 px-4 py-3"></th>
                        </tr>
                    </thead>
                    <tbody>
                        {filteredPosts.length === 0 ? (
                            <tr>
                                <td colSpan={8} className="px-4 py-12 text-center text-muted-foreground">
                                    No posts found
                                </td>
                            </tr>
                        ) : (
                            filteredPosts.map((post) => (
                                <tr key={post.id} className="border-b border-border last:border-0 hover:bg-muted/30">
                                    <td className="px-4 py-3">
                                        <Checkbox
                                            checked={selectedIds.includes(post.id)}
                                            onCheckedChange={() => toggleSelect(post.id)}
                                            aria-label={`Select ${post.title}`}
                                        />
                                    </td>
                                    <td className="px-4 py-3">
                                        <button
                                            onClick={() => openImagePicker(post)}
                                            className="group/thumb relative h-10 w-14 rounded border border-border overflow-hidden bg-muted/30 hover:border-accent transition-colors cursor-pointer flex items-center justify-center"
                                            title={post.featured_image ? 'Change thumbnail' : 'Set thumbnail'}
                                        >
                                            {post.featured_image ? (
                                                <img
                                                    src={post.featured_image}
                                                    alt=""
                                                    className="h-full w-full object-cover"
                                                />
                                            ) : (
                                                <ImageIcon className="h-4 w-4 text-muted-foreground" />
                                            )}
                                        </button>
                                    </td>
                                    <td className="px-4 py-3">
                                        <Link
                                            href={`/editor?id=${post.id}`}
                                            className="font-medium text-foreground hover:underline"
                                        >
                                            {post.title || 'Untitled'}
                                        </Link>
                                    </td>
                                    <td className="px-4 py-3">
                                        <span className="text-sm text-muted-foreground font-mono">
                                            {post.slug || '-'}
                                        </span>
                                    </td>
                                    <td className="px-4 py-3">
                                        <button
                                            onClick={() => handleToggleStatus(post.id)}
                                            disabled={isPending}
                                            className="cursor-pointer"
                                        >
                                            <Badge
                                                variant={post.status === 'published' ? 'default' : 'secondary'}
                                                className={post.status === 'published'
                                                    ? 'bg-green-500/20 text-green-400 hover:bg-green-500/30'
                                                    : 'bg-yellow-500/20 text-yellow-400 hover:bg-yellow-500/30'
                                                }
                                            >
                                                {post.status}
                                            </Badge>
                                        </button>
                                    </td>
                                    <td className="px-4 py-3">
                                        <Select
                                            value={post.category || 'general'}
                                            onValueChange={(val) => handleUpdateCategory(post.id, val)}
                                        >
                                            <SelectTrigger className="h-8 w-[120px] text-xs">
                                                <SelectValue />
                                            </SelectTrigger>
                                            <SelectContent>
                                                {categories.map(cat => (
                                                    <SelectItem key={cat} value={cat} className="capitalize text-xs">
                                                        {cat}
                                                    </SelectItem>
                                                ))}
                                            </SelectContent>
                                        </Select>
                                    </td>
                                    <td className="px-4 py-3">
                                        <span className="text-sm text-muted-foreground">
                                            {new Date(post.updated_at).toLocaleDateString('en-US', {
                                                month: 'short',
                                                day: 'numeric',
                                                year: 'numeric',
                                            })}
                                        </span>
                                    </td>
                                    <td className="px-4 py-3">
                                        <DropdownMenu>
                                            <DropdownMenuTrigger asChild>
                                                <Button variant="ghost" size="icon" className="h-8 w-8">
                                                    <MoreHorizontal className="h-4 w-4" />
                                                    <span className="sr-only">Actions</span>
                                                </Button>
                                            </DropdownMenuTrigger>
                                            <DropdownMenuContent align="end">
                                                <DropdownMenuItem asChild>
                                                    <Link href={`/editor?id=${post.id}`}>
                                                        <Pencil className="mr-2 h-4 w-4" />
                                                        Edit
                                                    </Link>
                                                </DropdownMenuItem>
                                                {post.slug && (
                                                    <DropdownMenuItem asChild>
                                                        <Link href={`/blog/${post.slug}`} target="_blank">
                                                            <ExternalLink className="mr-2 h-4 w-4" />
                                                            View
                                                        </Link>
                                                    </DropdownMenuItem>
                                                )}
                                                {post.html_content && (
                                                    <DropdownMenuItem
                                                        onClick={() => {
                                                            const blob = new Blob([post.html_content!], { type: 'text/html' })
                                                            const url = URL.createObjectURL(blob)
                                                            const a = document.createElement('a')
                                                            a.href = url
                                                            a.download = `${post.slug || post.id}.html`
                                                            document.body.appendChild(a)
                                                            a.click()
                                                            document.body.removeChild(a)
                                                            URL.revokeObjectURL(url)
                                                        }}
                                                    >
                                                        <Download className="mr-2 h-4 w-4" />
                                                        Download HTML
                                                    </DropdownMenuItem>
                                                )}
                                                <DropdownMenuItem onClick={() => handleToggleStatus(post.id)}>
                                                    {post.status === 'published' ? (
                                                        <>
                                                            <EyeOff className="mr-2 h-4 w-4" />
                                                            Unpublish
                                                        </>
                                                    ) : (
                                                        <>
                                                            <Eye className="mr-2 h-4 w-4" />
                                                            Publish
                                                        </>
                                                    )}
                                                </DropdownMenuItem>
                                                <DropdownMenuSeparator />
                                                <DropdownMenuItem
                                                    onClick={() => handleDelete(post.id)}
                                                    className="text-red-400 focus:text-red-400"
                                                >
                                                    <Trash2 className="mr-2 h-4 w-4" />
                                                    Delete
                                                </DropdownMenuItem>
                                            </DropdownMenuContent>
                                        </DropdownMenu>
                                    </td>
                                </tr>
                            ))
                        )}
                    </tbody>
                </table>
            </div>

            {/* Delete Confirmation Dialog */}
            <AlertDialog open={deleteDialogOpen} onOpenChange={setDeleteDialogOpen}>
                <AlertDialogContent>
                    <AlertDialogHeader>
                        <AlertDialogTitle>Are you sure?</AlertDialogTitle>
                        <AlertDialogDescription>
                            {postToDelete
                                ? 'This action cannot be undone. This will permanently delete this post.'
                                : `This action cannot be undone. This will permanently delete ${selectedIds.length} post(s).`
                            }
                        </AlertDialogDescription>
                    </AlertDialogHeader>
                    <AlertDialogFooter>
                        <AlertDialogCancel>Cancel</AlertDialogCancel>
                        <AlertDialogAction
                            onClick={postToDelete ? confirmDelete : confirmBulkDelete}
                            className="bg-red-500 hover:bg-red-600"
                        >
                            Delete
                        </AlertDialogAction>
                    </AlertDialogFooter>
                </AlertDialogContent>
            </AlertDialog>

            {/* Featured Image Picker (reuses editor asset picker) */}
            <AssetPickerModal
                isOpen={imagePickerOpen}
                onClose={() => setImagePickerOpen(false)}
                onSelect={handleAssetSelect}
            />
        </div>
    )
}
</file>

<file path="app/api/copilot/route.ts">
import { createClient } from "@supabase/supabase-js";
import { GoogleGenerativeAI } from "@google/generative-ai";
import Anthropic from "@anthropic-ai/sdk";
import { NextResponse } from "next/server";
import { getAllContextForAudience, formatContextForPrompt } from "@/app/actions/settings";

// Initialize Admin Client (Service Key) to bypass RLS if needed
const supabase = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_KEY!
);

// Robust JSON extractor: finds the first '{' and last '}' to ignore chatty text
function extractJson(text: string) {
    const start = text.indexOf('{');
    const end = text.lastIndexOf('}');
    if (start !== -1 && end !== -1 && end > start) {
        return text.substring(start, end + 1);
    }
    return text; // Fallback
}

// Fallback: manually extract updatedHtml and explanation when JSON.parse fails
// This handles cases where the AI generates valid HTML but with characters that break JSON parsing
function manualExtractClassic(raw: string): { updatedHtml: string; explanation: string } | null {
    try {
        // Look for the HTML between "updatedHtml" key value markers
        // The AI typically outputs: "updatedHtml": "<!DOCTYPE html>..."  or  "updatedHtml": "<!doctype html>..."
        const htmlMatch = raw.match(/"updatedHtml"\s*:\s*"([\s\S]*?)"\s*(?:,\s*"[a-zA-Z_]|\}$)/);

        // Also try to grab from <!DOCTYPE to </html> directly
        let html = '';
        if (htmlMatch) {
            html = htmlMatch[1]
                .replace(/\\n/g, '\n')
                .replace(/\\t/g, '\t')
                .replace(/\\"/g, '"')
                .replace(/\\\\/g, '\\');
        } else {
            // Last resort: find raw HTML in the response
            const docMatch = raw.match(/(<!DOCTYPE html[\s\S]*?<\/html>)/i);
            if (docMatch) {
                html = docMatch[1];
            }
        }

        if (!html) return null;

        // Extract explanation
        const expMatch = raw.match(/"explanation"\s*:\s*"([^"]*(?:\\.[^"]*)*)"/);
        const explanation = expMatch
            ? expMatch[1].replace(/\\"/g, '"').replace(/\\n/g, '\n')
            : "Changes applied successfully.";

        return { updatedHtml: html, explanation };
    } catch {
        return null;
    }
}

// Helper: Download image from URL and convert to Base64
async function urlToBase64(url: string) {
    try {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Failed to fetch image: ${response.statusText}`);
        const arrayBuffer = await response.arrayBuffer();
        const buffer = Buffer.from(arrayBuffer);
        const base64 = buffer.toString('base64');
        const mediaType = response.headers.get('content-type') || 'image/jpeg';
        return { base64, mediaType };
    } catch (e) {
        console.error("Image fetch failed", e);
        return null;
    }
}

export async function POST(req: Request) {
    try {
        const { currentHtml, messages, model, audienceContext = "dreamplay", aiDossier: clientDossier = "", modelLow, modelMedium, imageMode = "library", themeHtml } = await req.json();

        // User-designated tier models (fallback to defaults)
        const tierLow = modelLow || "claude-haiku-4-5-20251001";
        const tierMedium = modelMedium || "claude-sonnet-4-6";

        // --- SMART ROUTER LOGIC ---
        let actualModel = model;
        let routingReason = "";

        if (model === "auto") {
            const lastUserMessage = messages.filter((m: any) => m.role === 'user').pop();
            const hasImages = lastUserMessage?.imageUrls?.length > 0;
            const isEmpty = !currentHtml || currentHtml.trim() === "";

            if (isEmpty) {
                // Empty canvas always needs the stronger model (building from scratch)
                actualModel = tierMedium;
                routingReason = `New template from scratch → Medium (${tierMedium}).`;
            } else if (hasImages) {
                // Images present — vision tasks need the stronger model
                actualModel = tierMedium;
                routingReason = `Vision task (screenshot reference) → Medium (${tierMedium}).`;
            } else {
                // Text-only: fast classification using Gemini Flash
                try {
                    const { GoogleGenerativeAI } = await import("@google/generative-ai");
                    const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY!);
                    const flash = genAI.getGenerativeModel({
                        model: "gemini-2.0-flash",
                        generationConfig: { maxOutputTokens: 10, temperature: 0 }
                    });

                    const routerPrompt = `You are a routing agent for an email editor.
User request: "${lastUserMessage?.content}"
Is this a simple edit (changing text, fixing a typo, updating a color, swapping a link) or a complex edit (creating new layouts, adding new sections, structural redesign)?
Reply ONLY with the exact word "SIMPLE" or "COMPLEX".`;

                    const routerResult = await flash.generateContent(routerPrompt);
                    const intent = routerResult.response.text().trim().toUpperCase();

                    if (intent.includes("COMPLEX")) {
                        actualModel = tierMedium;
                        routingReason = `Complex structural edit → Medium (${tierMedium}).`;
                    } else {
                        actualModel = tierLow;
                        routingReason = `Simple text/style edit → Low (${tierLow}).`;
                    }
                } catch (e) {
                    actualModel = tierMedium;
                    routingReason = `Router fallback → Medium (${tierMedium}).`;
                }
            }
            console.log(`[Smart Router] ${routingReason} (model: ${actualModel})`);
        }
        // ------------------------------

        // 1. FETCH AUDIENCE-DRIVEN CONTEXT ⚡️
        const payload = await getAllContextForAudience(audienceContext);
        const { contextBlock: dynamicContext, linksBlock: defaultLinksBlock } = await formatContextForPrompt(payload, audienceContext);

        // 2. FETCH KNOWLEDGEBASE (server-side) ⚡️
        let aiDossier = clientDossier;
        if (!aiDossier) {
            try {
                const { data: kbDocs } = await supabase
                    .from("research_knowledgebase")
                    .select("*")
                    .eq("is_active", true);
                if (kbDocs && kbDocs.length > 0) {
                    aiDossier = kbDocs.map((doc: any) => `--- SOURCE: ${doc.title} ${doc.author ? `(by ${doc.author})` : ''} ---\n${doc.content}`).join("\n\n");
                    console.log(`[Knowledgebase] Injected ${kbDocs.length} active research doc(s) into prompt`);
                }
            } catch (e) {
                console.error("[Knowledgebase] Failed to fetch:", e);
            }
        }

        // 3. BUILD DYNAMIC IMAGE INSTRUCTIONS ⚡️
        let imageContextBlock = "";
        let imageRuleBlock = `4. **IMAGE VARIABLES:** When adding images, the \`src\` attribute MUST use new {{mustache}} variables (e.g. {{golf_fitting_src}}). The variable name MUST end with _src, _bg, _logo, _icon, or _img. Do NOT hardcode image URLs. ALWAYS wrap the image in a clickable link using a corresponding _link_url variable.`;

        if (imageMode === 'library') {
            const { getDescribedAssets } = await import("@/app/actions/assets");
            const library = await getDescribedAssets();
            if (library && library.length > 0) {
                const libraryText = library.map((img: any) => `- URL: ${img.public_url}\n  Description: ${img.description}`).join("\n\n");
                imageContextBlock = `\n### ASSET LIBRARY:\nYou have access to the following pre-uploaded images.\n${libraryText}\n`;
                imageRuleBlock = `4. **IMAGE HANDLING (LIBRARY MODE):** \n   - Read the descriptions in the ASSET LIBRARY below. \n   - If a library image fits the context, HARDCODE its exact URL directly into the \`src\` attribute (e.g., \`<img src="https://..." />\`).\n   - If NO image in the library fits (e.g., you are inventing a novel concept or analogy), use a dynamic AI placeholder: \`https://image.pollinations.ai/prompt/{URL_ENCODED_PROMPT}?width=800&height=400&nologo=true\`.\n   - DO NOT use {{mustache}} variables for the \`src\` attribute! Hardcode the actual URLs (from the library or pollinations.ai) so they render immediately.\n   - ALWAYS wrap ANY image in a clickable link using a corresponding {{mustache_link_url}} variable so the user can link it somewhere.`;
            } else {
                imageRuleBlock = `4. **IMAGE HANDLING:** HARDCODE a dynamic AI placeholder directly into the \`src\` attribute: \`https://image.pollinations.ai/prompt/{URL_ENCODED_PROMPT}?width=800&height=400&nologo=true\`. DO NOT use {{mustache}} variables for the \`src\` attribute. ALWAYS wrap the image in a clickable link using a corresponding {{mustache_link_url}} variable.`;
            }
        } else if (imageMode === 'creative') {
            imageRuleBlock = `4. **IMAGE HANDLING (CREATIVE MODE):** Do NOT use existing images. For ALL images, you must generate a highly creative AI image placeholder using this exact format directly in the \`src\` attribute: \`https://image.pollinations.ai/prompt/{URL_ENCODED_PROMPT}?width=800&height=400&nologo=true\`. Example: \`<img src="https://image.pollinations.ai/prompt/Professional%20golf%20club%20fitting?width=800&height=400&nologo=true" />\`. DO NOT use {{mustache}} variables for the \`src\` attribute. ALWAYS wrap the image in a clickable link using a corresponding {{mustache_link_url}} variable.`;
        }

        // 4. Process History: Convert ALL image URLs to Base64
        // We do this server-side so we don't hit the 4MB payload limit from the client.
        // We only keep the last 3 messages' images to save tokens/money, but we keep ALL text.
        const processedMessages = await Promise.all(messages.map(async (msg: any, index: number) => {
            const isRecent = index >= messages.length - 3; // Only keep images from last 3 messages

            let processedImages: any[] = [];

            if (isRecent && msg.imageUrls && msg.imageUrls.length > 0) {
                // Parallel download
                const downloads = await Promise.all(msg.imageUrls.map((url: string) => urlToBase64(url)));
                processedImages = downloads.filter(img => img !== null);
            }

            return {
                role: msg.role,
                content: msg.content,
                images: processedImages // Now contains { base64, mediaType }
            };
        }));

        const systemInstruction = `
    You are an expert Blog Post HTML Developer.
    The user will give you HTML and a request. You are building web blog posts, NOT emails.
    
    ### 🛑 CRITICAL INTEGRITY RULES:
    1. **NEVER DELETE CONTENT:** Unless explicitly asked to remove something, you must PRESERVE ALL existing sections, text, images, and structure. The user's screenshot may show only ONE section, but you MUST return the ENTIRE blog post.
    2. **ALWAYS RETURN THE COMPLETE HTML DOCUMENT** starting with <!DOCTYPE html> and ending with </html>. Include EVERY section from the original HTML, even if the user's edit only affects one small part. If you return partial HTML, the entire post will be overwritten and the user will lose their work.
    3. **EDITING TEXT = FULL HTML:** Even for small text changes, return the full HTML document with only the requested text modified and everything else preserved exactly.
    
    ### CODING STANDARDS:
    1. **LAYOUT:** Use modern HTML5 (<article>, <section>, <div>, <header>, <footer>). You can use semantic tags and CSS Flexbox/Grid. NO TABLE LAYOUTS!
    2. **RESPONSIVENESS:** Ensure sections stack gracefully on mobile devices using standard CSS classes or inline styles. Use max-width containers with auto margins.
    3. **VARIABLES:** Preserve {{mustache_vars}}.
    ${imageRuleBlock}
    5. **NO EM-DASHES:** Never use em-dashes (—) in any copy or text you write. Use commas, periods, or semicolons instead.
    6. **READABLE COPY FORMATTING:** When writing or editing paragraph text/copy, add sparse inline formatting to improve scannability. Use \`<strong>\` to bold 1-2 key value propositions or outcomes per paragraph (the phrases you want the reader to remember). Use \`<u>\` to underline one supporting detail or benefit phrase per paragraph. Don't overdo it: most sentences should remain unformatted. The goal is to let a skimming reader grasp the main points from the bold text alone.
    7. **TYPOGRAPHY:** Use modern web fonts (e.g. system-ui, -apple-system, or Google Fonts). Use good line-height (1.6-1.8 for body text). Use proper heading hierarchy.
    
    ### 🛑 STRICT FACT & QUOTE RULES:
    1. NEVER invent, fabricate, or hallucinate quotes, testimonials, or people.
    2. If you quote someone, use a case study, or tell a story, it MUST be extracted verbatim from the provided "AUDIENCE INTELLIGENCE" section (e.g., use the real stories of Christopher Donison, Eliana Yi, Josef Hofmann, etc.). DO NOT invent fake personas like "Sarah M." or "Hannah Tsai".
    3. Do NOT make up statistics. Use ONLY the exact data provided (e.g., 87.1% of adult females, University of North Texas). Do not conflate universities or researchers.
    4. If the AUDIENCE INTELLIGENCE section is empty or not provided, do NOT fabricate any quotes or case studies. Write general copy instead.
    
    ### TEMPLATE CREATION DEFAULTS:
    When asked to create a NEW blog post from scratch or from a reference image:
    - All text/copy MUST be hardcoded directly in the HTML (not mustache variables). Write the actual words into the template.
    - For images, follow the IMAGE HANDLING rule above (rule #4).
    - All non-image links (href on <a> tags) MUST use {{mustache_variable}} names (e.g. {{cta_link_url}}, {{hero_link_url}}).
    - This means the user only needs to set link destinations, while images and text are baked in.
    
    ### RESPONSE FORMAT (STRICT JSON ONLY):
    You MUST return ONLY a valid JSON object. Do not include any conversational text before or after the JSON.
    {
      "_thoughts": "Think step-by-step about what needs to be changed. Explain your math or logic here before writing the code.",
      "explanation": "A brief, friendly summary of changes for the user interface",
      "updatedHtml": "<!DOCTYPE html>\n<html>...</html>"
    }
    
    ### CRITICAL: QUESTION vs EDIT DETECTION:
    If the user is asking a QUESTION, requesting SUGGESTIONS, brainstorming ideas, or anything that does NOT require modifying the HTML:
    - Set "updatedHtml" to the EXACT ORIGINAL HTML unchanged (copy it character-for-character)
    - Put your full answer/suggestions in the "explanation" field
    - Do NOT replace the HTML with text responses, lists, or suggestions
    Examples of questions (DO NOT modify HTML): "suggest post titles", "what do you think of this copy", "come up with alternatives", "how can I improve", "give me ideas"
    Examples of edits (DO modify HTML): "change the title to X", "make the button red", "add a new section"
    
    ### 🛑 CRITICAL OVERRIDE — BLOG POST GENERATION IS ALWAYS AN EDIT:
    If the user says anything like "make this into a blog post", "build this out", "create a blog post", "write the blog post", "turn this into a post", or references earlier conversational content and asks you to generate it as a blog post — this is ALWAYS an EDIT, even if the conversation so far has been entirely conversational.
    - You MUST generate a full HTML blog post in "updatedHtml"
    - Do NOT put the blog post content in the "explanation" field as plain text
    - If the current HTML is empty or blank, you are building from scratch — return a complete HTML document in "updatedHtml"
    - The "explanation" field should contain only a SHORT summary of what you built (e.g., "Created a blog post about X with Y sections")
    - When in doubt about whether to generate HTML or respond conversationally, ALWAYS generate HTML if the user mentions "blog post", "post", "article", or "build it out"
    
    ### COMPANY CONTEXT:
    ${dynamicContext}
    ${defaultLinksBlock}
${aiDossier ? `
    ### AUDIENCE INTELLIGENCE:
    ${aiDossier}
` : ""}
    ${imageContextBlock}
${themeHtml ? `
    ### MANDATORY DESIGN THEME:
    The user has selected a specific design theme. You MUST use the provided HTML and CSS structure below as the exact foundation for the new blog post.
    - Keep the CSS <style> block completely intact.
    - Preserve the DOM structure, typography classes, and colors. Do NOT invent your own styling.
    - Swap out the placeholder text for the actual blog post content you generate.
    - Duplicate or arrange the layout components (like cards or quotes) as needed to fit the article length.

    ### PROVIDED THEME SKELETON:
    ${themeHtml}
` : ""}
    `;

        let rawResponse = "";
        let usageMeta = { model: actualModel, inputTokens: 0, outputTokens: 0, cost: 0 };

        // Pricing per million tokens
        const PRICING: Record<string, { input: number; output: number }> = {
            "claude-3-5-haiku-latest": { input: 0.80, output: 4.00 },
            "claude-haiku-4-5-20251001": { input: 0.80, output: 4.00 },
            "claude-sonnet-4-20250514": { input: 3.00, output: 15.00 },
            "claude-sonnet-4-6": { input: 3.00, output: 15.00 },
        };

        // --- A. CLAUDE (Anthropic) ---
        if (actualModel.includes("claude")) {
            const anthropic = new Anthropic({ apiKey: process.env.ANTHROPIC_API_KEY });

            const anthropicMessages = processedMessages.map((msg: any) => {
                const role = (msg.role === 'result' ? 'assistant' : 'user') as "assistant" | "user";
                let content: any[] = [];

                // Add Images & Documents (PDFs)
                if (msg.images) {
                    msg.images.forEach((img: any) => {
                        const isPdf = img.mediaType === 'application/pdf';
                        content.push({
                            type: isPdf ? "document" : "image",
                            source: {
                                type: "base64",
                                media_type: img.mediaType,
                                data: img.base64
                            }
                        });
                    });
                }

                // Add Text
                if (msg.content) content.push({ type: "text", text: msg.content });

                return { role, content };
            });

            // Append Context to Last Message
            const lastMsg = anthropicMessages[anthropicMessages.length - 1];
            if (lastMsg.role === 'user') {
                lastMsg.content.push({ type: "text", text: `\n\n### CURRENT HTML:\n${currentHtml}` });
            }

            const stream = anthropic.messages.stream({
                model: actualModel,
                max_tokens: 32768,
                temperature: 0,
                system: systemInstruction,
                messages: anthropicMessages
            });

            const msg = await stream.finalMessage();

            const textBlock = msg.content[0];
            if (textBlock.type === 'text') rawResponse = textBlock.text;

            // Track usage
            if (msg.usage) {
                usageMeta.inputTokens = msg.usage.input_tokens;
                usageMeta.outputTokens = msg.usage.output_tokens;
                const pricing = PRICING[actualModel] || { input: 3, output: 15 };
                usageMeta.cost = (msg.usage.input_tokens / 1_000_000 * pricing.input) + (msg.usage.output_tokens / 1_000_000 * pricing.output);
            }
        }

        // --- B. GEMINI (Google) ---
        else {
            const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY!);
            const geminiModel = genAI.getGenerativeModel({
                model: "gemini-1.5-pro",
                generationConfig: { responseMimeType: "application/json" }
            });

            const geminiHistory = processedMessages.map((msg: any) => {
                const role = msg.role === 'result' ? 'model' : 'user';
                const parts = [];

                if (msg.images) {
                    msg.images.forEach((img: any) => {
                        parts.push({
                            inlineData: {
                                mimeType: img.mediaType,
                                data: img.base64
                            }
                        });
                    });
                }

                if (msg.content) parts.push({ text: msg.content });
                return { role, parts };
            });

            const lastMsg = geminiHistory[geminiHistory.length - 1];
            lastMsg.parts.push({ text: `\n\n### CURRENT HTML:\n${currentHtml}` });

            // Inject system instruction into first message
            if (geminiHistory.length > 0) {
                const firstPart = geminiHistory[0].parts[0];
                if (firstPart.text) {
                    firstPart.text = `${systemInstruction}\n\n${firstPart.text}`;
                } else {
                    geminiHistory[0].parts.unshift({ text: systemInstruction });
                }
            }

            const result = await geminiModel.generateContent({ contents: geminiHistory });
            rawResponse = result.response.text();
        }

        // --- PARSE ---
        try {
            const cleaned = extractJson(rawResponse);
            const parsed = JSON.parse(cleaned);

            parsed.meta = usageMeta;

            if (routingReason) {
                parsed.explanation = `*(⚡️ ${routingReason})*\n\n` + (parsed.explanation || "");
            }

            return NextResponse.json(parsed);
        } catch (e: any) {
            console.error("JSON Parse Error:", e.message);
            console.error("Raw response preview (first 500 chars):", rawResponse.substring(0, 500));
            // Fallback: try to manually extract HTML and explanation
            const fallback = manualExtractClassic(rawResponse);
            if (fallback) {
                console.log("Recovered via manual extraction fallback");
                return NextResponse.json(fallback);
            }
            return NextResponse.json({
                updatedHtml: currentHtml,
                explanation: "I successfully generated the code, but my output formatting broke. Please try asking me again!"
            });
        }

    } catch (error: any) {
        console.error("API Error:", error);
        return NextResponse.json({ error: error.message }, { status: 500 });
    }
}
</file>

<file path="components/editor/copilot-pane.tsx">
"use client"

import { useState, useRef, useEffect, useCallback } from "react"
import { Sparkles, Send, X, Zap, Brain, Bot, Paperclip, Loader2, FileText, History, Plus, LayoutTemplate, Palette } from "lucide-react"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select"
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from "@/components/ui/dialog"
import { ScrollArea } from "@/components/ui/scroll-area"
import { Badge } from "@/components/ui/badge"
import { cn } from "@/lib/utils"
import { getAnthropicModels } from "@/app/actions/ai-models"
import { getTemplateList, getPostHtml } from "@/app/actions/posts"
import { renderTemplate } from "@/lib/render-template"

interface Message {
    role: "user" | "details" | "result"
    content: string
    imageUrls?: string[]
}

interface CopilotPaneProps {
    html: string
    onHtmlChange: (html: string, prompt: string) => void
    audienceContext?: "dreamplay" | "musicalbasics" | "both"
    aiDossier?: string
    postId?: string | null
}

interface ChatSession {
    id: string
    startedAt: string
    messages: Message[]
}

const MAX_SESSIONS = 5
const STORAGE_PREFIX = "blog_copilot_sessions_"

// Module-level map to persist in-flight loading state across React remounts.
// Keyed by postId (or "_new" for unsaved posts). When the component remounts
// (e.g. due to HMR, Suspense re-suspend, or tab-switch in dev mode),
// isLoading can initialize from this map instead of defaulting to false.
const inflightRequests = new Map<string, AbortController>()

type ComputeTier = "low" | "medium" | "high"

export function CopilotPane({ html, onHtmlChange, audienceContext = "dreamplay", aiDossier = "", postId }: CopilotPaneProps) {
    const [overrideModel, setOverrideModel] = useState<string | null>(null)
    const [availableModels, setAvailableModels] = useState<string[]>([])
    const [imageMode, setImageMode] = useState<"library" | "creative">("library")
    const [themes, setThemes] = useState<any[]>([])
    const [selectedThemeId, setSelectedThemeId] = useState<string>("none")

    const [modelLow, setModelLow] = useState("claude-haiku-4-5-20251001")
    const [modelMedium, setModelMedium] = useState("claude-sonnet-4-6")
    const [modelHigh, setModelHigh] = useState("claude-opus-4-6")
    const [autoRouting, setAutoRouting] = useState(false)

    useEffect(() => {
        getAnthropicModels().then(models => {
            if (models.length > 0) setAvailableModels(models)
        })

        // Lazy load themes
        import("@/app/actions/themes").then(m => m.getThemes().then(setThemes))

        const low = localStorage.getItem("mb_model_low")
        const med = localStorage.getItem("mb_model_medium")
        const high = localStorage.getItem("mb_model_high")
        const auto = localStorage.getItem("mb_auto_routing")
        if (low) setModelLow(low)
        if (med) setModelMedium(med)
        if (high) setModelHigh(high)
        if (auto === "true") setAutoRouting(true)
    }, [])

    const getModelForTier = (tier: ComputeTier): string => {
        if (overrideModel) return overrideModel
        switch (tier) {
            case "low": return modelLow
            case "medium": return modelMedium
            case "high": return modelHigh
        }
    }

    const [currentSessionId, setCurrentSessionId] = useState<string>(() => `s-${Date.now()}`)
    const [sessions, setSessions] = useState<ChatSession[]>([])
    const [sessionPickerOpen, setSessionPickerOpen] = useState(false)
    const sessionPickerRef = useRef<HTMLDivElement>(null)

    useEffect(() => {
        if (!postId) return
        try {
            const raw = localStorage.getItem(`${STORAGE_PREFIX}${postId}`)
            if (raw) {
                const saved: ChatSession[] = JSON.parse(raw)
                setSessions(saved)
                if (saved.length > 0) {
                    const latest = saved[0]
                    setCurrentSessionId(latest.id)
                    setMessages(latest.messages)
                }
            }
        } catch (e) {
            console.error("Failed to load copilot sessions:", e)
        }
    }, [postId])

    const saveCurrentSession = useCallback((msgs: Message[]) => {
        if (!postId || msgs.length <= 1) return
        try {
            const raw = localStorage.getItem(`${STORAGE_PREFIX}${postId}`)
            let allSessions: ChatSession[] = raw ? JSON.parse(raw) : []

            const existingIdx = allSessions.findIndex(s => s.id === currentSessionId)
            const session: ChatSession = {
                id: currentSessionId,
                startedAt: existingIdx >= 0 ? allSessions[existingIdx].startedAt : new Date().toISOString(),
                messages: msgs,
            }

            if (existingIdx >= 0) {
                allSessions[existingIdx] = session
            } else {
                allSessions.unshift(session)
            }

            allSessions = allSessions.slice(0, MAX_SESSIONS)
            localStorage.setItem(`${STORAGE_PREFIX}${postId}`, JSON.stringify(allSessions))
            setSessions(allSessions)
        } catch (e) {
            console.error("Failed to save copilot session:", e)
        }
    }, [postId, currentSessionId])

    useEffect(() => {
        const handleClickOutside = (e: MouseEvent) => {
            if (sessionPickerRef.current && !sessionPickerRef.current.contains(e.target as Node)) {
                setSessionPickerOpen(false)
            }
        }
        document.addEventListener('mousedown', handleClickOutside)
        return () => document.removeEventListener('mousedown', handleClickOutside)
    }, [])

    const handleNewSession = () => {
        const newId = `s-${Date.now()}`
        setCurrentSessionId(newId)
        setMessages([{ role: "result", content: "I'm ready. Upload screenshots or reference images and I'll create beautiful blog content." }])
        setSessionPickerOpen(false)
    }

    const handleLoadSession = (session: ChatSession) => {
        setCurrentSessionId(session.id)
        setMessages(session.messages)
        setSessionPickerOpen(false)
    }

    const [messages, setMessages] = useState<Message[]>([
        { role: "result", content: "I'm ready. Upload screenshots or reference images and I'll create beautiful blog content." },
    ])

    const [input, setInput] = useState("")
    const [isUploading, setIsUploading] = useState(false)
    const [pendingAttachments, setPendingAttachments] = useState<string[]>([])
    const inflightKey = postId || "_new"
    const [isLoading, setIsLoading] = useState(() => inflightRequests.has(inflightKey))
    const scrollRef = useRef<HTMLDivElement>(null)
    const fileInputRef = useRef<HTMLInputElement>(null)

    const [isRefPickerOpen, setIsRefPickerOpen] = useState(false)
    const [refTemplates, setRefTemplates] = useState<{ id: string; name: string; created_at: string }[]>([])
    const [loadingTemplates, setLoadingTemplates] = useState(false)
    const [capturingRef, setCapturingRef] = useState(false)
    const [referenceCSS, setReferenceCSS] = useState<string | null>(null)
    const [refTemplateName, setRefTemplateName] = useState<string | null>(null)
    const refIframeRef = useRef<HTMLIFrameElement>(null)

    useEffect(() => {
        if (scrollRef.current) {
            scrollRef.current.scrollTop = scrollRef.current.scrollHeight
        }
    }, [messages, isLoading, pendingAttachments])

    useEffect(() => {
        saveCurrentSession(messages)
    }, [messages, saveCurrentSession])

    const uploadFile = async (file: File) => {
        setIsUploading(true)
        try {
            const formData = new FormData()
            formData.append('file', file)

            const response = await fetch('/api/upload', {
                method: 'POST',
                body: formData
            })

            const data = await response.json()

            if (!response.ok) {
                throw new Error(data.error || "Upload failed")
            }

            setPendingAttachments(prev => [...prev, data.url])
        } catch (error: any) {
            console.error("Upload failed:", error)
            setMessages(prev => [...prev, { role: 'result', content: `❌ Failed to upload image: ${file.name} (${error.message})` }])
        } finally {
            setIsUploading(false)
        }
    }

    const handlePaste = (e: React.ClipboardEvent) => {
        const items = e.clipboardData.items
        for (let i = 0; i < items.length; i++) {
            if (items[i].type.indexOf("image") !== -1) {
                e.preventDefault()
                const file = items[i].getAsFile()
                if (file) uploadFile(file)
            }
        }
    }

    const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {
        if (e.target.files && e.target.files.length > 0) {
            Array.from(e.target.files).forEach(file => uploadFile(file))
        }
    }

    const handleOpenRefPicker = async () => {
        setIsRefPickerOpen(true)
        setLoadingTemplates(true)
        try {
            const templates = await getTemplateList()
            setRefTemplates(templates)
        } catch (e) {
            console.error("Failed to load templates", e)
        } finally {
            setLoadingTemplates(false)
        }
    }

    const handleSelectRefTemplate = async (template: { id: string; name: string }) => {
        setIsRefPickerOpen(false)
        setCapturingRef(true)
        setRefTemplateName(template.name)

        try {
            const postData = await getPostHtml(template.id)
            if (!postData?.html_content) {
                throw new Error("No HTML content found")
            }

            const renderedHtml = renderTemplate(postData.html_content, postData.variable_values || {})

            const styleMatch = renderedHtml.match(/<style[^>]*>[\s\S]*?<\/style>/gi)
            const extractedCSS = styleMatch ? styleMatch.join("\n") : ""
            setReferenceCSS(extractedCSS || null)

            const iframe = refIframeRef.current
            if (iframe) {
                const doc = iframe.contentDocument
                if (doc) {
                    doc.open()
                    doc.write(renderedHtml)
                    doc.close()

                    await new Promise(resolve => setTimeout(resolve, 1500))

                    const html2canvas = (await import("html2canvas")).default
                    const canvas = await html2canvas(doc.body, {
                        width: 800,
                        backgroundColor: "#ffffff",
                        useCORS: true,
                        logging: false,
                    })

                    const blob = await new Promise<Blob>((resolve) =>
                        canvas.toBlob((b) => resolve(b!), "image/png", 0.9)
                    )

                    const formData = new FormData()
                    formData.append("file", blob, `ref-${template.id}.png`)
                    const uploadRes = await fetch("/api/upload", { method: "POST", body: formData })
                    const uploadData = await uploadRes.json()

                    if (uploadRes.ok && uploadData.url) {
                        setPendingAttachments(prev => [...prev, uploadData.url])
                    }
                }
            }
        } catch (e: any) {
            console.error("Failed to capture reference template:", e)
            setRefTemplateName(null)
            setReferenceCSS(null)
        } finally {
            setCapturingRef(false)
        }
    }

    const clearReference = () => {
        setReferenceCSS(null)
        setRefTemplateName(null)
    }

    const handleSendMessage = async (tier?: ComputeTier) => {
        if ((!input.trim() && pendingAttachments.length === 0) || isLoading || isUploading) return

        const userMessage = input.trim()
        const attachments = [...pendingAttachments]

        let fullMessage = userMessage
        if (referenceCSS) {
            fullMessage = `[Reference template style attached. Match this CSS for fonts, colors, and spacing:]\n${referenceCSS}\n\n${userMessage}`
            setReferenceCSS(null)
            setRefTemplateName(null)
        }

        let model: string
        if (autoRouting && !tier) {
            model = "auto"
        } else {
            model = getModelForTier(tier || "medium")
        }

        setInput("")
        setPendingAttachments([])

        const newMessage: Message = {
            role: "user",
            content: userMessage,
            imageUrls: attachments
        }

        const apiMessage: Message = {
            role: "user",
            content: fullMessage,
            imageUrls: attachments
        }

        const newHistory = [...messages, newMessage]
        const apiHistory = [...messages, apiMessage]
        setMessages(newHistory)
        setIsLoading(true)

        // Track this request in module-level map so isLoading survives remounts
        const abortController = new AbortController()
        inflightRequests.set(inflightKey, abortController)

        try {
            const response = await fetch("/api/copilot", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    currentHtml: html,
                    messages: apiHistory,
                    model,
                    audienceContext,
                    aiDossier,
                    modelLow,
                    modelMedium,
                    imageMode,
                    themeHtml: selectedThemeId !== "none" ? themes.find(t => t.id === selectedThemeId)?.html_template : null,
                }),
                signal: abortController.signal,
            })

            const data = await response.json()

            if (!response.ok) throw new Error(data.error || "Failed to generate code")

            if (data.updatedHtml) {
                onHtmlChange(data.updatedHtml, userMessage)
            } else if (data.explanation && /<!DOCTYPE html|<html[\s>]/i.test(data.explanation)) {
                // Fallback: AI accidentally put the HTML in the explanation field
                const htmlMatch = data.explanation.match(/(<!DOCTYPE html[\s\S]*?<\/html>)/i)
                if (htmlMatch) {
                    console.warn("[Copilot] Recovered HTML from explanation field (AI put it in wrong field)")
                    onHtmlChange(htmlMatch[1], userMessage)
                    data.explanation = "Blog post generated successfully."
                }
            }

            const resultMessages: Message[] = [
                { role: "result", content: data.explanation || "Done." }
            ];

            if (data.meta) {
                const m = data.meta;
                const costStr = m.cost < 0.01 ? `$${(m.cost * 100).toFixed(2)}¢` : `$${m.cost.toFixed(4)}`;
                resultMessages.push({
                    role: "details",
                    content: `${m.model}  ·  ${m.inputTokens.toLocaleString()} in / ${m.outputTokens.toLocaleString()} out  ·  ${costStr}`
                });
            }

            setMessages(prev => [...prev, ...resultMessages])

        } catch (error: any) {
            if (error.name === 'AbortError') return // Component unmounted, don't update state
            console.error("Copilot Error:", error)
            setMessages(prev => [
                ...prev,
                { role: "result", content: `Error: ${error.message}` }
            ])
        } finally {
            inflightRequests.delete(inflightKey)
            setIsLoading(false)
        }
    }

    const canSend = !isLoading && (input.trim() || pendingAttachments.length > 0)

    return (
        <div className="flex flex-col h-full border-l border-border bg-card text-card-foreground">
            <iframe
                ref={refIframeRef}
                style={{ position: "absolute", left: "-9999px", top: "-9999px", width: "800px", height: "2000px", border: "none" }}
            />
            {/* Header */}
            <div className="h-14 border-b border-border flex items-center px-4 gap-2 justify-between shrink-0 bg-background/50 backdrop-blur">
                <div className="flex items-center gap-2">
                    <Sparkles className="w-4 h-4 text-purple-400" />
                    <h2 className="text-sm font-semibold">Copilot Vision</h2>
                    {postId && (
                        <div className="relative" ref={sessionPickerRef}>
                            <button
                                onClick={() => setSessionPickerOpen(!sessionPickerOpen)}
                                className="flex items-center gap-1 px-1.5 py-0.5 rounded text-[10px] text-muted-foreground hover:text-foreground hover:bg-muted transition-colors"
                                title="Chat Sessions"
                            >
                                <History className="w-3 h-3" />
                                {sessions.length > 0 && <span>{sessions.length}</span>}
                            </button>
                            {sessionPickerOpen && (
                                <div className="absolute top-full left-0 mt-1 w-56 bg-card border border-border rounded-lg shadow-xl z-50 overflow-hidden">
                                    <div className="px-3 py-2 border-b border-border flex items-center justify-between">
                                        <p className="text-[10px] font-semibold text-muted-foreground uppercase">Chat Sessions</p>
                                        <button
                                            onClick={handleNewSession}
                                            className="flex items-center gap-1 text-[10px] text-primary hover:text-primary/80 transition-colors"
                                        >
                                            <Plus className="w-3 h-3" />
                                            New
                                        </button>
                                    </div>
                                    <div className="max-h-48 overflow-y-auto">
                                        {sessions.map((session) => (
                                            <button
                                                key={session.id}
                                                onClick={() => handleLoadSession(session)}
                                                className={cn(
                                                    "w-full text-left px-3 py-2 hover:bg-muted/50 transition-colors border-b border-border/50 last:border-0",
                                                    session.id === currentSessionId && "bg-primary/5 border-l-2 border-l-primary"
                                                )}
                                            >
                                                <div className="flex flex-col">
                                                    <span className="text-[10px] text-muted-foreground">
                                                        {new Date(session.startedAt).toLocaleDateString("en-US", { month: "short", day: "numeric" })}{" "}
                                                        {new Date(session.startedAt).toLocaleTimeString("en-US", { hour: "numeric", minute: "2-digit" })}
                                                    </span>
                                                    <span className="text-xs text-foreground truncate">
                                                        {session.messages.filter(m => m.role === "user").slice(-1)[0]?.content?.slice(0, 40) || "Empty session"}
                                                        {(session.messages.filter(m => m.role === "user").slice(-1)[0]?.content?.length || 0) > 40 ? "…" : ""}
                                                    </span>
                                                    <span className="text-[10px] text-muted-foreground">
                                                        {session.messages.filter(m => m.role === "user").length} messages
                                                    </span>
                                                </div>
                                            </button>
                                        ))}
                                        {sessions.length === 0 && (
                                            <p className="text-xs text-muted-foreground text-center py-4">No saved sessions</p>
                                        )}
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                </div>
                <Select
                    value={overrideModel || "tier-default"}
                    onValueChange={(val) => setOverrideModel(val === "tier-default" ? null : val)}
                >
                    <SelectTrigger className="w-[180px] h-8 text-xs bg-muted/50 border-transparent hover:border-border">
                        <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                        <SelectItem value="tier-default">🎛️ Use Tier Buttons</SelectItem>
                        {availableModels.map(model => (
                            <SelectItem key={model} value={model}>{model}</SelectItem>
                        ))}
                        {availableModels.length === 0 && (
                            <SelectItem value="claude-3-5-sonnet-20240620">Claude 3.5 Sonnet (Legacy)</SelectItem>
                        )}
                        <SelectItem value="gemini-1.5-pro">Gemini 1.5 Pro</SelectItem>
                    </SelectContent>
                </Select>
            </div>

            {/* Messages */}
            <div className="flex-1 overflow-y-auto p-4 space-y-6" ref={scrollRef}>
                {messages.map((msg, index) => (
                    <div key={index} className={cn("flex flex-col gap-2 max-w-[90%]", msg.role === "user" ? "ml-auto items-end" : "mr-auto items-start")}>
                        {msg.imageUrls && msg.imageUrls.length > 0 && (
                            <div className="flex flex-wrap gap-2 mb-1 justify-end">
                                {msg.imageUrls.map((url, i) => (
                                    <div key={i} className="relative group overflow-hidden rounded-lg border border-border">
                                        <img src={url} alt="attachment" className="h-24 w-auto object-cover" />
                                    </div>
                                ))}
                            </div>
                        )}
                        {msg.content && (
                            <div className={cn(
                                "rounded-2xl text-sm whitespace-pre-wrap leading-relaxed",
                                msg.role === "user"
                                    ? "p-3 bg-primary text-primary-foreground rounded-br-sm"
                                    : msg.role === "details"
                                        ? "px-3 py-1.5 text-[11px] font-mono text-muted-foreground bg-transparent"
                                        : "p-3 bg-muted text-foreground rounded-bl-sm"
                            )}>
                                {msg.content}
                            </div>
                        )}
                    </div>
                ))}
                {isLoading && (
                    <div className="mr-auto flex items-center gap-2 text-muted-foreground text-sm p-2">
                        <Brain className="w-4 h-4 animate-pulse" />
                        Thinking...
                    </div>
                )}
            </div>

            {/* Input Area */}
            <div className="p-4 border-t border-border mt-auto shrink-0 bg-background/50 backdrop-blur">
                {(pendingAttachments.length > 0 || isUploading || refTemplateName || capturingRef) && (
                    <div className="space-y-2 pb-3">
                        {(refTemplateName || capturingRef) && (
                            <div className="flex items-center gap-2">
                                {capturingRef ? (
                                    <Badge variant="outline" className="bg-purple-500/10 text-purple-400 border-purple-500/30 gap-1">
                                        <Loader2 className="w-3 h-3 animate-spin" />
                                        Capturing reference...
                                    </Badge>
                                ) : refTemplateName && (
                                    <Badge variant="outline" className="bg-purple-500/10 text-purple-400 border-purple-500/30 gap-1 pr-1">
                                        <LayoutTemplate className="w-3 h-3" />
                                        Ref: {refTemplateName}
                                        <button onClick={clearReference} className="ml-1 rounded-full p-0.5 hover:bg-purple-500/20">
                                            <X className="w-3 h-3" />
                                        </button>
                                    </Badge>
                                )}
                            </div>
                        )}
                        {(pendingAttachments.length > 0 || isUploading) && (
                            <div className="flex gap-2 overflow-x-auto">
                                {pendingAttachments.map((url, i) => (
                                    <div key={i} className="relative group shrink-0">
                                        {url.toLowerCase().endsWith('.pdf') ? (
                                            <div className="h-14 w-14 rounded-md border border-border bg-muted flex items-center justify-center">
                                                <FileText className="w-6 h-6 text-muted-foreground" />
                                            </div>
                                        ) : (
                                            <img src={url} className="h-14 w-14 rounded-md object-cover border border-border" />
                                        )}
                                        <button
                                            onClick={() => setPendingAttachments(prev => prev.filter((_, idx) => idx !== i))}
                                            className="absolute -top-1 -right-1 bg-destructive text-destructive-foreground rounded-full p-0.5 opacity-0 group-hover:opacity-100 transition-opacity"
                                        >
                                            <X className="w-3 h-3" />
                                        </button>
                                    </div>
                                ))}
                                {isUploading && (
                                    <div className="h-14 w-14 rounded-md border border-dashed border-muted-foreground/50 flex items-center justify-center bg-muted/20">
                                        <Loader2 className="w-5 h-5 animate-spin text-muted-foreground" />
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                )}

                <div className="space-y-2">
                    {/* Image Mode Toggle */}
                    <div className="flex items-center gap-1 bg-muted/50 p-1 rounded-lg w-fit border border-border">
                        <button
                            type="button"
                            onClick={() => setImageMode('library')}
                            className={cn("text-[10px] font-medium px-3 py-1.5 rounded-md transition-all flex items-center gap-1.5", imageMode === 'library' ? "bg-background shadow-sm text-foreground" : "text-muted-foreground hover:text-foreground")}
                            title="Attempt to use images from your Asset Library first"
                        >
                            📚 Use Library
                        </button>
                        <button
                            type="button"
                            onClick={() => setImageMode('creative')}
                            className={cn("text-[10px] font-medium px-3 py-1.5 rounded-md transition-all flex items-center gap-1.5", imageMode === 'creative' ? "bg-background shadow-sm text-foreground" : "text-muted-foreground hover:text-foreground")}
                            title="Generate AI images on the fly"
                        >
                            ✨ Be Creative
                        </button>
                    </div>

                    {/* Theme Dropdown */}
                    <Select value={selectedThemeId} onValueChange={setSelectedThemeId}>
                        <SelectTrigger className="h-8 text-[10px] w-[160px] bg-muted/50 border-border">
                            <Palette className="w-3 h-3 mr-1.5 text-muted-foreground shrink-0" />
                            <SelectValue placeholder="Select Theme" />
                        </SelectTrigger>
                        <SelectContent>
                            <SelectItem value="none">No Theme (Default)</SelectItem>
                            {themes.map(t => (
                                <SelectItem key={t.id} value={t.id}>{t.name}</SelectItem>
                            ))}
                        </SelectContent>
                    </Select>

                    <input
                        type="file"
                        multiple
                        accept="image/*,.pdf,application/pdf"
                        className="hidden"
                        ref={fileInputRef}
                        onChange={handleFileSelect}
                    />

                    <Input
                        value={input}
                        onChange={(e) => setInput(e.target.value)}
                        onKeyDown={(e) => {
                            if (e.key === "Enter" && !e.shiftKey) {
                                e.preventDefault()
                                if (autoRouting && !overrideModel) {
                                    handleSendMessage()
                                } else {
                                    handleSendMessage("low")
                                }
                            }
                        }}
                        onPaste={handlePaste}
                        placeholder="Type a message..."
                        className="w-full min-h-[40px]"
                        disabled={isLoading}
                        autoFocus
                    />

                    <div className="flex items-center justify-between">
                        <div className="flex items-center gap-1">
                            <Button
                                variant="ghost"
                                size="icon"
                                className="shrink-0 text-muted-foreground hover:text-foreground h-8 w-8"
                                onClick={() => fileInputRef.current?.click()}
                                disabled={isUploading || isLoading}
                                title="Attach image"
                            >
                                <Paperclip className="w-4 h-4" />
                            </Button>
                            <Button
                                variant="ghost"
                                size="icon"
                                className={cn(
                                    "shrink-0 hover:text-foreground h-8 w-8",
                                    refTemplateName ? "text-purple-400" : "text-muted-foreground"
                                )}
                                onClick={handleOpenRefPicker}
                                disabled={isUploading || isLoading || capturingRef}
                                title="Reference a post style"
                            >
                                <LayoutTemplate className="w-4 h-4" />
                            </Button>
                        </div>

                        {autoRouting && !overrideModel ? (
                            <Button
                                size="icon"
                                onClick={() => handleSendMessage()}
                                disabled={!canSend}
                                className={cn("bg-amber-600 hover:bg-amber-500 text-white h-8 w-8", isLoading && "opacity-50")}
                                title="Auto-routed send"
                            >
                                <Send className="w-3.5 h-3.5" />
                            </Button>
                        ) : (
                            <div className="flex gap-1">
                                <Button
                                    size="icon"
                                    onClick={() => handleSendMessage("low")}
                                    disabled={!canSend}
                                    className="bg-green-600 hover:bg-green-500 text-white h-8 w-8"
                                    title={`Low: ${overrideModel || modelLow} (Enter)`}
                                >
                                    <Send className="w-3.5 h-3.5" />
                                </Button>
                                <Button
                                    size="icon"
                                    onClick={() => handleSendMessage("medium")}
                                    disabled={!canSend}
                                    className="bg-amber-600 hover:bg-amber-500 text-white h-8 w-8"
                                    title={`Medium: ${overrideModel || modelMedium}`}
                                >
                                    <Send className="w-3.5 h-3.5" />
                                </Button>
                                <Button
                                    size="icon"
                                    onClick={() => handleSendMessage("high")}
                                    disabled={!canSend}
                                    className="bg-red-600 hover:bg-red-500 text-white h-8 w-8"
                                    title={`High: ${overrideModel || modelHigh}`}
                                >
                                    <Send className="w-3.5 h-3.5" />
                                </Button>
                            </div>
                        )}
                    </div>
                </div>
            </div>

            {/* Reference Template Picker Dialog */}
            <Dialog open={isRefPickerOpen} onOpenChange={setIsRefPickerOpen}>
                <DialogContent className="sm:max-w-md">
                    <DialogHeader>
                        <DialogTitle>Reference Post</DialogTitle>
                        <DialogDescription>Select a post to use as a style reference. A screenshot and CSS will be attached to your next prompt.</DialogDescription>
                    </DialogHeader>
                    <div className="py-2">
                        {loadingTemplates ? (
                            <div className="flex justify-center py-8">
                                <Loader2 className="h-8 w-8 animate-spin text-muted-foreground" />
                            </div>
                        ) : refTemplates.length === 0 ? (
                            <p className="text-center text-muted-foreground py-8">No posts found.</p>
                        ) : (
                            <ScrollArea className="h-[300px] pr-4">
                                <div className="space-y-2">
                                    {refTemplates.map(t => (
                                        <button
                                            key={t.id}
                                            onClick={() => handleSelectRefTemplate(t)}
                                            className="w-full text-left p-3 rounded-lg border border-border hover:bg-accent transition-colors"
                                        >
                                            <h4 className="font-medium text-sm text-foreground">{t.name}</h4>
                                            <p className="text-[10px] text-muted-foreground mt-1">
                                                Created: {new Date(t.created_at).toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" })}
                                            </p>
                                        </button>
                                    ))}
                                </div>
                            </ScrollArea>
                        )}
                    </div>
                </DialogContent>
            </Dialog>
        </div>
    )
}
</file>

<file path="package.json">
{
  "name": "dreamplay-blog",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev --port 3003",
    "build": "next build",
    "start": "next start",
    "lint": "eslint"
  },
  "dependencies": {
    "@anthropic-ai/sdk": "^0.78.0",
    "@google/genai": "^1.43.0",
    "@google/generative-ai": "^0.24.1",
    "@radix-ui/react-accordion": "^1.2.12",
    "@radix-ui/react-alert-dialog": "^1.1.15",
    "@radix-ui/react-aspect-ratio": "^1.1.8",
    "@radix-ui/react-avatar": "^1.1.11",
    "@radix-ui/react-checkbox": "^1.3.3",
    "@radix-ui/react-collapsible": "^1.1.12",
    "@radix-ui/react-context-menu": "^2.2.16",
    "@radix-ui/react-dialog": "^1.1.15",
    "@radix-ui/react-dropdown-menu": "^2.1.16",
    "@radix-ui/react-hover-card": "^1.1.15",
    "@radix-ui/react-label": "^2.1.8",
    "@radix-ui/react-menubar": "^1.1.16",
    "@radix-ui/react-navigation-menu": "^1.2.14",
    "@radix-ui/react-popover": "^1.1.15",
    "@radix-ui/react-progress": "^1.1.8",
    "@radix-ui/react-radio-group": "^1.3.8",
    "@radix-ui/react-scroll-area": "^1.2.10",
    "@radix-ui/react-select": "^2.2.6",
    "@radix-ui/react-separator": "^1.1.8",
    "@radix-ui/react-slider": "^1.3.6",
    "@radix-ui/react-slot": "^1.2.4",
    "@radix-ui/react-switch": "^1.2.6",
    "@radix-ui/react-tabs": "^1.1.13",
    "@radix-ui/react-toast": "^1.2.15",
    "@radix-ui/react-toggle": "^1.1.10",
    "@radix-ui/react-toggle-group": "^1.1.11",
    "@radix-ui/react-tooltip": "^1.2.8",
    "@supabase/ssr": "^0.8.0",
    "@supabase/supabase-js": "^2.98.0",
    "@tailwindcss/typography": "^0.5.19",
    "@vercel/analytics": "^1.6.1",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "cmdk": "^1.1.1",
    "date-fns": "^4.1.0",
    "embla-carousel-react": "^8.6.0",
    "html2canvas": "^1.4.1",
    "input-otp": "^1.4.2",
    "lucide-react": "^0.575.0",
    "next": "16.1.6",
    "next-themes": "^0.4.6",
    "react": "19.2.3",
    "react-day-picker": "^9.14.0",
    "react-dom": "19.2.3",
    "react-hook-form": "^7.71.2",
    "react-image-crop": "^11.0.10",
    "react-resizable-panels": "^2.1.7",
    "recharts": "^3.7.0",
    "sharp": "^0.34.5",
    "sonner": "^2.0.7",
    "tailwind-merge": "^3.5.0",
    "tw-animate-css": "^1.4.0",
    "vaul": "^1.1.2"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "eslint": "^9",
    "eslint-config-next": "16.1.6",
    "tailwindcss": "^4",
    "typescript": "^5"
  }
}
</file>

<file path="app/(site)/blog/[slug]/page.tsx">
import Link from "next/link";
import { notFound } from "next/navigation";
import { ArrowLeft, Music } from "lucide-react";
import { createClient } from "@/lib/supabase/server";
import { renderTemplate } from "@/lib/render-template";
import { BlogContentFrame } from "@/components/blog/blog-content-frame";
import { BlogHeader } from "@/components/blog/blog-header";

export const dynamic = "force-dynamic";

interface PageProps {
    params: Promise<{
        slug: string;
    }>;
}

export default async function BlogPostPage({ params }: PageProps) {
    const { slug } = await params;

    const supabase = await createClient();

    const { data: post, error } = await supabase
        .from("posts")
        .select("*")
        .eq("slug", slug)
        .eq("status", "published")
        .single();

    if (error || !post) {
        notFound();
    }

    const renderedContent = renderTemplate(
        post.html_content || "",
        post.variable_values || {}
    );

    return (
        <div className="min-h-screen bg-[#0a0a0f] flex flex-col font-sans text-white selection:bg-white/20">
            <BlogHeader forceOpaque={true} darkMode={true} />

            {/* Back to Blog link */}
            <div className="mx-auto w-full max-w-5xl px-6 pt-[120px] md:pt-[140px]">
                <Link
                    href="/blog"
                    className="inline-flex items-center gap-2 font-sans text-[10px] font-bold uppercase tracking-[0.3em] text-white/40 transition-colors hover:text-white"
                >
                    <ArrowLeft className="h-3 w-3" />
                    Back to Journal
                </Link>
            </div>

            {/* Blog Content (sandboxed in iframe to prevent style leakage) */}
            <main className="flex-1 w-full max-w-5xl mx-auto px-6 py-12">
                <div className="rounded-none border border-white/10 bg-white p-2 md:p-12 shadow-2xl">
                    <BlogContentFrame html={renderedContent} />
                </div>
            </main>

            {/* Footer */}
            <footer className="border-t border-white/10 bg-[#050505] px-6 py-12 mt-12">
                <div className="mx-auto flex max-w-5xl flex-col items-center justify-between gap-6 sm:flex-row">
                    <div className="flex items-center gap-2">
                        <Music className="h-5 w-5 text-white/50" />
                        <span className="font-serif text-lg tracking-wide text-white">DreamPlay Pianos</span>
                    </div>
                    <div className="flex gap-6">
                        <a href="https://www.dreamplaypianos.com/privacy" className="font-sans text-[10px] uppercase tracking-[0.2em] text-white/40 hover:text-white transition-colors">Privacy</a>
                        <a href="https://www.dreamplaypianos.com/terms" className="font-sans text-[10px] uppercase tracking-[0.2em] text-white/40 hover:text-white transition-colors">Terms</a>
                    </div>
                    <p className="font-sans text-[10px] uppercase tracking-[0.2em] text-white/40">
                        © 2026 DreamPlay Pianos.
                    </p>
                </div>
            </footer>
        </div>
    );
}
</file>

<file path="components/app-sidebar.tsx">
"use client"

import Link from "next/link"
import { usePathname } from "next/navigation"
import {
    Home, FileText, PenTool, MousePointerSquareDashed,
    ImageIcon, Settings, ExternalLink, Sparkles, BookOpen, LayoutTemplate
} from "lucide-react"
import { cn } from "@/lib/utils"

const navSections = [
    {
        label: "Overview",
        items: [
            { name: "Dashboard", href: "/admin", icon: Home },
        ],
    },
    {
        label: "Content",
        items: [
            { name: "Blog Posts", href: "/admin/posts", icon: FileText },
            { name: "Knowledgebase", href: "/admin/knowledgebase", icon: BookOpen },
            { name: "Assets Library", href: "/admin/assets", icon: ImageIcon },
            { name: "Theme Analyzer", href: "/admin/theme-analyzer", icon: LayoutTemplate },
        ],
    },
    {
        label: "AI Copilot Editors",
        items: [
            { name: "Classic Editor", href: "/editor", icon: PenTool },
            { name: "Drag & Drop Editor", href: "/dnd-editor", icon: MousePointerSquareDashed },
        ],
    },
]

export function AppSidebar() {
    const pathname = usePathname()

    const isActive = (href: string) => {
        if (href === "/admin") return pathname === "/admin"
        return pathname === href || pathname.startsWith(href + "/")
    }

    return (
        <aside className="fixed left-0 top-0 z-40 h-screen w-64 border-r border-border bg-card">
            <div className="flex h-full flex-col">
                {/* Brand */}
                <div className="flex h-16 items-center gap-3 border-b border-border px-6">
                    <div className="flex h-9 w-9 items-center justify-center rounded-lg bg-primary">
                        <BookOpen className="h-5 w-5 text-primary-foreground" />
                    </div>
                    <span className="text-lg font-semibold text-foreground">DreamPlay Blog</span>
                </div>

                {/* Navigation */}
                <nav className="flex-1 overflow-y-auto px-3 py-4 space-y-6">
                    {navSections.map((section) => (
                        <div key={section.label}>
                            <p className="px-3 mb-2 text-[10px] font-semibold uppercase tracking-wider text-muted-foreground">
                                {section.label}
                            </p>
                            <div className="space-y-1">
                                {section.items.map((item) => (
                                    <Link
                                        key={item.name}
                                        href={item.href}
                                        className={cn(
                                            "flex items-center gap-3 rounded-lg px-3 py-2.5 text-sm font-medium transition-colors",
                                            isActive(item.href)
                                                ? "bg-primary/10 text-primary"
                                                : "text-muted-foreground hover:bg-muted hover:text-foreground",
                                        )}
                                    >
                                        <item.icon className="h-4 w-4" />
                                        {item.name}
                                        {section.label === "AI Copilot Editors" && (
                                            <Sparkles className="ml-auto h-3 w-3 text-primary/50" />
                                        )}
                                    </Link>
                                ))}
                            </div>
                        </div>
                    ))}

                    {/* Below separator */}
                    <div className="pt-2 border-t border-border space-y-1">
                        <Link
                            href="/admin/settings"
                            className={cn(
                                "flex items-center gap-3 rounded-lg px-3 py-2.5 text-sm font-medium transition-colors",
                                isActive("/admin/settings")
                                    ? "bg-primary/10 text-primary"
                                    : "text-muted-foreground hover:bg-muted hover:text-foreground",
                            )}
                        >
                            <Settings className="h-4 w-4" />
                            Settings
                        </Link>
                        <Link
                            href="/blog"
                            target="_blank"
                            className="flex items-center gap-3 rounded-lg px-3 py-2.5 text-sm font-medium text-muted-foreground hover:bg-muted hover:text-foreground transition-colors"
                        >
                            <ExternalLink className="h-4 w-4" />
                            View Blog
                        </Link>
                    </div>
                </nav>

                {/* Footer */}
                <div className="border-t border-border p-4">
                    <p className="text-xs text-muted-foreground">DreamPlay Blog v1.0</p>
                </div>
            </div>
        </aside>
    )
}
</file>

</files>
